#!/usr/bin/env python3.13
"""
dskpend - View latest DeepSeek reply
"""
from __future__ import annotations

import argparse
import json
import os
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding

setup_windows_encoding()

from cli_output import EXIT_ERROR, EXIT_NO_REPLY, EXIT_OK
from askd_client import resolve_work_dir_with_registry
from askd_runtime import log_path
from providers import DSKASK_CLIENT_SPEC, DSKASKD_SPEC
from i18n import t


def _debug_enabled() -> bool:
    return (os.environ.get("CCB_DEBUG") in ("1", "true", "yes")) or (os.environ.get("DSKPEND_DEBUG") in ("1", "true", "yes"))


def _debug(message: str) -> None:
    if not _debug_enabled():
        return
    print(f"[DEBUG] {message}", file=sys.stderr)


def _iter_reply_entries(log_file: Path):
    try:
        raw = log_file.read_text(encoding="utf-8", errors="replace")
    except Exception as exc:
        _debug(f"Failed to read log {log_file}: {exc}")
        return
    for line in raw.splitlines():
        line = line.strip()
        if not line or not line.startswith("{"):
            continue
        try:
            data = json.loads(line)
        except Exception:
            continue
        if not isinstance(data, dict):
            continue
        if data.get("type") != "reply":
            continue
        if data.get("provider") != "deepseek":
            continue
        yield data


def main(argv: list[str]) -> int:
    try:
        parser = argparse.ArgumentParser(prog="dskpend", add_help=True)
        parser.add_argument("n", nargs="?", type=int, default=1, help="Show the latest N replies")
        parser.add_argument("--session-file", dest="session_file", default=None, help="Path to .deepseek-session (or .ccb_config/.deepseek-session)")
        args = parser.parse_args(argv[1:])

        n = max(1, int(args.n or 1))

        work_dir, _ = resolve_work_dir_with_registry(
            DSKASK_CLIENT_SPEC,
            provider="deepseek",
            cli_session_file=args.session_file,
            env_session_file=os.environ.get("CCB_SESSION_FILE"),
        )

        log_file = log_path(DSKASKD_SPEC.log_file_name)
        if not log_file.exists():
            print(t("no_reply_available", provider="DeepSeek"), file=sys.stderr)
            return EXIT_NO_REPLY

        entries = []
        for entry in _iter_reply_entries(log_file):
            wd = entry.get("work_dir")
            if wd and str(Path(wd)) != str(work_dir):
                continue
            entries.append(entry)

        if not entries:
            print(t("no_reply_available", provider="DeepSeek"), file=sys.stderr)
            return EXIT_NO_REPLY

        latest = entries[-n:]
        if n > 1:
            for i, entry in enumerate(latest):
                question = entry.get("message") or ""
                reply = entry.get("reply") or ""
                if question:
                    print(f"Q: {question}")
                print(f"A: {reply}")
                if i < len(latest) - 1:
                    print("---")
            return EXIT_OK

        reply = latest[-1].get("reply") or ""
        if not reply:
            print(t("no_reply_available", provider="DeepSeek"), file=sys.stderr)
            return EXIT_NO_REPLY
        print(reply)
        return EXIT_OK
    except Exception as exc:
        if _debug_enabled():
            import traceback
            traceback.print_exc()
        print(f"[ERROR] {t('execution_failed', error=exc)}", file=sys.stderr)
        return EXIT_ERROR


if __name__ == "__main__":
    sys.exit(main(sys.argv))
