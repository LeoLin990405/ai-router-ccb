#!/usr/bin/env python3
"""
dskping - Test connectivity with DeepSeek CLI.
"""
from __future__ import annotations

import os
import sys
import subprocess
import shutil
from pathlib import Path
from typing import Optional


def _find_deepseek_cli() -> Optional[str]:
    candidates = [
        shutil.which("deepseek"),
        str(Path.home() / ".npm-global/bin/deepseek"),
        "/usr/local/bin/deepseek",
    ]
    for c in candidates:
        if c and Path(c).exists():
            return c
    return None


def main() -> int:
    deepseek_path = _find_deepseek_cli()

    if not deepseek_path:
        print("[ERROR] DeepSeek CLI not found. Install with: npm i -g deepseek-coder-agent-cli")
        return 1

    if not os.environ.get("DEEPSEEK_API_KEY"):
        print("[ERROR] DEEPSEEK_API_KEY not set. Get one at https://platform.deepseek.com/")
        return 1

    # Quick version check
    try:
        result = subprocess.run(
            [deepseek_path, "--version"],
            capture_output=True,
            text=True,
            timeout=5,
        )
        version = result.stdout.strip() or "unknown"
        print(f"âœ… DeepSeek CLI connection OK ({version})")
        return 0
    except Exception as e:
        print(f"[ERROR] DeepSeek CLI check failed: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
