#!/usr/bin/env python3
"""
grkask - Send message to Grok CLI and get reply (headless mode).

Uses Grok CLI's -p/--prompt flag for non-interactive execution.
No WezTerm pane required.
"""

from __future__ import annotations

import os
import sys
import subprocess
import shutil
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

try:
    from compat import read_stdin_text, setup_windows_encoding
    setup_windows_encoding()
except ImportError:
    def read_stdin_text():
        return sys.stdin.read()

ASYNC_GUARDRAIL = """[CCB_ASYNC_SUBMITTED provider=grok]
IMPORTANT: Task submitted to Grok. You MUST:
1. Tell user "Grok processing..."
2. END YOUR TURN IMMEDIATELY
3. Do NOT wait, poll, check status, or use any more tools
"""


from typing import Optional


def _find_grok_cli() -> Optional[str]:
    """Find grok CLI executable."""
    # Check common locations
    candidates = [
        shutil.which("grok"),
        str(Path.home() / ".npm-global/bin/grok"),
        "/usr/local/bin/grok",
    ]
    for c in candidates:
        if c and Path(c).exists():
            return c
    return None


def _usage() -> None:
    print("Usage: grkask [--timeout SECONDS] <message>", file=sys.stderr)
    print("  Or pipe: echo 'message' | grkask", file=sys.stderr)


def main(argv: list[str]) -> int:
    if len(argv) <= 1 and sys.stdin.isatty():
        _usage()
        return 1

    timeout: float = 300.0  # 5 minutes default
    sync_mode = False
    parts: list[str] = []

    it = iter(argv[1:])
    for token in it:
        if token in ("-h", "--help"):
            _usage()
            return 0
        if token == "--sync":
            sync_mode = True
            continue
        if token in ("-t", "--timeout"):
            try:
                timeout = float(next(it))
            except (StopIteration, ValueError):
                print("[ERROR] --timeout requires a number", file=sys.stderr)
                return 1
            continue
        parts.append(token)

    message = " ".join(parts).strip()
    if not message and not sys.stdin.isatty():
        message = read_stdin_text().strip()
    if not message:
        print("[ERROR] Message cannot be empty", file=sys.stderr)
        return 1

    # Find grok CLI
    grok_path = _find_grok_cli()
    if not grok_path:
        print("[ERROR] Grok CLI not found. Install with: npm i -g @vibe-kit/grok-cli", file=sys.stderr)
        return 1

    # Check API key
    if not os.environ.get("GROK_API_KEY"):
        print("[ERROR] GROK_API_KEY not set. Get one at https://console.x.ai/", file=sys.stderr)
        return 1

    # Run grok in headless mode
    try:
        result = subprocess.run(
            [grok_path, "-p", message],
            capture_output=True,
            text=True,
            timeout=timeout,
            cwd=os.getcwd(),
        )

        if not sync_mode:
            print(ASYNC_GUARDRAIL, file=sys.stderr, flush=True)

        if result.stdout:
            print(result.stdout)
        if result.stderr and result.returncode != 0:
            print(result.stderr, file=sys.stderr)

        return result.returncode
    except subprocess.TimeoutExpired:
        print(f"[ERROR] Grok CLI timed out after {timeout}s", file=sys.stderr)
        return 1
    except Exception as e:
        print(f"[ERROR] {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main(sys.argv))
