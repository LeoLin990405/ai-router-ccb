#!/usr/bin/env python3
"""
kimiping - Test connectivity with Kimi API.
"""
from __future__ import annotations

import os
import sys
import json
import urllib.request
import urllib.error


API_URL = "https://api.moonshot.cn/v1/models"


def main() -> int:
    api_key = os.environ.get("MOONSHOT_API_KEY") or os.environ.get("KIMI_API_KEY")
    if not api_key:
        print("[ERROR] MOONSHOT_API_KEY not set. Get one at https://platform.moonshot.cn/")
        return 1

    try:
        headers = {"Authorization": f"Bearer {api_key}"}
        req = urllib.request.Request(API_URL, headers=headers, method="GET")
        with urllib.request.urlopen(req, timeout=10) as resp:
            data = json.loads(resp.read().decode("utf-8"))
            models = [m.get("id", "") for m in data.get("data", [])]
            print(f"âœ… Kimi API connection OK (models: {', '.join(models[:3])}...)")
            return 0
    except urllib.error.HTTPError as e:
        print(f"[ERROR] Kimi API error {e.code}")
        return 1
    except Exception as e:
        print(f"[ERROR] Kimi API check failed: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
