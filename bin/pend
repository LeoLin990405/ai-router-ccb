#!/usr/bin/env python3
"""
pend - Fetch latest reply for a provider from Gateway.

Usage:
    pend <provider> [N]     - Get last N replies (default: 1)
    pend all [N]            - Get last N replies from all providers
"""
import json
import sys
import urllib.request
import os

PROVIDERS = ["gemini", "codex", "opencode", "kimi", "qwen", "iflow", "droid", "llama"]

def get_gateway_url():
    return os.environ.get("CCB_GATEWAY_URL", "http://localhost:8765")

def main():
    if len(sys.argv) < 2:
        print("Usage: pend <provider> [N]", file=sys.stderr)
        print(f"Providers: {', '.join(PROVIDERS)}, all", file=sys.stderr)
        return 1
    
    provider = sys.argv[1].lower()
    count = int(sys.argv[2]) if len(sys.argv) > 2 and sys.argv[2].isdigit() else 1
    
    gateway_url = get_gateway_url()
    
    try:
        url = f"{gateway_url}/api/requests?limit=50"
        with urllib.request.urlopen(url, timeout=10) as response:
            requests = json.loads(response.read().decode())
        
        # Filter by provider if not "all"
        if provider != "all":
            requests = [r for r in requests if r.get("provider") == provider]
        
        # Filter completed only
        requests = [r for r in requests if r.get("status") == "completed"][:count]
        
        if not requests:
            print(f"No completed requests found for {provider}", file=sys.stderr)
            return 1
        
        for req in requests:
            req_id = req.get("id")
            req_provider = req.get("provider")
            reply_url = f"{gateway_url}/api/reply/{req_id}?wait=false"
            with urllib.request.urlopen(reply_url, timeout=10) as resp:
                reply = json.loads(resp.read().decode())
            
            print(f"=== [{req_provider}] Request {req_id} ===")
            if reply.get("response"):
                print(reply["response"])
            elif reply.get("error"):
                print(f"Error: {reply['error']}")
            print()
        
        return 0
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1

if __name__ == "__main__":
    sys.exit(main())
