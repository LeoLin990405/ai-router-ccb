#!/usr/bin/env python3
"""
qwenping - Test connectivity with Qwen API.
"""
from __future__ import annotations

import os
import sys
import json
import urllib.request
import urllib.error


API_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1/models"


def main() -> int:
    api_key = os.environ.get("DASHSCOPE_API_KEY") or os.environ.get("QWEN_API_KEY")
    if not api_key:
        print("[ERROR] DASHSCOPE_API_KEY not set. Get one at https://dashscope.console.aliyun.com/")
        return 1

    try:
        headers = {"Authorization": f"Bearer {api_key}"}
        req = urllib.request.Request(API_URL, headers=headers, method="GET")
        with urllib.request.urlopen(req, timeout=10) as resp:
            data = json.loads(resp.read().decode("utf-8"))
            models = [m.get("id", "") for m in data.get("data", [])][:3]
            print(f"âœ… Qwen API connection OK (models: {', '.join(models)}...)")
            return 0
    except urllib.error.HTTPError as e:
        print(f"[ERROR] Qwen API error {e.code}")
        return 1
    except Exception as e:
        print(f"[ERROR] Qwen API check failed: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
