# Hivemind å®Œæ•´æ¶æ„æ–‡æ¡£ + è¿­ä»£è·¯çº¿å›¾

**ç‰ˆæœ¬**: v0.26 â†’ v1.0 â†’ v1.1
**æ›´æ–°æ—¥æœŸ**: 2026-02-09
**ä»£ç åº“**: `~/.local/share/codex-dual/` (GitHub: LeoLin990405/Hivemind)

---

## ç›®å½•

- **Part I: å½“å‰æ¶æ„ (v0.26)**
  - [1. ç³»ç»Ÿå…¨æ™¯](#1-ç³»ç»Ÿå…¨æ™¯)
  - [2. ä¸‰å¤§æ•°æ®åº“](#2-ä¸‰å¤§æ•°æ®åº“)
  - [3. è®°å¿†ç³»ç»Ÿ Memory](#3-è®°å¿†ç³»ç»Ÿ-memory)
  - [4. çŸ¥è¯†ç³»ç»Ÿ Knowledge](#4-çŸ¥è¯†ç³»ç»Ÿ-knowledge)
  - [5. Ollama é›†æˆ](#5-ollama-é›†æˆ)
  - [6. Gateway è®°å¿†ä¸­é—´ä»¶](#6-gateway-è®°å¿†ä¸­é—´ä»¶)
  - [7. å®Œæ•´è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ](#7-å®Œæ•´è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ)
  - [8. PDF Pipeline](#8-pdf-pipeline)
  - [9. Agent ç³»ç»Ÿ](#9-agent-ç³»ç»Ÿ)
- **Part II: v1.0 ä¼˜åŒ–é‡æ„**
  - [10. v1.0 é—®é¢˜è¯Šæ–­](#10-v10-é—®é¢˜è¯Šæ–­)
  - [11. v1.0 ç›®æ ‡æ¶æ„](#11-v10-ç›®æ ‡æ¶æ„)
  - [12. v1.0 ä¸ƒé˜¶æ®µè®¡åˆ’](#12-v10-ä¸ƒé˜¶æ®µè®¡åˆ’)
- **Part III: v1.1 çŸ¥è¯† + è·¯ç”±è¿­ä»£**
  - [13. v1.1 ç›®æ ‡](#13-v11-ç›®æ ‡)
  - [14. æ¨¡å— A: å¤š Agent å…±äº«çŸ¥è¯†](#14-æ¨¡å—-a-å¤š-agent-å…±äº«çŸ¥è¯†)
  - [15. æ¨¡å— B: Skill/MCP æ™ºèƒ½è·¯ç”±](#15-æ¨¡å—-b-skillmcp-æ™ºèƒ½è·¯ç”±)
  - [16. A+B è”åŠ¨](#16-ab-è”åŠ¨)
  - [17. v1.1 å®æ–½è®¡åˆ’](#17-v11-å®æ–½è®¡åˆ’)
- **Part IV: å½“å‰é™åˆ¶ä¸æœªæ¥**
  - [18. å·®è·åˆ†æ](#18-å·®è·åˆ†æ)
  - [19. ç‰ˆæœ¬è·¯çº¿å›¾](#19-ç‰ˆæœ¬è·¯çº¿å›¾)
  - [20. å…³é”®æ–‡ä»¶ç´¢å¼•](#20-å…³é”®æ–‡ä»¶ç´¢å¼•)

---

# Part I: å½“å‰æ¶æ„ (v0.26)

---

## 1. ç³»ç»Ÿå…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               Hivemind Gateway (:8765)                             â”‚
â”‚                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                       Memory Middleware (v2.0)                               â”‚  â”‚
â”‚  â”‚                                                                              â”‚  â”‚
â”‚  â”‚  Pre-Request Hook:                      Post-Response Hook:                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚  â”‚ 1. Ollama å…³é”®è¯  â”‚                   â”‚ 1. è®°å½•å¯¹è¯       â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚    æå–           â”‚                   â”‚ 2. æ›´æ–°ç»Ÿè®¡       â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚ 2. FTS5 å…¨æ–‡æ£€ç´¢  â”‚                   â”‚ 3. æ³¨å…¥è¿½è¸ªè®°å½•   â”‚                 â”‚  â”‚
â”‚  â”‚  â”‚ 3. Î±R+Î²I+Î³T è¯„åˆ† â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚  â”‚ 4. ä¸Šä¸‹æ–‡æ³¨å…¥     â”‚                                                       â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Router    â”‚  â”‚  Cache     â”‚  â”‚ Rate       â”‚  â”‚  Health    â”‚  â”‚  Retry/    â”‚  â”‚
â”‚  â”‚  (æ™ºèƒ½è·¯ç”±)â”‚  â”‚  (å“åº”ç¼“å­˜)â”‚  â”‚ Limiter    â”‚  â”‚  Checker   â”‚  â”‚  Fallback  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                        â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Backend Executor                                   â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚   â”‚
â”‚  â”‚   â”‚ HTTP     â”‚   â”‚ CLI      â”‚   â”‚ Pipe     â”‚                              â”‚   â”‚
â”‚  â”‚   â”‚ Backend  â”‚   â”‚ Backend  â”‚   â”‚ Backend  â”‚                              â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                    â”‚
â”‚   æ•°æ®å±‚ (3 ä¸ªç‹¬ç«‹ SQLite):                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ Memory DB    â”‚  â”‚ Knowledge DB     â”‚  â”‚ Gateway DB        â”‚                   â”‚
â”‚   â”‚ ~/.ccb/      â”‚  â”‚ data/knowledge_  â”‚  â”‚ ~/.ccb_config/    â”‚                   â”‚
â”‚   â”‚ ccb_memory   â”‚  â”‚ index.db         â”‚  â”‚ gateway.db        â”‚                   â”‚
â”‚   â”‚ .db          â”‚  â”‚                  â”‚  â”‚                   â”‚                   â”‚
â”‚   â”‚ 11 tables    â”‚  â”‚ 2 tables         â”‚  â”‚ 6 tables          â”‚                   â”‚
â”‚   â”‚ + 2 FTS5     â”‚  â”‚                  â”‚  â”‚                   â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                             â”‚                                                      â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚                â–¼                         â–¼                                         â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚          â”‚NotebookLMâ”‚            â”‚ Obsidian â”‚                                     â”‚
â”‚          â”‚ 254+ NB  â”‚            â”‚ æœ¬åœ° MD  â”‚                                     â”‚
â”‚          â”‚ Google   â”‚            â”‚ ~/Desktopâ”‚                                     â”‚
â”‚          â”‚ Cloud AI â”‚            â”‚ /æ–°ç¬”è®°   â”‚                                     â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                     â–¼                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Kimi   â”‚          â”‚  Qwen   â”‚          â”‚ DeepSeekâ”‚
   â”‚  ğŸš€     â”‚          â”‚  ğŸš€     â”‚          â”‚  âš¡     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Gemini  â”‚          â”‚  Codex  â”‚          â”‚ OpenCodeâ”‚
   â”‚  ğŸ¢     â”‚          â”‚  ğŸ¢     â”‚          â”‚  âš¡     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  iFlow  â”‚          â”‚  Droid  â”‚          â”‚Antigrav â”‚
   â”‚  âš¡     â”‚          â”‚  âš¡     â”‚          â”‚  âš¡     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç‰¹æ€§**: 9 ä¸ª AI Provider, 27 ä¸ª CLI å·¥å…·, 68 ä¸ª Skills, 40+ æ¨¡å—

---

## 2. ä¸‰å¤§æ•°æ®åº“

**å½“å‰ä¸‰ä¸ªæ•°æ®åº“å®Œå…¨éš”ç¦»ï¼Œæ— è·¨åº“æŸ¥è¯¢ã€‚**

### 2.1 è®°å¿†æ•°æ®åº“ `~/.ccb/ccb_memory.db`

å­˜å‚¨æ‰€æœ‰ AI å¯¹è¯å†å²ã€è§‚å¯Ÿç¬”è®°ã€é‡è¦æ€§è¯„åˆ†ã€è®¿é—®æ—¥å¿—ã€‚

| è¡¨å | ç±»å‹ | ç”¨é€” | å…³é”®å­—æ®µ |
|------|------|------|----------|
| `sessions` | æ™®é€šè¡¨ | ä¼šè¯ç®¡ç† | session_id, user_id, created_at |
| `messages` | æ™®é€šè¡¨ | å¯¹è¯è®°å½• | message_id, role, content, provider, tokens, importance_score |
| `messages_fts` | FTS5 è™šæ‹Ÿè¡¨ | æ¶ˆæ¯å…¨æ–‡æœç´¢ | content, provider (Porter è¯å¹²) |
| `observations` | æ™®é€šè¡¨ | çŸ¥è¯†ç‚¹/æ´å¯Ÿ | observation_id, category, content, tags, confidence |
| `observations_fts` | FTS5 è™šæ‹Ÿè¡¨ | è§‚å¯Ÿå…¨æ–‡æœç´¢ | content, category, tags (Porter è¯å¹²) |
| `memory_importance` | æ™®é€šè¡¨ | é‡è¦æ€§è¯„åˆ† | memory_id, importance_score, access_count, score_source |
| `memory_access_log` | æ™®é€šè¡¨ | æ£€ç´¢æ—¥å¿— | memory_id, access_context, query_text, relevance_score |
| `context_injections` | æ™®é€šè¡¨ | æ³¨å…¥è¿½è¸ª | message_id, injection_type, reference_id, relevance_score |
| `request_memory_map` | æ™®é€šè¡¨ | è¯·æ±‚â†’æ³¨å…¥æ˜ å°„ | request_id, injected_memory_ids, relevance_scores |
| `stream_entries` | æ™®é€šè¡¨ | æ€è€ƒé“¾/æµå¼ | request_id, entry_type, content |
| `consolidation_log` | æ™®é€šè¡¨ | System 2 æ•´åˆ | consolidation_type, source_ids, status |
| `archived_sessions` | æ™®é€šè¡¨ | gzip å‹ç¼©å½’æ¡£ | session_id, compressed_data (BLOB) |

### 2.2 çŸ¥è¯†æ•°æ®åº“ `data/knowledge_index.db`

NotebookLM notebooks æœ¬åœ°ç´¢å¼• + æŸ¥è¯¢ç¼“å­˜ã€‚

| è¡¨å | ç”¨é€” | å…³é”®å­—æ®µ |
|------|------|----------|
| `notebooks` | NotebookLM å…ƒæ•°æ®ç´¢å¼• (254+) | id, title, description, topics (JSON), query_count |
| `query_cache` | æŸ¥è¯¢ç»“æœç¼“å­˜ (TTL 24h) | query_hash (MD5), answer, references_json, ttl |

### 2.3 ç½‘å…³æ•°æ®åº“ `~/.ccb_config/gateway.db`

è¯·æ±‚é˜Ÿåˆ—ã€Provider çŠ¶æ€ã€ç›‘æ§æŒ‡æ ‡ã€‚

| è¡¨å | ç”¨é€” | å…³é”®å­—æ®µ |
|------|------|----------|
| `requests` | å¼‚æ­¥è¯·æ±‚é˜Ÿåˆ— | request_id, provider, message, status |
| `responses` | å“åº”å­˜å‚¨ | request_id, response_text, latency_ms |
| `provider_status` | Provider å¥åº·çŠ¶æ€ (9 è¡Œ) | provider, enabled, last_success |
| `metrics` | æ€§èƒ½æŒ‡æ ‡ | provider, latency_ms, tokens, timestamp |
| `discussion_sessions` | å¤š AI è®¨è®ºä¼šè¯ | session_id, topic, providers |
| `discussion_messages` | è®¨è®ºæ¶ˆæ¯ | session_id, provider, content |

---

## 3. è®°å¿†ç³»ç»Ÿ (Memory)

### 3.1 åŒç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CCBMemoryV2 (ä¸»æ¥å£å±‚)                         â”‚
â”‚                   lib/memory/memory_v2.py (~1820 è¡Œ)                â”‚
â”‚                                                                     â”‚
â”‚   record_message() | search_messages() | create_observation()       â”‚
â”‚   search_with_scores() | track_request_injection()                  â”‚
â”‚   archive_session() | sync_stream_file() | apply_decay()            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   System 1: å¿«é€Ÿæ£€ç´¢                    System 2: æ·±åº¦å¤„ç†           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  HeuristicRetriever   â”‚            â”‚  NightlyConsolidator â”‚    â”‚
â”‚   â”‚  (~753 è¡Œ)            â”‚            â”‚  (~800+ è¡Œ)          â”‚    â”‚
â”‚   â”‚                       â”‚            â”‚                      â”‚    â”‚
â”‚   â”‚  â€¢ FTS5 å…¨æ–‡æœç´¢      â”‚            â”‚  â€¢ ä¼šè¯å½’æ¡£åˆ†æ      â”‚    â”‚
â”‚   â”‚  â€¢ BM25 ç›¸å…³æ€§è¯„åˆ†    â”‚            â”‚  â€¢ LLM æ´å¯Ÿæå–      â”‚    â”‚
â”‚   â”‚  â€¢ Î±R+Î²I+Î³T ç»¼åˆè¯„åˆ† â”‚            â”‚  â€¢ åˆå¹¶/æŠ½è±¡/é—å¿˜    â”‚    â”‚
â”‚   â”‚  â€¢ Ebbinghaus é—å¿˜    â”‚            â”‚  â€¢ é•¿æœŸè®°å¿†ç”Ÿæˆ      â”‚    â”‚
â”‚   â”‚  â€¢ è®¿é—®è¿½è¸ª           â”‚            â”‚  â€¢ é‡è¦æ€§è¡°å‡        â”‚    â”‚
â”‚   â”‚                       â”‚            â”‚                      â”‚    â”‚
â”‚   â”‚  å»¶è¿Ÿ: <50ms          â”‚            â”‚  æ‰§è¡Œ: å®šæ—¶/æ‰‹åŠ¨     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚   å¯é€‰: å‘é‡è¯­ä¹‰æœç´¢                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  VectorSearch (~740 è¡Œ)                                     â”‚  â”‚
â”‚   â”‚                                                             â”‚  â”‚
â”‚   â”‚  åµŒå…¥æ¨¡å‹: sentence-transformers/all-MiniLM-L6-v2 (384 dim) â”‚  â”‚
â”‚   â”‚                                                             â”‚  â”‚
â”‚   â”‚  åç«¯:                                                       â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚   â”‚  â”‚ Qdrant  â”‚  â”‚ ChromaDB â”‚  â”‚ InMemory (é»˜è®¤)â”‚              â”‚  â”‚
â”‚   â”‚  â”‚ :6333   â”‚  â”‚ æœ¬åœ°æŒä¹…  â”‚  â”‚ æ— æŒä¹…åŒ–       â”‚              â”‚  â”‚
â”‚   â”‚  â”‚ 100K+   â”‚  â”‚ ~10K å‘é‡ â”‚  â”‚ ~1K å‘é‡       â”‚              â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚   â”‚                                                             â”‚  â”‚
â”‚   â”‚  æ··åˆæ£€ç´¢: 0.5 Ã— cosine_sim + 0.5 Ã— BM25                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                  SQLite (ccb_memory.db)                      â”‚  â”‚
â”‚   â”‚   messages + messages_fts â”‚ observations + observations_fts  â”‚  â”‚
â”‚   â”‚   memory_importance â”‚ memory_access_log â”‚ stream_entries     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å¯å‘å¼æ£€ç´¢å™¨ â€” æ ¸å¿ƒç®—æ³•

**çµæ„Ÿæ¥æº**: Stanford "Generative Agents" è®ºæ–‡ (Park et al., 2023)

#### 3.2.1 è¯„åˆ†å…¬å¼

```
final_score = Î± Ã— R + Î² Ã— I + Î³ Ã— T

Î± = 0.4  (ç›¸å…³æ€§æƒé‡)
Î² = 0.3  (é‡è¦æ€§æƒé‡)
Î³ = 0.3  (æ—¶æ•ˆæ€§æƒé‡)
```

#### 3.2.2 R: ç›¸å…³æ€§ (Relevance) â€” FTS5 BM25

```sql
SELECT m.message_id, m.content, bm25(messages_fts) as fts_rank
FROM messages m
JOIN messages_fts fts ON m.rowid = fts.rowid
WHERE messages_fts MATCH ?
ORDER BY fts_rank LIMIT 50
```

BM25 å½’ä¸€åŒ– (åŸå§‹å€¼ä¸ºè´Ÿæ•°):
```
relevance = clamp((25 + fts_rank) / 25, 0.0, 1.0)

fts_rank = -20 â†’ R = 0.20 (é«˜ç›¸å…³)
fts_rank = -5  â†’ R = 0.80 (æé«˜)
fts_rank = 0   â†’ R = 1.00
æ— åŒ¹é…         â†’ R = 0.50 (é»˜è®¤)
```

#### 3.2.3 I: é‡è¦æ€§ (Importance)

```
æ¥æº: memory_importance è¡¨
é»˜è®¤å€¼: 0.5
æ ‡è®°æ¥æº: 'user' | 'llm' | 'heuristic'
æ¯æ¬¡æ£€ç´¢å‘½ä¸­: access_boost = +0.01
ä¸Šé™: 1.0
```

#### 3.2.4 T: æ—¶æ•ˆæ€§ (Recency) â€” Ebbinghaus é—å¿˜æ›²çº¿

```
T = exp(-Î» Ã— hours_since_last_access)

Î» = 0.1 (è¡°å‡ç‡)

è¡°å‡æ—¶é—´è¡¨:
  åˆšè®¿é—®    â†’ T = 1.000
  1h å‰     â†’ T = 0.905
  5h å‰     â†’ T = 0.607
  10h å‰    â†’ T = 0.368
  24h å‰    â†’ T = 0.091
  48h å‰    â†’ T = 0.008
  1 å‘¨      â†’ T â‰ˆ 0.000 â†’ æˆªæ–­ä¸º min_recency = 0.01
  ä»æœªè®¿é—®  â†’ é»˜è®¤ 168h â†’ T â‰ˆ 0.01
```

#### 3.2.5 å®Œæ•´æ£€ç´¢æµç¨‹

```
è¾“å…¥: "React hooks æœ€ä½³å®è·µ"

Step 1: FTS5 æœç´¢ messages (å€™é€‰æ±  50)
  â†’ "ä¹‹å‰é—® React useEffect" (fts_rank=-8, R=0.68)
  â†’ "React ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ" (fts_rank=-12, R=0.52)

Step 2: FTS5 æœç´¢ observations (å€™é€‰æ±  50)
  â†’ "React 18 æ–°ç‰¹æ€§" (fts_rank=-6, R=0.76)

Step 3: è®¡ç®— final_score
  msg#1: 0.4Ã—0.68 + 0.3Ã—0.50 + 0.3Ã—0.37 = 0.533
  msg#2: 0.4Ã—0.52 + 0.3Ã—0.70 + 0.3Ã—0.91 = 0.691
  obs#1: 0.4Ã—0.76 + 0.3Ã—0.60 + 0.3Ã—0.09 = 0.511

Step 4: æ’åº â†’ msg#2 > msg#1 > obs#1

Step 5: å– top 5

Step 6: è®°å½• memory_access_log + æ›´æ–° access_count
```

### 3.3 Consolidator (System 2: å¤œé—´æ•´åˆ)

```
NightlyConsolidator (lib/memory/consolidator.py)

åŠŸèƒ½:
  â€¢ æ”¶é›†è¿‘æœŸä¼šè¯å½’æ¡£ â†’ æå–ç»“æ„åŒ–é•¿æœŸè®°å¿†
  â€¢ LLM è¾…åŠ©æ´å¯Ÿæå– (httpx â†’ Ollama/äº‘ç«¯)
  â€¢ æ“ä½œç±»å‹: summarize (æ‘˜è¦), forget (é—å¿˜), compress (å‹ç¼©)
  â€¢ è¡°å‡åº”ç”¨: apply_decay(batch_size=1000, min_importance=0.01)
  â€¢ ç»“æœå†™å…¥ observations è¡¨ + consolidation_log

è§¦å‘æ–¹å¼: å®šæ—¶ä»»åŠ¡æˆ–æ‰‹åŠ¨è°ƒç”¨
```

### 3.4 æ•°æ®åº“ Schema å®Œæ•´å®šä¹‰

```sql
-- â•â•â• sessions â•â•â•
CREATE TABLE sessions (
    session_id    TEXT PRIMARY KEY,
    user_id       TEXT,
    created_at    TEXT,
    last_active   TEXT,
    metadata      TEXT  -- JSON
);

-- â•â•â• messages (æ ¸å¿ƒè¡¨) â•â•â•
CREATE TABLE messages (
    message_id        TEXT PRIMARY KEY,        -- UUID
    session_id        TEXT REFERENCES sessions,
    request_id        TEXT,                     -- Gateway è¯·æ±‚ ID
    sequence          INTEGER,                 -- ä¼šè¯å†…é¡ºåº
    role              TEXT,                     -- 'user' | 'assistant' | 'system'
    content           TEXT,                     -- å®Œæ•´æ¶ˆæ¯å†…å®¹
    provider          TEXT,                     -- 'kimi' | 'qwen' | 'codex' | ...
    model             TEXT,                     -- å…·ä½“æ¨¡å‹å
    timestamp         TEXT,                     -- ISO 8601
    latency_ms        INTEGER,                 -- å“åº”å»¶è¿Ÿ (ms)
    tokens            INTEGER,                 -- Token æ•°
    context_injected  INTEGER DEFAULT 0,       -- æ˜¯å¦æ³¨å…¥ä¸Šä¸‹æ–‡ (0/1)
    context_count     INTEGER DEFAULT 0,       -- æ³¨å…¥è®°å¿†æ¡æ•°
    skills_used       TEXT,                     -- JSON: ["skill1", "skill2"]
    metadata          TEXT,                     -- JSON è‡ªç”±å­—æ®µ
    importance_score  REAL DEFAULT 0.5,        -- é‡è¦æ€§ (0-1)
    last_accessed_at  TEXT,                    -- æœ€è¿‘æ£€ç´¢æ—¶é—´
    access_count      INTEGER DEFAULT 0        -- æ£€ç´¢æ¬¡æ•°
);

CREATE VIRTUAL TABLE messages_fts USING fts5(
    content, provider, tokenize='porter'
);

-- â•â•â• observations (æ´å¯Ÿ/çŸ¥è¯†ç‚¹) â•â•â•
CREATE TABLE observations (
    observation_id    TEXT PRIMARY KEY,
    user_id           TEXT,
    category          TEXT,    -- 'insight' | 'preference' | 'fact' | 'note' | 'discussion'
    content           TEXT,
    tags              TEXT,    -- JSON: ["react", "frontend"]
    source            TEXT,    -- 'manual' | 'llm_extracted' | 'consolidator' | 'discussion'
    confidence        REAL,    -- ç½®ä¿¡åº¦ (0-1)
    created_at        TEXT,
    updated_at        TEXT,
    metadata          TEXT,    -- JSON
    importance_score  REAL DEFAULT 0.5,
    last_accessed_at  TEXT,
    access_count      INTEGER DEFAULT 0,
    decay_rate        REAL DEFAULT 0.05
);

CREATE VIRTUAL TABLE observations_fts USING fts5(
    content, category, tags, tokenize='porter'
);

-- â•â•â• memory_importance (é‡è¦æ€§è¯„åˆ†) â•â•â•
CREATE TABLE memory_importance (
    memory_id         TEXT PRIMARY KEY,
    memory_type       TEXT,    -- 'message' | 'observation'
    importance_score  REAL DEFAULT 0.5,
    access_count      INTEGER DEFAULT 0,
    last_accessed_at  TEXT,
    decay_rate        REAL DEFAULT 0.05,
    score_source      TEXT,    -- 'user' | 'llm' | 'heuristic' | 'forget'
    created_at        TEXT,
    updated_at        TEXT
);

-- â•â•â• memory_access_log (æ£€ç´¢æ—¥å¿—) â•â•â•
CREATE TABLE memory_access_log (
    id               INTEGER PRIMARY KEY AUTOINCREMENT,
    memory_id        TEXT,
    memory_type      TEXT,
    accessed_at      TEXT,
    access_context   TEXT,    -- 'retrieval' | 'injection' | 'user_view' | 'search'
    request_id       TEXT,
    query_text       TEXT,    -- å‰ 500 å­—ç¬¦
    relevance_score  REAL
);

-- â•â•â• context_injections (é€æ˜è¿½è¸ª) â•â•â•
CREATE TABLE context_injections (
    message_id       TEXT,
    injection_type   TEXT,    -- 'memory' | 'skill' | 'provider' | 'mcp'
    reference_id     TEXT,
    relevance_score  REAL,
    metadata         TEXT
);

-- â•â•â• request_memory_map (è¯·æ±‚â†’æ³¨å…¥æ˜ å°„) â•â•â•
CREATE TABLE request_memory_map (
    request_id              TEXT PRIMARY KEY,
    session_id              TEXT,
    provider                TEXT,
    original_message        TEXT,
    injected_memory_ids     TEXT,    -- JSON array
    injected_skills         TEXT,    -- JSON array
    injected_system_context INTEGER, -- 0/1
    injection_timestamp     TEXT,
    memory_count            INTEGER,
    skills_count            INTEGER,
    relevance_scores        TEXT,    -- JSON: {memory_id: score}
    metadata                TEXT
);

-- â•â•â• stream_entries (æ€è€ƒé“¾ + æµå¼å†…å®¹) â•â•â•
CREATE TABLE stream_entries (
    id          INTEGER PRIMARY KEY,
    request_id  TEXT,
    entry_type  TEXT,    -- 'thinking' | 'text' | 'tool_call'
    timestamp   REAL,    -- Unix
    content     TEXT,
    metadata    TEXT,
    created_at  TEXT
);

-- â•â•â• consolidation_log (System 2 æ•´åˆ) â•â•â•
CREATE TABLE consolidation_log (
    consolidation_type TEXT,    -- 'summarize' | 'forget' | 'compress'
    source_ids         TEXT,    -- JSON array
    status             TEXT,    -- 'pending' | 'completed'
    metadata           TEXT,    -- JSON {reason, memory_type}
    created_at         TEXT
);

-- â•â•â• archived_sessions (å‹ç¼©å½’æ¡£) â•â•â•
CREATE TABLE archived_sessions (
    session_id      TEXT,
    user_id         TEXT,
    created_at      TEXT,
    archived_at     TEXT,
    message_count   INTEGER,
    total_tokens    INTEGER,
    compressed_data BLOB    -- gzip JSON
);
```

---

## 4. çŸ¥è¯†ç³»ç»Ÿ (Knowledge)

### 4.1 æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KnowledgeRouter (è·¯ç”±å±‚)                          â”‚
â”‚                  lib/knowledge/router.py (~300 è¡Œ)                   â”‚
â”‚                                                                     â”‚
â”‚  å…¥å£: query(question, source="auto", notebook_id=None)             â”‚
â”‚  ç¼“å­˜: MD5(question:source:notebook_id) â†’ 24h TTL                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚    NotebookLMClient      â”‚    â”‚     ObsidianSearch       â”‚      â”‚
â”‚  â”‚                          â”‚    â”‚                          â”‚      â”‚
â”‚  â”‚  CLI: notebooklm         â”‚    â”‚  Vault: ~/Desktop/æ–°ç¬”è®°  â”‚      â”‚
â”‚  â”‚  254+ notebooks          â”‚    â”‚  Markdown å…¨æ–‡æœç´¢        â”‚      â”‚
â”‚  â”‚  Google Cloud AI åç«¯    â”‚    â”‚  æ’é™¤: .obsidian, .trash  â”‚      â”‚
â”‚  â”‚                          â”‚    â”‚                          â”‚      â”‚
â”‚  â”‚  åŠŸèƒ½:                    â”‚    â”‚  åŠŸèƒ½:                    â”‚      â”‚
â”‚  â”‚  â€¢ AI é—®ç­” (ask)         â”‚    â”‚  â€¢ æœç´¢ç¬”è®°              â”‚      â”‚
â”‚  â”‚  â€¢ æ¥æºç®¡ç†              â”‚    â”‚  â€¢ è¯»å†™ç¬”è®°              â”‚      â”‚
â”‚  â”‚  â€¢ æ’­å®¢/è§†é¢‘/æµ‹éªŒç”Ÿæˆ    â”‚    â”‚  â€¢ MCP Server é›†æˆ       â”‚      â”‚
â”‚  â”‚  â€¢ ç½‘ç»œç ”ç©¶ (add-research)â”‚    â”‚                          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  IndexManager (SQLite)                        â”‚  â”‚
â”‚  â”‚              data/knowledge_index.db                          â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  notebooks: 254+ æ¡ NotebookLM å…ƒæ•°æ®                         â”‚  â”‚
â”‚  â”‚    â†’ title, description, topics (JSON), query_count            â”‚  â”‚
â”‚  â”‚    â†’ å…³é”®è¯è¯„åˆ†: title(+3), description(+2), topics(+1)        â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  query_cache: æŸ¥è¯¢ç¼“å­˜                                        â”‚  â”‚
â”‚  â”‚    â†’ key: MD5(question:source:notebook_id)                     â”‚  â”‚
â”‚  â”‚    â†’ TTL: 86400 ç§’ (24h)                                      â”‚  â”‚
â”‚  â”‚    â†’ è¿‡æœŸè‡ªåŠ¨æ¸…ç†                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è·¯ç”±å†³ç­–é€»è¾‘

```
query(question, source="auto")
  â”‚
  â”œâ”€â”€ [1] æ£€æŸ¥ç¼“å­˜
  â”‚   cache_key = MD5(question + ":" + source + ":" + notebook_id)
  â”‚   å‘½ä¸­ä¸”æœªè¿‡æœŸ â†’ ç›´æ¥è¿”å› {cached: true}
  â”‚
  â”œâ”€â”€ [2] source è·¯ç”±
  â”‚   "notebooklm" â†’ _query_notebooklm(question)
  â”‚   "obsidian"   â†’ _query_obsidian(question)
  â”‚   "auto"       â†’ _auto_route(question)
  â”‚
  â””â”€â”€ [3] _auto_route é€»è¾‘:
      â”‚
      â”œâ”€â”€ æŒ‡å®š notebook_id â†’ NotebookLM (æŒ‡å®š notebook)
      â”‚
      â”œâ”€â”€ local_first=True:
      â”‚   â”œâ”€â”€ å…ˆæŸ¥ Obsidian
      â”‚   â”œâ”€â”€ confidence >= 0.7 â†’ è¿”å› Obsidian ç»“æœ
      â”‚   â””â”€â”€ confidence < 0.7 â†’ é™çº§ NotebookLM
      â”‚
      â”œâ”€â”€ NotebookLM å¯ç”¨:
      â”‚   â”œâ”€â”€ IndexManager.find_best_notebook(question)
      â”‚   â”‚   â†’ å…³é”®è¯è¯„åˆ†æ‰¾æœ€åŒ¹é… notebook
      â”‚   â””â”€â”€ æŸ¥è¯¢è¯¥ notebook
      â”‚
      â””â”€â”€ å…¨éƒ¨å¤±è´¥ â†’ {source: "none", error: "..."}
```

### 4.3 è¿”å›æ ¼å¼

```json
{
    "answer": "React hooks æ˜¯...",
    "source": "notebooklm",
    "references": [{"title": "Reactç¬”è®°", "path": "..."}],
    "confidence": 0.85,
    "cached": false,
    "error": null,
    "notebook_id": "abc123"
}
```

---

## 5. Ollama é›†æˆ

### 5.1 ä½¿ç”¨ä½ç½®

Ollama **ä»…**åœ¨ `MemoryMiddleware._extract_keywords_with_llm()` ä¸­ä½¿ç”¨ã€‚

**ç”¨é€”**: ä»ç”¨æˆ·é—®é¢˜æå– 2-3 ä¸ªå…³é”®è¯ï¼Œç”¨äº FTS5 å…¨æ–‡æœç´¢è®°å¿†åº“ã€‚

### 5.2 ä¸‰çº§é™çº§è·¯ç”±

```
ç”¨æˆ·æ¶ˆæ¯ â†’ _extract_keywords_with_llm(text)
  â”‚
  â”œâ”€â”€ å°è¯• 1: qwen2.5:7b (æœ¬åœ° Ollama)
  â”‚   â”œâ”€â”€ API: POST http://localhost:11434/api/generate
  â”‚   â”œâ”€â”€ æ¨¡å‹å¤§å°: 7.6GB
  â”‚   â”œâ”€â”€ è¶…æ—¶: 6 ç§’
  â”‚   â”œâ”€â”€ çƒ­å¯åŠ¨: ~0.5s, å†·å¯åŠ¨: ~5s
  â”‚   â”œâ”€â”€ temperature: 0.3, num_predict: 50
  â”‚   â”‚
  â”‚   â”œâ”€â”€ æˆåŠŸ â†’ è¿”å›å…³é”®è¯
  â”‚   â”œâ”€â”€ ConnectionError (Ollama æœªè¿è¡Œ) â†’ è·³åˆ° regex
  â”‚   â””â”€â”€ Timeout â†’ å°è¯• 2
  â”‚
  â”œâ”€â”€ å°è¯• 2: deepseek-v3.1:671b-cloud (äº‘ç«¯ Ollama)
  â”‚   â”œâ”€â”€ API: POST http://localhost:11434/api/generate (Ollama äº‘ä»£ç†)
  â”‚   â”œâ”€â”€ æ¨¡å‹: 671B å‚æ•°
  â”‚   â”œâ”€â”€ è¶…æ—¶: 10 ç§’
  â”‚   â”œâ”€â”€ å»¶è¿Ÿ: 1.5-3s
  â”‚   â”‚
  â”‚   â”œâ”€â”€ æˆåŠŸ â†’ è¿”å›å…³é”®è¯
  â”‚   â””â”€â”€ å¤±è´¥ â†’ å°è¯• 3
  â”‚
  â””â”€â”€ é™çº§ 3: _extract_keywords_regex()
      â”œâ”€â”€ æ—  LLM ä¾èµ–, å»¶è¿Ÿ <10ms
      â”œâ”€â”€ ä¸­æ–‡: [\u4e00-\u9fff]{3,4} (3-4 å­—è¯)
      â”œâ”€â”€ è‹±æ–‡: [a-zA-Z]{3,} (3+ å­—æ¯è¯)
      â”œâ”€â”€ è¿‡æ»¤åœç”¨è¯ â†’ top 5
      â””â”€â”€ ç©ºç»“æœä¸”åŸæ–‡ â‰¤10 å­— â†’ è¿”å›åŸæ–‡
```

### 5.3 Prompt æ¨¡æ¿

```
ä»ä¸‹é¢çš„é—®é¢˜ä¸­æå–2-3ä¸ªæœ€æ ¸å¿ƒçš„å…³é”®è¯ï¼ˆåè¯æˆ–åè¯çŸ­è¯­ï¼‰ï¼Œç”¨é€—å·åˆ†éš”ã€‚
åªè¿”å›å…³é”®è¯ï¼Œä¸è¦å…¶ä»–è§£é‡Šã€‚

é—®é¢˜ï¼šå¦‚ä½•ä½¿ç”¨ React hooks ç®¡ç†çŠ¶æ€ï¼Ÿ

å…³é”®è¯ï¼š
```

### 5.4 API è°ƒç”¨

```json
POST http://localhost:11434/api/generate
{
    "model": "qwen2.5:7b",
    "prompt": "<ä¸Šè¿° prompt>",
    "stream": false,
    "options": {"temperature": 0.3, "num_predict": 50}
}

â†’ {"response": "React hooks, çŠ¶æ€ç®¡ç†, useState"}
â†’ split(",") â†’ strip() â†’ ["React hooks", "çŠ¶æ€ç®¡ç†", "useState"]
```

---

## 6. Gateway è®°å¿†ä¸­é—´ä»¶

### 6.1 é…ç½®

```python
MemoryMiddleware é»˜è®¤é…ç½®:
{
    "memory": {
        "enabled": True,
        "auto_inject": True,                    # è‡ªåŠ¨æ³¨å…¥è®°å¿†
        "auto_record": True,                    # è‡ªåŠ¨è®°å½•å¯¹è¯
        "max_injected_memories": 5,             # æœ€å¤šæ³¨å…¥ 5 æ¡
        "inject_system_context": True,          # æ³¨å…¥ç³»ç»Ÿä¸Šä¸‹æ–‡
        "injection_strategy": "recent_plus_relevant",
        "use_heuristic_retrieval": True         # å¯å‘å¼æ£€ç´¢ (v2.0)
    },
    "skills": {
        "auto_discover": True,                  # è‡ªåŠ¨å‘ç° skills
        "recommend_skills": True,
        "max_recommendations": 3
    },
    "recommendation": {
        "enabled": True,
        "auto_switch_provider": False,
        "confidence_threshold": 0.7
    }
}
```

### 6.2 Pre-Request å®Œæ•´æµç¨‹

```
ç”¨æˆ·: "å¸®æˆ‘ä¼˜åŒ–è¿™ä¸ª React ç»„ä»¶"
  â”‚
  â–¼
[1] æå–å…³é”®è¯ (Ollama qwen2.5:7b)
    â†’ ["React", "ç»„ä»¶", "ä¼˜åŒ–"]
  â”‚
  â–¼
[2] å¯å‘å¼è®°å¿†æ£€ç´¢ (HeuristicRetriever.retrieve)
    FTS5("React ç»„ä»¶ ä¼˜åŒ–") â†’ 50+50 å€™é€‰ â†’ Î±R+Î²I+Î³T â†’ Top 5
    #1: "React æ€§èƒ½ä¼˜åŒ–è®¨è®º" (score: 0.72)
    #2: "React memo å»ºè®®" (score: 0.65)
  â”‚
  â–¼
[3] Skills å‘ç° (SkillsDiscoveryService)
    â†’ æ¨è: /frontend (score: 0.85)
  â”‚
  â–¼
[4] ç³»ç»Ÿä¸Šä¸‹æ–‡ (SystemContextBuilder)
    â†’ Provider ä¿¡æ¯ + Agent è§’è‰²
  â”‚
  â–¼
[5] æ³¨å…¥åˆ° prompt:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ # ç³»ç»Ÿä¸Šä¸‹æ–‡                            â”‚
    â”‚                                         â”‚
    â”‚ ## ğŸ’­ ç›¸å…³è®°å¿†                           â”‚
    â”‚ 1. [kimi] (0.72) React æ€§èƒ½ä¼˜åŒ–...      â”‚
    â”‚    A: ä½¿ç”¨ React.memo å’Œ useMemo...     â”‚
    â”‚ 2. [qwen] (0.65) memo å»ºè®®...          â”‚
    â”‚                                         â”‚
    â”‚ ## ğŸ› ï¸ ç›¸å…³æŠ€èƒ½                          â”‚
    â”‚ - /frontend (0.85) - å‰ç«¯å¼€å‘ âœ“         â”‚
    â”‚                                         â”‚
    â”‚ ---                                     â”‚
    â”‚ # ç”¨æˆ·è¯·æ±‚                              â”‚
    â”‚ å¸®æˆ‘ä¼˜åŒ–è¿™ä¸ª React ç»„ä»¶                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
[6] æ ‡è®°: _memory_injected=True, _memory_count=2
  â”‚
  â–¼
[7] â†’ å‘é€åˆ° Provider
```

### 6.3 Post-Response æµç¨‹

```
Provider è¿”å›å“åº”
  â”‚
  â–¼
[1] record_conversation()
    â†’ INSERT messages (user_msg + assistant_msg)
    â†’ åŒæ­¥åˆ° FTS5
  â”‚
  â–¼
[2] track_request_injection()
    â†’ INSERT request_memory_map {
        injected_memory_ids: ["mem1", "mem2"],
        relevance_scores: {"mem1": 0.72, "mem2": 0.65}
      }
  â”‚
  â–¼
[3] æ›´æ–° memory_access_log
    â†’ æ¯æ¡è¢«æ£€ç´¢è®°å¿†: accessed_at, query_text, relevance_score
  â”‚
  â–¼
[4] æ›´æ–° memory_importance
    â†’ access_count += 1
```

---

## 7. å®Œæ•´è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User  â”‚    â”‚ Gateway â”‚    â”‚ Memory   â”‚    â”‚ Ollama â”‚    â”‚ Provider â”‚
â”‚        â”‚    â”‚  API    â”‚    â”‚Middlewareâ”‚    â”‚ (æœ¬åœ°) â”‚    â”‚  (AI)    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚              â”‚               â”‚              â”‚
    â”‚ ccb-cli kimi â”‚              â”‚               â”‚              â”‚
    â”‚ "Reactä¼˜åŒ–"  â”‚              â”‚               â”‚              â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚               â”‚              â”‚
    â”‚              â”‚ pre_request()â”‚               â”‚              â”‚
    â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚              â”‚
    â”‚              â”‚              â”‚ å…³é”®è¯æå–     â”‚              â”‚
    â”‚              â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
    â”‚              â”‚              â”‚ [React,ä¼˜åŒ–]   â”‚              â”‚
    â”‚              â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
    â”‚              â”‚              â”‚               â”‚              â”‚
    â”‚              â”‚              â”‚ FTS5 + Î±R+Î²I+Î³T              â”‚
    â”‚              â”‚              â”‚ (ccb_memory.db)              â”‚
    â”‚              â”‚              â”‚               â”‚              â”‚
    â”‚              â”‚              â”‚ æ³¨å…¥ä¸Šä¸‹æ–‡     â”‚              â”‚
    â”‚              â”‚ modified req â”‚               â”‚              â”‚
    â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚
    â”‚              â”‚              â”‚               â”‚              â”‚
    â”‚              â”‚ å‘é€åˆ° Provider              â”‚              â”‚
    â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚              â”‚              â”‚               â”‚              â”‚
    â”‚              â”‚ AI å“åº”      â”‚               â”‚              â”‚
    â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚              â”‚ post_responseâ”‚               â”‚              â”‚
    â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚              â”‚
    â”‚              â”‚              â”‚ è®°å½•å¯¹è¯       â”‚              â”‚
    â”‚              â”‚              â”‚ è®°å½•æ³¨å…¥è¿½è¸ª   â”‚              â”‚
    â”‚              â”‚              â”‚ æ›´æ–°è®¿é—®æ—¥å¿—   â”‚              â”‚
    â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚
    â”‚ è¿”å›å“åº”     â”‚              â”‚               â”‚              â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚               â”‚              â”‚
```

### æ—¶é—´çº¿ (Kimi å¿«é€Ÿè·¯å¾„)

| é˜¶æ®µ | è€—æ—¶ | ç´¯è®¡ |
|------|------|------|
| æ¥æ”¶è¯·æ±‚ | ~1ms | 1ms |
| Ollama å…³é”®è¯æå– (çƒ­) | ~500ms | ~500ms |
| FTS5 æœç´¢ + Î±R+Î²I+Î³T è¯„åˆ† | ~30ms | ~530ms |
| ä¸Šä¸‹æ–‡æ ¼å¼åŒ– + æ³¨å…¥ | ~5ms | ~535ms |
| Provider å“åº” (Kimi) | ~5,000ms | ~5,535ms |
| è®°å½•å¯¹è¯ + æ—¥å¿— | ~20ms | ~5,555ms |
| **æ€»ç«¯åˆ°ç«¯** | **~5.5s** | |

---

## 8. PDF Pipeline

### 8.1 pdf-to-notebook å…¨è‡ªåŠ¨æµç¨‹

```
pdf-to-notebook /path/to/book.pdf "ã€Šä¹¦åã€‹"
  â”‚
  â”œâ”€â”€ [1/5] åˆ†æ (PyMuPDF)
  â”‚   â†’ é¡µæ•°, TOC, æ–‡æœ¬æ£€æµ‹ (é‡‡æ · 10 é¡µ)
  â”‚   â†’ is_text_pdf? (æ–‡æœ¬ â‰¥ 70% é‡‡æ ·é¡µ)
  â”‚
  â”œâ”€â”€ [2/5] è§„åˆ’åˆ†å‰²
  â”‚   â†’ è¶…è¿‡ 600 é¡µåˆ™åˆ†å‰²
  â”‚   â†’ æŒ‰ç« èŠ‚è¾¹ç•Œå¯¹é½ (TOC level â‰¤ 2)
  â”‚   â†’ æ¯ç‰‡ â‰¤ 500 é¡µ
  â”‚
  â”œâ”€â”€ [3/5] åˆ†å‰² (PyMuPDF)
  â”‚   â†’ insert_pdf(from_page, to_page)
  â”‚   â†’ å•ç‰‡ä¸åˆ†å‰²
  â”‚
  â”œâ”€â”€ [4/5] è½¬æ¢
  â”‚   â”œâ”€â”€ auto â†’ æ–‡æœ¬ PDF â†’ pymupdf
  â”‚   â”œâ”€â”€ auto â†’ æ‰«æ PDF â†’ mineru (MinerU Cloud API)
  â”‚   â”‚
  â”‚   â”‚  MinerU æµç¨‹:
  â”‚   â”‚  POST /file-urls/batch â†’ è·å–é¢„ç­¾å URL
  â”‚   â”‚  PUT ä¸Šä¼ åˆ° OSS (http.client, æ— é¢å¤– headers)
  â”‚   â”‚  Poll /extract-results/batch/{id} (5s é—´éš”, æœ€é•¿ 10min)
  â”‚   â”‚  ä¸‹è½½ ZIP â†’ è§£å‹ â†’ æå– Markdown
  â”‚   â”‚
  â”‚   â””â”€â”€ pymupdf â†’ page.get_text("text") â†’ Markdown
  â”‚
  â””â”€â”€ [5/5] ä¸Šä¼  NotebookLM
      â†’ notebooklm create "æ ‡é¢˜"
      â†’ notebooklm source add <md_file> --notebook <id>
```

### 8.2 è½¬æ¢æ–¹æ³•

| æ–¹æ³• | é€‚ç”¨ | é€Ÿåº¦ | ä¾èµ– |
|------|------|------|------|
| `pymupdf` (é»˜è®¤) | æ–‡æœ¬å‹ PDF | ç§’çº§ | PyMuPDF (æœ¬åœ°) |
| `mineru` | æ‰«æä»¶/å›¾ç‰‡ PDF | 5-30s | MinerU Cloud API |
| `auto` | è‡ªåŠ¨æ£€æµ‹ | æŒ‰éœ€ | - |

---

## 9. Agent ç³»ç»Ÿ

```
lib/agents/
â”œâ”€â”€ sisyphus.py  ğŸª¨  ä»£ç å®ç° (æŒç»­æ”¹è¿›ã€bug ä¿®å¤)
â”œâ”€â”€ oracle.py    ğŸ”®  åˆ†æé¢„æµ‹ (è¶‹åŠ¿ã€é£é™©)
â”œâ”€â”€ librarian.py ğŸ“š  æ–‡æ¡£æ•´ç† (çŸ¥è¯†ã€ç´¢å¼•)
â”œâ”€â”€ explorer.py  ğŸ§­  æ¢ç´¢è°ƒç ” (æ–°æŠ€æœ¯ã€æ–¹æ¡ˆ)
â”œâ”€â”€ frontend.py  ğŸ¨  å‰ç«¯å¼€å‘ (React/Vue/CSS)
â””â”€â”€ reviewer.py  ğŸ”  ä»£ç å®¡æŸ¥ (å®‰å…¨ã€è´¨é‡)
```

Agent é€šè¿‡ `-a` å‚æ•°æ¿€æ´»: `ccb-cli kimi -a sisyphus "ä¿®å¤è¿™ä¸ª bug"`

---

# Part II: v1.0 ä¼˜åŒ–é‡æ„

---

## 10. v1.0 é—®é¢˜è¯Šæ–­

| æŒ‡æ ‡ | å½“å‰å€¼ | é—®é¢˜ |
|------|--------|------|
| æ€»ä»£ç é‡ | 48,525 è¡Œ | å¤§é‡é‡å¤ |
| æœ€å¤§å•æ–‡ä»¶ | 3,917 è¡Œ (gateway_api.py) | God Object |
| Comm æ¨¡å—é‡å¤ | 6,450 è¡Œ (8 ä¸ª *_comm.py) | æ— å…¬å…±åŸºç±» |
| `except Exception` | 500 å¤„ | åæ‰é”™è¯¯ |
| `print()` è°ƒç”¨ | 685 å¤„ | æ— ç»“æ„åŒ–æ—¥å¿— |
| æµ‹è¯•è¦†ç›–ç‡ | 8:1 ä»£ç /æµ‹è¯•æ¯” | æä½ |
| SQLite æ•°æ®åº“ | 4 ä¸ªç‹¬ç«‹ | æ— ç»Ÿä¸€ç®¡ç† |

---

## 11. v1.0 ç›®æ ‡æ¶æ„

```
lib/
â”œâ”€â”€ common/                     â† ğŸ†• å…±äº«åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ logging.py              â† ç»Ÿä¸€æ—¥å¿— (æ›¿ä»£ 685 ä¸ª print)
â”‚   â”œâ”€â”€ errors.py               â† åˆ†çº§å¼‚å¸¸ç±»
â”‚   â”œâ”€â”€ auth.py                 â† ç»Ÿä¸€è®¤è¯ç®¡ç†
â”‚   â””â”€â”€ tokens.py               â† Token ä¼°ç®—
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ app.py                  â† ğŸ†• FastAPI app factory (<100 è¡Œ)
â”‚   â”œâ”€â”€ routes/                 â† ğŸ†• æ‹†åˆ† gateway_api.py (3917â†’8Ã—<500)
â”‚   â”‚   â”œâ”€â”€ core.py             â† /api/ask, /api/submit, /api/query
â”‚   â”‚   â”œâ”€â”€ batch.py            â† /api/batch/*
â”‚   â”‚   â”œâ”€â”€ parallel.py         â† /api/parallel/*
â”‚   â”‚   â”œâ”€â”€ discussion.py       â† /api/discussion/*
â”‚   â”‚   â”œâ”€â”€ memory.py           â† /api/memory/*
â”‚   â”‚   â”œâ”€â”€ admin.py            â† /api/admin/*, /api/cache/*
â”‚   â”‚   â”œâ”€â”€ health.py           â† /api/health, /api/metrics
â”‚   â”‚   â”œâ”€â”€ knowledge.py        â† /knowledge/*
â”‚   â”‚   â””â”€â”€ websocket.py        â† /ws
â”‚   â”œâ”€â”€ backends/
â”‚   â”‚   â”œâ”€â”€ base.py             â† å¢å¼º: ContentExtractor æ¥å£
â”‚   â”‚   â”œâ”€â”€ http.py             â† æ‹†åˆ† provider-specific
â”‚   â”‚   â”œâ”€â”€ cli.py
â”‚   â”‚   â””â”€â”€ extractors/         â† ğŸ†• provider-specific æå–
â”‚   â”‚       â”œâ”€â”€ anthropic.py
â”‚   â”‚       â”œâ”€â”€ openai.py
â”‚   â”‚       â””â”€â”€ gemini.py
â”‚   â””â”€â”€ middleware/
â”œâ”€â”€ providers/                  â† ğŸ†• æ›¿ä»£ 8 ä¸ª *_comm.py (6450â†’~1000)
â”‚   â”œâ”€â”€ base.py                 â† BaseCommReader åŸºç±» (~200 è¡Œ)
â”‚   â”œâ”€â”€ codex.py                â† <100 è¡Œé€‚é…å™¨
â”‚   â”œâ”€â”€ gemini.py
â”‚   â”œâ”€â”€ kimi.py
â”‚   â”œâ”€â”€ qwen.py
â”‚   â”œâ”€â”€ opencode.py
â”‚   â”œâ”€â”€ iflow.py
â”‚   â”œâ”€â”€ droid.py
â”‚   â””â”€â”€ claude.py
â”œâ”€â”€ memory/                     â† ä¿æŒ
â”œâ”€â”€ knowledge/                  â† ä¿æŒ
â”œâ”€â”€ agents/                     â† ä¿æŒ
â””â”€â”€ skills/                     â† ä¿æŒ
```

**ç›®æ ‡æŒ‡æ ‡**:

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ |
|------|------|------|
| æ€»ä»£ç é‡ | 48,525 è¡Œ | <35,000 è¡Œ (-28%) |
| æœ€å¤§å•æ–‡ä»¶ | 3,917 è¡Œ | <500 è¡Œ |
| Comm æ¨¡å— | 8Ã—800 è¡Œ | 1 åŸºç±» + 8Ã—<100 è¡Œ |
| `except Exception` | 500 | <50 |
| `print()` | 685 | <20 (å…¨éƒ¨æ”¹ logging) |
| æµ‹è¯•è¦†ç›–ç‡ | 8:1 | 3:1 |
| æ•°æ®åº“ | 4 ä¸ªç‹¬ç«‹ | 1 ä¸ªç»Ÿä¸€ + migration |

---

## 12. v1.0 ä¸ƒé˜¶æ®µè®¡åˆ’

**æ‰§è¡Œè€…**: Codex AI Agent
**çŠ¶æ€**: æ‰§è¡Œä¸­

| Phase | å†…å®¹ | å…³é”®å˜æ›´ | é¢„è®¡æ—¶é—´ |
|-------|------|----------|----------|
| **Phase 1** | åŸºç¡€è®¾æ–½å±‚ | åˆ›å»º `common/` (logging, errors, auth, tokens) | Day 1-2 |
| **Phase 2** | gateway_api.py æ‹†åˆ† | 3,917 è¡Œ â†’ `routes/` 8 ä¸ªæ–‡ä»¶ + `app.py` | Day 3-5 |
| **Phase 3** | Provider é€šä¿¡ç»Ÿä¸€ | 8 ä¸ª *_comm.py â†’ `providers/base.py` + 8 é€‚é…å™¨ | Day 6-8 |
| **Phase 4** | Backend é‡æ„ | æå– ContentExtractor, æ‹†åˆ† cli_backend | Day 9-10 |
| **Phase 5** | æ•°æ®åº“ç»Ÿä¸€ | 4 DB â†’ 1 DB (`data/hivemind.db`) + migration | Day 11-12 |
| **Phase 6** | æµ‹è¯•è¡¥å…… | æ ¸å¿ƒæ¨¡å— 100% è¦†ç›–, é›†æˆæµ‹è¯• | Day 13-14 |
| **Phase 7** | æ¸…ç† | åˆ é™¤æ—§æ–‡ä»¶, æ›´æ–° imports, æ–‡æ¡£ | Day 15 |

---

# Part III: v1.1 çŸ¥è¯† + è·¯ç”±è¿­ä»£

---

## 13. v1.1 ç›®æ ‡

**å‰ç½®æ¡ä»¶**: v1.0 ä¼˜åŒ–å®Œæˆä¸”æµ‹è¯•é€šè¿‡

### å½“å‰çŠ¶æ€ vs ç›®æ ‡

| ç»„ä»¶ | å½“å‰ (v1.0 å) | v1.1 ç›®æ ‡ |
|------|----------------|-----------|
| Knowledge Hub | å•ç”¨æˆ·, æ—  agent_id | å¤š Agent å…±äº«, agent_id æ„ŸçŸ¥ |
| Memory V2 | æ— è·¨ç³»ç»ŸæŸ¥è¯¢ | ç»Ÿä¸€æŸ¥è¯¢ (Memory + Knowledge + Shared) |
| Skills (68) | æ‰‹åŠ¨é€‰æ‹© | è‡ªåŠ¨å‘ç° + æ¨è |
| MCP (60+ tools) | æ— ç´¢å¼• | ç»Ÿä¸€ç´¢å¼• + å…³é”®è¯åŒ¹é… |
| è¿œç¨‹ Skills | ä»… find-skills | è‡ªåŠ¨å®‰è£…å»ºè®® |

### ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Hivemind v1.1 æ–°å¢å±‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Shared Knowledge Base   â”‚   â”‚   Skill / MCP Router           â”‚ â”‚
â”‚  â”‚  (å¤š Agent å…±äº«çŸ¥è¯†)      â”‚   â”‚   (æ™ºèƒ½å·¥å…·å‘ç°)                â”‚ â”‚
â”‚  â”‚                          â”‚   â”‚                                â”‚ â”‚
â”‚  â”‚  â€¢ agent_id æ„ŸçŸ¥         â”‚   â”‚  â€¢ ç»Ÿä¸€ç´¢å¼• (skill+MCP+è¿œç¨‹)   â”‚ â”‚
â”‚  â”‚  â€¢ å‘å¸ƒ/è®¢é˜…/æŠ•ç¥¨        â”‚   â”‚  â€¢ å…³é”®è¯ + ä¸­è‹±æ˜ å°„åŒ¹é…       â”‚ â”‚
â”‚  â”‚  â€¢ å…±è¯†æœºåˆ¶ (confidence)  â”‚   â”‚  â€¢ å·²å®‰è£…ä¼˜å…ˆ + ä½¿ç”¨åé¦ˆå­¦ä¹    â”‚ â”‚
â”‚  â”‚  â€¢ ç»Ÿä¸€è·¨æºæŸ¥è¯¢          â”‚   â”‚  â€¢ è‡ªåŠ¨å®‰è£…å»ºè®®                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                 â”‚                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                    Gateway API (v1.0 åŸºç¡€)                           â”‚
â”‚          /shared-knowledge/*       /tool-router/*                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å·²æœ‰: Knowledge Hub â”‚ Memory V2 â”‚ 68 Skills â”‚ MCP â”‚ 9 Providers   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 14. æ¨¡å— A: å¤š Agent å…±äº«çŸ¥è¯†

### 14.1 é—®é¢˜

- Agent A å­¦åˆ°çš„ä¸œè¥¿, Agent B çœ‹ä¸åˆ°
- æ— æ³•è®°å½•"è°å‘ç°äº†ä»€ä¹ˆ"
- ä¸èƒ½è·¨ Memory + NotebookLM + Obsidian ç»Ÿä¸€æŸ¥è¯¢
- å¤š Agent æ„è§å†²çªæ—¶æ— å…±è¯†æœºåˆ¶

### 14.2 æ–°å¢æ•°æ®åº“è¡¨

```sql
-- Agent æ³¨å†Œè¡¨
CREATE TABLE agents (
    agent_id      TEXT PRIMARY KEY,     -- "kimi", "codex", "gemini", ...
    display_name  TEXT NOT NULL,
    capabilities  TEXT,                 -- JSON: ["ä¸­æ–‡", "ä»£ç ", "æ¨ç†"]
    trust_score   REAL DEFAULT 0.5,     -- 0-1, åŠ¨æ€è°ƒæ•´
    last_active   TEXT,
    created_at    TEXT DEFAULT (datetime('now'))
);

-- å…±äº«çŸ¥è¯†æ¡ç›®
CREATE TABLE shared_knowledge (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    category        TEXT NOT NULL,      -- 'fact' | 'insight' | 'decision' | 'constraint' | 'preference'
    topic           TEXT NOT NULL,      -- å…³é”®è¯/ä¸»é¢˜
    content         TEXT NOT NULL,
    source_agent    TEXT NOT NULL,      -- è´¡çŒ®è€…
    source_context  TEXT,               -- JSON {request_id, session_id}
    confidence      REAL DEFAULT 1.0,   -- ç½®ä¿¡åº¦
    consensus_count INTEGER DEFAULT 1,  -- è®¤åŒæ•°
    expires_at      TEXT,               -- å¯é€‰è¿‡æœŸ
    created_at      TEXT DEFAULT (datetime('now')),
    updated_at      TEXT DEFAULT (datetime('now')),
    FOREIGN KEY (source_agent) REFERENCES agents(agent_id)
);

CREATE VIRTUAL TABLE shared_knowledge_fts USING fts5(
    topic, content, content='shared_knowledge', content_rowid='id'
);

-- å…±è¯†æŠ•ç¥¨
CREATE TABLE knowledge_votes (
    knowledge_id  INTEGER NOT NULL,
    agent_id      TEXT NOT NULL,
    vote          TEXT NOT NULL,        -- 'agree' | 'disagree' | 'uncertain'
    reason        TEXT,
    voted_at      TEXT DEFAULT (datetime('now')),
    PRIMARY KEY (knowledge_id, agent_id)
);

-- è®¿é—®æ—¥å¿—
CREATE TABLE knowledge_access_log (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    knowledge_id  INTEGER NOT NULL,
    agent_id      TEXT NOT NULL,
    access_type   TEXT NOT NULL,        -- 'read' | 'cite' | 'update'
    was_useful    INTEGER,              -- 1=æœ‰ç”¨, 0=æ— ç”¨, NULL=æœªåé¦ˆ
    accessed_at   TEXT DEFAULT (datetime('now'))
);
```

### 14.3 API ç«¯ç‚¹

```
POST   /api/shared-knowledge/publish     å‘å¸ƒæ–°çŸ¥è¯†
GET    /api/shared-knowledge/query       ç»Ÿä¸€æŸ¥è¯¢ (è·¨æ‰€æœ‰æº)
POST   /api/shared-knowledge/vote        æŠ•ç¥¨ (å…±è¯†)
GET    /api/shared-knowledge/feed        æœ€è¿‘çŸ¥è¯† (åˆ†é¡µ)
GET    /api/shared-knowledge/agent/:id   æŸ Agent è´¡çŒ®
GET    /api/shared-knowledge/stats       ç»Ÿè®¡
DELETE /api/shared-knowledge/:id         åˆ é™¤/åºŸå¼ƒ
```

### 14.4 ç»Ÿä¸€æŸ¥è¯¢ â€” å¹¶è¡Œæœç´¢æ‰€æœ‰æº

```python
async def unified_query(q: str, sources: str = "all") -> List[Result]:
    """å¹¶è¡Œæœç´¢æ‰€æœ‰çŸ¥è¯†æº, æŒ‰ relevance_score æ’åºè¿”å›ã€‚"""
    tasks = []

    if sources in ("all", "shared"):
        tasks.append(search_shared_knowledge(q))     # shared_knowledge_fts

    if sources in ("all", "memory"):
        tasks.append(search_memory(q))                # messages_fts + observations_fts

    if sources in ("all", "notebooklm"):
        tasks.append(search_notebooklm(q))            # ccb-knowledge query

    if sources in ("all", "obsidian"):
        tasks.append(search_obsidian(q))              # Obsidian vault æœç´¢

    results = await asyncio.gather(*tasks, return_exceptions=True)
    merged = [r for batch in results if isinstance(batch, list) for r in batch]
    merged.sort(key=lambda x: x.get("relevance_score", 0), reverse=True)
    return merged
```

### 14.5 ç½®ä¿¡åº¦ç®—æ³•

```python
def update_confidence(knowledge_id):
    votes = get_votes(knowledge_id)
    access = get_access_log(knowledge_id)

    # æŠ•ç¥¨å› å­
    vote_score = sum(
        0.1 if v.vote == "agree" else -0.2 if v.vote == "disagree" else 0
        for v in votes
    )

    # ä½¿ç”¨å› å­ (è¢«å¼•ç”¨è¶Šå¤šè¶Šå¯ä¿¡)
    cite_count = sum(1 for a in access if a.access_type == "cite")
    use_score = min(cite_count * 0.05, 0.3)

    # æ—¶é—´è¡°å‡ (æ¯ 30 å¤© -0.05)
    age_days = (now() - knowledge.created_at).days
    decay = max(-0.5, -(age_days // 30) * 0.05)

    confidence = clamp(0.5 + vote_score + use_score + decay, 0.0, 1.0)
    return confidence
```

---

## 15. æ¨¡å— B: Skill/MCP æ™ºèƒ½è·¯ç”±

### 15.1 é—®é¢˜

| èµ„æº | æ•°é‡ | å½“å‰å‘ç°æ–¹å¼ | ç—›ç‚¹ |
|------|------|-------------|------|
| æœ¬åœ° Skills | 68 | scan-skills.sh | è¦è®°ä½åå­—/triggers |
| MCP Tools | 60+ | è¿è¡Œæ—¶å¯è§ | ä¸çŸ¥é“æœ‰ä»€ä¹ˆ |
| å¯è£… MCP | 15 | .mcp.json | éœ€æ‰‹åŠ¨å®‰è£… |
| è¿œç¨‹ Skills | skills.sh | npx skills find | éœ€çŸ¥é“æœä»€ä¹ˆ |

**ç›®æ ‡**: ç”¨æˆ·è¯´"æˆ‘è¦åš X" â†’ ç³»ç»Ÿè‡ªåŠ¨æ¨èæœ€ä½³å·¥å…· â†’ ä¸€é”®æ¿€æ´»

### 15.2 ç»Ÿä¸€ç´¢å¼•

```
~/.claude/skills/skill-router/
â”œâ”€â”€ SKILL.md           â† æŠ€èƒ½å®šä¹‰
â”œâ”€â”€ index.json         â† ç»Ÿä¸€ç´¢å¼• (4 æº: local skills + MCP active + MCP marketplace + remote)
â”œâ”€â”€ build-index.sh     â† ç´¢å¼•æ„å»º (æ‰«æ 4 ä¸ªæ¥æº)
â”œâ”€â”€ router.py          â† åŒ¹é…ç®—æ³•
â””â”€â”€ usage-stats.json   â† ä½¿ç”¨åé¦ˆ
```

**index.json æ¡ç›®æ ¼å¼**:

```json
{
    "id": "skill:pdf",
    "type": "skill",            // skill | mcp-tool | mcp-server | remote-skill
    "name": "pdf",
    "description": "PDF toolkit...",
    "keywords": ["pdf", "extract", "merge"],
    "triggers": ["pdf", "PDF"],
    "source": "local",          // local | mcp-active | marketplace | skills.sh
    "status": "installed",      // installed | active | available
    "activate": "/pdf",         // å¦‚ä½•æ¿€æ´»
    "install_cmd": null          // å¦‚ä½•å®‰è£… (æœªå®‰è£…æ—¶)
}
```

### 15.3 åŒ¹é…ç®—æ³•

```python
def match_score(entry, keywords, usage):
    score = 0.0

    for kw in keywords:
        if kw in entry.triggers:       score += 3.0   # ç²¾ç¡® trigger
        if kw in entry.keywords:       score += 2.0   # ç²¾ç¡® keyword
        if kw in entry.name:           score += 2.0   # åç§°åŒ…å«
        if kw in entry.description:    score += 1.0   # æè¿°åŒ…å«

    # çŠ¶æ€åŠ åˆ†
    if entry.status == "active":       score += 1.5
    elif entry.status == "installed":  score += 1.0

    # å†å²ä½¿ç”¨åŠ åˆ† (max +1.0)
    score += min(usage.get(entry.id, {}).get("count", 0) * 0.1, 1.0)

    return score
```

### 15.4 ä¸­è‹±å…³é”®è¯æ˜ å°„

```python
cn_map = {
    "å‰ç«¯": ["frontend", "react", "vue", "css", "html", "ui"],
    "åç«¯": ["backend", "api", "server", "database"],
    "æµ‹è¯•": ["test", "testing", "e2e", "playwright"],
    "éƒ¨ç½²": ["deploy", "docker", "ci", "cd"],
    "æ–‡æ¡£": ["doc", "documentation", "readme", "markdown"],
    "æ•°æ®": ["data", "analysis", "sql", "csv", "excel"],
    "æµè§ˆå™¨": ["browser", "playwright", "selenium", "web"],
    "PDF":  ["pdf", "extract", "merge"],
    "çŸ¥è¯†åº“": ["knowledge", "notebooklm", "obsidian"],
    "ç ”ç©¶": ["research", "notebooklm"],
    "GitHub": ["github", "pr", "issue", "repo"],
    "å®‰å…¨": ["security", "vulnerability", "audit"],
}
```

### 15.5 API ç«¯ç‚¹

```
GET  /api/tool-router/search?q=...    æœç´¢åŒ¹é…å·¥å…·
POST /api/tool-router/rebuild-index   é‡å»ºç´¢å¼•
GET  /api/tool-router/stats           ç´¢å¼•ç»Ÿè®¡
POST /api/tool-router/feedback        ä½¿ç”¨åé¦ˆ (å­¦ä¹ )
GET  /api/tool-router/index           æŸ¥çœ‹å®Œæ•´ç´¢å¼•
```

---

## 16. A+B è”åŠ¨

### 16.1 çŸ¥è¯†é©±åŠ¨çš„å·¥å…·æ¨è

```python
async def enhanced_find_tools(query):
    # 1. ç´¢å¼•åŒ¹é…
    candidates = find_tools(query, top_k=10)

    # 2. æŸ¥å…±äº«çŸ¥è¯†: "ä¹‹å‰ç”¨ä»€ä¹ˆå·¥å…·åšè¿‡ç±»ä¼¼çš„äº‹?"
    knowledge = await query_shared_knowledge(
        f"tool recommendation for: {query}",
        category="tool-usage"
    )

    # 3. å†å²ç»éªŒåŠ åˆ†
    for k in knowledge:
        for c in candidates:
            if c["name"] in k["content"]:
                c["_score"] += 2.0

    return sorted(candidates, key=lambda x: x["_score"], reverse=True)[:5]
```

### 16.2 å·¥å…·ä½¿ç”¨åè‡ªåŠ¨å‘å¸ƒ

```python
async def after_tool_use(tool_id, task, success):
    if success:
        await publish_knowledge(
            agent_id="claude",
            category="tool-usage",
            topic=f"tool:{tool_id}",
            content=f"ç”¨ {tool_id} æˆåŠŸå®Œæˆ: {task}",
        )
        update_usage_stats(tool_id, success=True)
```

### 16.3 è·¨ Agent å·¥å…·å‘ç°ç¤ºä¾‹

```
Agent A (Kimi): "æˆ‘éœ€è¦åš PDF OCR"
  â”‚
  â”œâ”€â”€ skill-router æœç´¢ â†’ "pdf" skill + "mineru"
  â”œâ”€â”€ æŸ¥å…±äº«çŸ¥è¯† â†’ "Claude ä¹‹å‰ç”¨ pdf-to-notebook --method mineru æˆåŠŸå¤„ç†æ‰«æä»¶"
  â”‚
  â””â”€â”€ æ¨è: pdf-to-notebook --method mineru (é™„å¸¦å†å²ç»éªŒ)
```

---

## 17. v1.1 å®æ–½è®¡åˆ’

| Phase | å†…å®¹ | æ–°å¢ä»£ç  | æ—¶é—´ |
|-------|------|----------|------|
| Phase 1 | å…±äº«çŸ¥è¯†è¡¨ + åŸºç¡€ API (4 è¡¨ + 7 ç«¯ç‚¹) | ~400 è¡Œ | 2-3h |
| Phase 2 | ç»Ÿä¸€æŸ¥è¯¢å±‚ (å¹¶è¡Œæœç´¢ 4 æº) | ~300 è¡Œ | 2h |
| Phase 3 | Skill/MCP ç´¢å¼•æ„å»º (build-index.sh + router.py) | ~300 è¡Œ | 2h |
| Phase 4 | Gateway é›†æˆ (5 ç«¯ç‚¹ + åé¦ˆ) | ~250 è¡Œ | 1-2h |
| Phase 5 | A+B è”åŠ¨ (çŸ¥è¯†å¢å¼º + è‡ªåŠ¨å‘å¸ƒ) | ~130 è¡Œ | 1h |
| Phase 6 | CLI å·¥å…· (ccb-knowledge shared + ccb-tools) | ~130 è¡Œ | 1h |
| **æ€»è®¡** | | **~1,510 è¡Œ** | **~10h** |

### éªŒæ”¶æ ‡å‡†

**å…±äº«çŸ¥è¯†**:
- 9 ä¸ª Agent æ³¨å†Œåˆ° agents è¡¨
- Agent å¯å‘å¸ƒ/æŸ¥è¯¢/æŠ•ç¥¨çŸ¥è¯†
- ç»Ÿä¸€æŸ¥è¯¢è·¨ Memory + NotebookLM + Obsidian + Shared
- ç½®ä¿¡åº¦éšæŠ•ç¥¨å’Œæ—¶é—´åŠ¨æ€å˜åŒ–

**å·¥å…·è·¯ç”±**:
- index.json åŒ…å« 68+ skills + 15+ MCP servers
- æœç´¢å‡†ç¡®ç‡ > 80% (å‰ 3 ç»“æœåŒ…å«æ­£ç¡®å·¥å…·)
- å·²å®‰è£…ä¼˜å…ˆ, ä½¿ç”¨åé¦ˆå½±å“æ’åº
- `ccb-tools search "PDF OCR"` è¿”å›æ­£ç¡®ç»“æœ

**è”åŠ¨**:
- å·¥å…·ä½¿ç”¨åè‡ªåŠ¨è®°å½•å…±äº«çŸ¥è¯†
- å†å²ç»éªŒå½±å“å·¥å…·æ¨è

---

# Part IV: å½“å‰é™åˆ¶ä¸æœªæ¥

---

## 18. å·®è·åˆ†æ

### 18.1 ç³»ç»Ÿéš”ç¦»

| å·®è· | å½±å“ | è§£å†³ç‰ˆæœ¬ |
|------|------|----------|
| ä¸‰åº“éš”ç¦» | Memory/Knowledge/Gateway æ— æ³•è·¨åº“æŸ¥è¯¢ | v1.0 (ç»Ÿä¸€ DB) + v1.1 (ç»Ÿä¸€æŸ¥è¯¢) |
| æ—  agent_id | è®°å¿†æ— æ³•åŒºåˆ† Agent è´¡çŒ® | v1.1 (agents è¡¨) |
| Knowledge ä¸æŸ¥ Memory | çŸ¥è¯†è·¯ç”±ä¸çŸ¥é“å†å²å¯¹è¯ | v1.1 (unified_query) |
| Memory ä¸æŸ¥ Knowledge | è®°å¿†æ£€ç´¢ä¸çŸ¥é“ NotebookLM | v1.1 (unified_query) |

### 18.2 æŠ€æœ¯é™åˆ¶

| é™åˆ¶ | å½±å“ | æ–¹å‘ |
|------|------|------|
| FTS5 Porter åˆ†è¯ | ä¸­æ–‡åˆ†è¯è´¨é‡ä¸€èˆ¬ | è€ƒè™‘ jieba åˆ†è¯å™¨ |
| å‘é‡æœç´¢æœªé»˜è®¤å¯ç”¨ | ä»… FTS5 å¯ç”¨ | éƒ¨ç½² Qdrant/Chroma |
| Ollama å¿…é¡»è¿è¡Œ | å…³é”®è¯æå–ä¾èµ– | regex é™çº§å·²å®ç° |
| NotebookLM é™æµ | é«˜é¢‘æŸ¥è¯¢è¢«æ‹’ | ç¼“å­˜ + é˜Ÿåˆ— |
| Obsidian ä»…æ–‡ä»¶æœç´¢ | æ— è¯­ä¹‰ç†è§£ | å‘é‡åŒ–ç¬”è®° |
| å…³é”®è¯åŒ¹é…ç®€å• | LIKE æ¨¡ç³ŠåŒ¹é… | è¯­ä¹‰å‘é‡åŒ¹é… |
| ç¼“å­˜ TTL å›ºå®š 24h | æ— æ³•æŒ‰éœ€è°ƒæ•´ | åˆ†ç±» TTL |

---

## 19. ç‰ˆæœ¬è·¯çº¿å›¾

```
v0.26.0 (å½“å‰)
  â”‚
  â”‚  â”Œâ”€â”€â”€ v1.0 ä¼˜åŒ–é‡æ„ (Codex æ‰§è¡Œä¸­) â”€â”€â”€â”
  â”‚  â”‚ Phase 1: common/ åŸºç¡€è®¾æ–½           â”‚
  â”‚  â”‚ Phase 2: gateway_api.py æ‹†åˆ†        â”‚
  â”‚  â”‚ Phase 3: Provider é€šä¿¡ç»Ÿä¸€           â”‚
  â”‚  â”‚ Phase 4: Backend é‡æ„               â”‚
  â”‚  â”‚ Phase 5: æ•°æ®åº“ç»Ÿä¸€                  â”‚
  â”‚  â”‚ Phase 6: æµ‹è¯•è¡¥å……                    â”‚
  â”‚  â”‚ Phase 7: æ¸…ç†                       â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
v1.0.0 (æµ‹è¯•é€šè¿‡)
  â”‚
  â”‚  â”Œâ”€â”€â”€ v1.1 çŸ¥è¯† + è·¯ç”± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ Phase 1: å…±äº«çŸ¥è¯†è¡¨ + API           â”‚
  â”‚  â”‚ Phase 2: ç»Ÿä¸€æŸ¥è¯¢å±‚                  â”‚
  â”‚  â”‚ Phase 3: Skill/MCP ç´¢å¼•             â”‚
  â”‚  â”‚ Phase 4: Gateway é›†æˆ               â”‚
  â”‚  â”‚ Phase 5: A+B è”åŠ¨                   â”‚
  â”‚  â”‚ Phase 6: CLI å·¥å…·                   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
v1.1.0
  â”‚
  â”‚  â”Œâ”€â”€â”€ v1.2 (è§„åˆ’ä¸­) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚ â€¢ å‘é‡æœç´¢é»˜è®¤å¯ç”¨ (Qdrant)        â”‚
  â”‚  â”‚ â€¢ ä¸­æ–‡åˆ†è¯ä¼˜åŒ– (jieba)             â”‚
  â”‚  â”‚ â€¢ Obsidian ç¬”è®°å‘é‡åŒ–              â”‚
  â”‚  â”‚ â€¢ è¯­ä¹‰ Skill/MCP åŒ¹é…             â”‚
  â”‚  â”‚ â€¢ å¤š Agent åä½œåè®®                â”‚
  â”‚  â”‚ â€¢ WebUI çŸ¥è¯†ç®¡ç†ç•Œé¢               â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
v1.2.0
```

---

## 20. å…³é”®æ–‡ä»¶ç´¢å¼•

### è®°å¿†ç³»ç»Ÿ

| æ–‡ä»¶ | è¡Œæ•° | ç”¨é€” |
|------|------|------|
| `lib/memory/memory_v2.py` | ~1820 | ä¸»æ¥å£ (CRUD + æœç´¢ + å½’æ¡£) |
| `lib/memory/heuristic_retriever.py` | ~753 | å¯å‘å¼æ£€ç´¢ (Î±R+Î²I+Î³T) |
| `lib/memory/vector_search.py` | ~740 | å‘é‡æœç´¢ (Qdrant/ChromaDB/InMemory) |
| `lib/memory/consolidator.py` | ~800+ | System 2 å¤œé—´æ•´åˆ |
| `lib/memory/ARCHITECTURE.md` | ~294 | è®°å¿†æ¶æ„æ–‡æ¡£ |

### çŸ¥è¯†ç³»ç»Ÿ

| æ–‡ä»¶ | è¡Œæ•° | ç”¨é€” |
|------|------|------|
| `lib/knowledge/router.py` | ~300 | çŸ¥è¯†è·¯ç”±å™¨ (NotebookLM + Obsidian) |
| `bin/pdf-to-notebook` | ~428 | PDF å…¨è‡ªåŠ¨ pipeline |
| `bin/notebooklm` | ~600 | NotebookLM CLI |

### Gateway

| æ–‡ä»¶ | è¡Œæ•° | ç”¨é€” |
|------|------|------|
| `lib/gateway/gateway_api.py` | ~3917 | API æ ¸å¿ƒ (v1.0 å°†æ‹†åˆ†) |
| `lib/gateway/middleware/memory_middleware.py` | ~800 | è®°å¿†ä¸­é—´ä»¶ (Ollama + æ³¨å…¥) |
| `lib/gateway/router.py` | ~477 | æ™ºèƒ½è·¯ç”± |
| `lib/gateway/retry.py` | ~580 | é‡è¯•/é™çº§ |
| `lib/gateway/health_checker.py` | ~313 | å¥åº·æ£€æŸ¥ |

### è§„æ ¼ä¹¦

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `docs/HIVEMIND_V1_OPTIMIZATION_SPEC.md` | v1.0 ä¼˜åŒ–è§„æ ¼ (994 è¡Œ) |
| `docs/HIVEMIND_V1.1_KNOWLEDGE_ROUTER_SPEC.md` | v1.1 çŸ¥è¯†+è·¯ç”±è§„æ ¼ (797 è¡Œ) |
| `docs/HIVEMIND_ARCHITECTURE_AND_ROADMAP.md` | **æœ¬æ–‡æ¡£** |
