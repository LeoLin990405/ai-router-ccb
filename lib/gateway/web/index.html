<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCB Gateway Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root, .dark {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #16161f;
            --bg-elevated: #1a1a25;
            --border-subtle: rgba(255,255,255,0.06);
            --border-accent: rgba(99,102,241,0.3);
            --text-primary: #f0f0f5;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-cyan: #22d3ee;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --glow-primary: rgba(99,102,241,0.15);
        }

        .light {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-elevated: #ffffff;
            --border-subtle: rgba(0,0,0,0.08);
            --border-accent: rgba(99,102,241,0.4);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --glow-primary: rgba(99,102,241,0.1);
        }

        .light .bg-mesh {
            background:
                radial-gradient(ellipse at 20% 0%, rgba(99,102,241,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(139,92,246,0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 0% 50%, rgba(34,211,238,0.03) 0%, transparent 50%),
                var(--bg-primary);
        }

        .light .glass-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .light .stat-card {
            background: var(--bg-card);
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }

        .light .stat-card .text-3xl {
            color: var(--text-primary) !important;
        }

        .light .modal-content {
            background: var(--bg-card);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .light .input-field {
            background: var(--bg-secondary);
            border-color: var(--border-subtle);
            color: var(--text-primary);
        }

        .light .data-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .light .data-table td {
            color: var(--text-primary);
        }

        .light .data-table tr:hover {
            background: var(--bg-secondary);
        }

        .light .provider-card {
            background: var(--bg-secondary);
        }

        .light .activity-item {
            border-color: var(--border-subtle);
        }

        .light pre {
            background: var(--bg-secondary) !important;
            color: var(--text-primary);
        }

        .light .text-white {
            color: var(--text-primary) !important;
        }

        .light .text-gray-400, .light .text-gray-500 {
            color: var(--text-secondary) !important;
        }

        .light .text-gray-300, .light .text-gray-600 {
            color: var(--text-muted) !important;
        }

        .light .nav-tab {
            color: var(--text-secondary);
        }

        .light .nav-tab.active {
            color: var(--accent-primary);
            background: rgba(99,102,241,0.1);
        }

        .light .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .light .font-mono {
            color: var(--text-primary);
        }

        .light .bg-gray-900\\/50, .light .bg-gray-800 {
            background: var(--bg-secondary) !important;
        }
        
        * { font-family: 'Outfit', sans-serif; }
        code, pre, .font-mono { font-family: 'JetBrains Mono', monospace; }
        [v-cloak] { display: none; }
        
        body { background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        .bg-mesh {
            background: 
                radial-gradient(ellipse at 20% 0%, rgba(99,102,241,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(139,92,246,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 0% 50%, rgba(34,211,238,0.04) 0%, transparent 50%),
                var(--bg-primary);
        }
        
        .glass-card {
            background: linear-gradient(135deg, rgba(22,22,31,0.9) 0%, rgba(26,26,37,0.8) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:hover {
            border-color: var(--border-accent);
            box-shadow: 0 0 40px var(--glow-primary);
            transform: translateY(-2px);
        }
        
        .stat-card {
            position: relative;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 1px;
            background: linear-gradient(135deg, var(--gradient-from), var(--gradient-to));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .stat-card:hover::before { opacity: 1; }
        .stat-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 20px 40px -20px var(--glow-color); }
        
        .stat-card.blue { --gradient-from: #6366f1; --gradient-to: #8b5cf6; --glow-color: rgba(99,102,241,0.3); }
        .stat-card.amber { --gradient-from: #f59e0b; --gradient-to: #ef4444; --glow-color: rgba(245,158,11,0.3); }
        .stat-card.purple { --gradient-from: #8b5cf6; --gradient-to: #ec4899; --glow-color: rgba(139,92,246,0.3); }
        .stat-card.emerald { --gradient-from: #10b981; --gradient-to: #22d3ee; --glow-color: rgba(16,185,129,0.3); }
        .stat-card.cyan { --gradient-from: #22d3ee; --gradient-to: #6366f1; --glow-color: rgba(34,211,238,0.3); }
        .stat-card.rose { --gradient-from: #f43f5e; --gradient-to: #f59e0b; --glow-color: rgba(244,63,94,0.3); }
        
        .nav-tab {
            position: relative;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: 12px;
            transition: all 0.3s;
        }
        .nav-tab:hover { color: var(--text-primary); background: rgba(99,102,241,0.1); }
        .nav-tab.active {
            color: var(--text-primary);
            background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(139,92,246,0.1));
            border: 1px solid var(--border-accent);
        }
        
        .provider-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s;
        }
        .provider-card:hover { border-color: var(--border-accent); box-shadow: 0 0 30px var(--glow-primary); }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; }
        
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px currentColor; } 50% { box-shadow: 0 0 20px currentColor; } }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-in { animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes fadeUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fade-up { animation: fadeUp 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .stagger-children > * { animation: fadeUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) backwards; }
        .stagger-children > *:nth-child(1) { animation-delay: 0.05s; }
        .stagger-children > *:nth-child(2) { animation-delay: 0.1s; }
        .stagger-children > *:nth-child(3) { animation-delay: 0.15s; }
        .stagger-children > *:nth-child(4) { animation-delay: 0.2s; }
        .stagger-children > *:nth-child(5) { animation-delay: 0.25s; }
        .stagger-children > *:nth-child(6) { animation-delay: 0.3s; }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white; padding: 0.5rem 1.25rem; border-radius: 10px; font-weight: 500;
            transition: all 0.3s; border: none; cursor: pointer;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px -10px var(--accent-primary); }
        
        .btn-secondary {
            background: var(--bg-elevated); color: var(--text-primary);
            padding: 0.5rem 1.25rem; border-radius: 10px; font-weight: 500;
            transition: all 0.3s; border: 1px solid var(--border-subtle); cursor: pointer;
        }
        .btn-secondary:hover { border-color: var(--border-accent); background: var(--bg-card); }
        
        .input-field {
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: 10px; padding: 0.625rem 1rem; color: var(--text-primary);
            transition: all 0.3s; width: 100%;
        }
        .input-field:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--glow-primary); }
        .input-field::placeholder { color: var(--text-muted); }

        .toggle-switch {
            position: relative; width: 44px; height: 24px;
            background: var(--bg-secondary); border-radius: 12px;
            cursor: pointer; transition: all 0.3s;
        }
        .toggle-switch.active { background: linear-gradient(135deg, var(--accent-emerald), var(--accent-cyan)); }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 20px; height: 20px; background: white; border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .toggle-switch.active::after { transform: translateX(20px); }

        /* Monitor output styles */
        .monitor-output {
            background: rgba(0,0,0,0.3);
            scrollbar-width: thin;
            scrollbar-color: var(--border-subtle) transparent;
        }
        .monitor-output::-webkit-scrollbar { width: 6px; }
        .monitor-output::-webkit-scrollbar-track { background: transparent; }
        .monitor-output::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }
        .monitor-output::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        .monitor-line-info { color: var(--accent-cyan); }
        .monitor-line-error { color: var(--accent-rose); }
        .monitor-line-success { color: var(--accent-emerald); }
        .monitor-line-thinking { color: var(--accent-amber); opacity: 0.8; }
        .monitor-line-default { color: var(--text-primary); }

        @keyframes loading-bar {
            0% { width: 0%; margin-left: 0; }
            50% { width: 60%; margin-left: 20%; }
            100% { width: 0%; margin-left: 100%; }
        }
        .animate-loading-bar { animation: loading-bar 1.5s ease-in-out infinite; }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.375rem; }
        .badge-success { background: rgba(16,185,129,0.15); color: #10b981; }
        .badge-warning { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .badge-error { background: rgba(244,63,94,0.15); color: #f43f5e; }
        .badge-info { background: rgba(99,102,241,0.15); color: #6366f1; }
        
        .modal-backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th { text-align: left; padding: 1rem; color: var(--text-muted); font-weight: 500; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border-subtle); }
        .data-table td { padding: 1rem; border-bottom: 1px solid var(--border-subtle); transition: background 0.2s; }
        .data-table tr:hover td { background: rgba(99,102,241,0.05); }
        
        .activity-log { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; max-height: 300px; overflow-y: auto; }
        .log-entry { padding: 0.5rem 0; border-bottom: 1px solid var(--border-subtle); font-size: 0.8125rem; font-family: 'JetBrains Mono', monospace; }
        .log-entry:last-child { border-bottom: none; }
        
        .chart-container { background: var(--bg-secondary); border-radius: 12px; padding: 1rem; }
        .kbd { background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 6px; padding: 0.25rem 0.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); }
        
        .light-theme {
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-card: #ffffff;
            --bg-elevated: #f1f5f9; --border-subtle: rgba(0,0,0,0.08);
            --border-accent: rgba(99,102,241,0.4); --text-primary: #1e293b;
            --text-secondary: #64748b; --text-muted: #94a3b8; --glow-primary: rgba(99,102,241,0.1);
        }
        .light-theme .bg-mesh {
            background: radial-gradient(ellipse at 20% 0%, rgba(99,102,241,0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(139,92,246,0.04) 0%, transparent 50%), var(--bg-primary);
        }
        .light-theme .glass-card { background: rgba(255,255,255,0.9); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .light-theme .stat-card { background: var(--bg-card); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="min-h-screen bg-mesh transition-colors duration-500">
    <div id="app" v-cloak :class="theme">
        <!-- Header -->
        <header class="sticky top-0 z-40 backdrop-blur-xl bg-opacity-80" :class="theme === 'light' ? 'bg-white/80' : 'bg-[#0a0a0f]/80'" style="border-bottom: 1px solid var(--border-subtle);">
            <div class="max-w-[1800px] mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                                <i class="fas fa-bolt text-white text-lg"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">CCB Gateway</h1>
                                <p class="text-xs" :class="theme === 'light' ? 'text-gray-600' : 'text-gray-500'">{{ t('multiAiOrchestrator') }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 px-3 py-1.5 rounded-full"
                             :class="connected ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-rose-500/10 border border-rose-500/30'">
                            <span class="w-2 h-2 rounded-full" :class="connected ? 'bg-emerald-400 pulse-glow text-emerald-400' : 'bg-rose-400'"></span>
                            <span class="text-sm font-medium" :class="connected ? 'text-emerald-400' : 'text-rose-400'">
                                {{ connected ? t('connected') : t('disconnected') }}
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-500 hidden md:block"><i class="fas fa-clock mr-1"></i>{{ formatDuration(status.gateway?.uptime_s || 0) }}</span>
                        <div class="h-4 w-px bg-gray-700 hidden md:block"></div>
                        <button @click="showWarmupModal = true" class="px-3 py-1.5 rounded-lg bg-amber-500/10 border border-amber-500/30 text-amber-400 text-sm font-medium hover:bg-amber-500/20 transition-colors flex items-center space-x-2" :title="t('warmupAll')">
                            <i class="fas fa-fire"></i>
                            <span class="hidden md:inline">{{ t('warmup') }}</span>
                        </button>
                        <button @click="toggleTheme" class="p-2.5 rounded-xl hover:bg-white/5 transition-colors" :title="t('toggleTheme')">
                            <i :class="theme === 'dark' ? 'fas fa-sun text-amber-400' : 'fas fa-moon text-indigo-400'" class="text-lg"></i>
                        </button>
                        <button @click="showShortcuts = true" class="p-2.5 rounded-xl hover:bg-white/5 transition-colors"><i class="fas fa-keyboard text-gray-400"></i></button>
                        <button @click="showAlertSettings = true" class="p-2.5 rounded-xl hover:bg-white/5 transition-colors"><i class="fas fa-bell text-gray-400"></i></button>
                        <button @click="exportData" class="p-2.5 rounded-xl hover:bg-white/5 transition-colors"><i class="fas fa-download text-gray-400"></i></button>
                        <button @click="toggleLang" class="px-3 py-1.5 rounded-lg bg-indigo-500/10 border border-indigo-500/30 text-indigo-400 text-sm font-medium hover:bg-indigo-500/20 transition-colors">
                            {{ lang === 'en' ? '中文' : 'EN' }}
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="sticky top-[73px] z-30 backdrop-blur-xl" :class="theme === 'light' ? 'bg-white/60' : 'bg-[#0a0a0f]/60'" style="border-bottom: 1px solid var(--border-subtle);">
            <div class="max-w-[1800px] mx-auto px-6 py-3">
                <div class="flex space-x-2">
                    <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id" :class="['nav-tab', activeTab === tab.id ? 'active' : '']">
                        <span class="flex items-center space-x-2"><span v-html="tab.icon"></span><span>{{ t(tab.id) }}</span></span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-[1800px] mx-auto px-6 py-8">
            <!-- Dashboard Tab -->
            <div v-show="activeTab === 'dashboard'" class="space-y-8">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-5 stagger-children">
                    <div class="stat-card blue">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-indigo-400 text-sm font-medium">{{ t('totalRequests') }}</span>
                            <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center"><i class="fas fa-paper-plane text-indigo-400 text-sm"></i></div>
                        </div>
                        <div class="text-3xl font-bold text-white mb-1">{{ formatNumber(status.gateway?.total_requests || 0) }}</div>
                        <div class="text-xs text-gray-500">{{ t('allTime') }}</div>
                    </div>
                    <div class="stat-card amber">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-amber-400 text-sm font-medium">{{ t('active') }}</span>
                            <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center"><i class="fas fa-spinner fa-spin text-amber-400 text-sm"></i></div>
                        </div>
                        <div class="text-3xl font-bold text-white mb-1">{{ status.gateway?.active_requests || 0 }}</div>
                        <div class="text-xs text-gray-500">{{ t('processingNow') }}</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-purple-400 text-sm font-medium">{{ t('queue') }}</span>
                            <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center"><i class="fas fa-layer-group text-purple-400 text-sm"></i></div>
                        </div>
                        <div class="text-3xl font-bold text-white mb-1">{{ status.gateway?.queue_depth || 0 }}</div>
                        <div class="text-xs text-gray-500">{{ t('waiting') }}</div>
                    </div>
                    <div class="stat-card emerald">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-emerald-400 text-sm font-medium">{{ t('cacheHit') }}</span>
                            <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center"><i class="fas fa-database text-emerald-400 text-sm"></i></div>
                        </div>
                        <div class="text-3xl font-bold text-white mb-1">{{ formatPercent(status.gateway?.cache?.hit_rate || 0) }}</div>
                        <div class="text-xs text-gray-500">{{ status.gateway?.cache?.hits || 0 }} {{ t('hits') }}</div>
                    </div>
                    <div class="stat-card cyan">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-cyan-400 text-sm font-medium">{{ t('providers') }}</span>
                            <div class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center"><i class="fas fa-server text-cyan-400 text-sm"></i></div>
                        </div>
                        <div class="text-3xl font-bold text-white mb-1">{{ healthyProviders }}/{{ status.providers?.length || 0 }}</div>
                        <div class="text-xs text-gray-500">{{ t('healthy') }}</div>
                    </div>
                    <div class="stat-card rose">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-rose-400 text-sm font-medium">{{ t('tokenUsage') }}</span>
                            <div class="w-8 h-8 rounded-lg bg-rose-500/20 flex items-center justify-center"><i class="fas fa-coins text-rose-400 text-sm"></i></div>
                        </div>
                        <div class="text-3xl font-bold text-white mb-1">{{ formatNumber(totalTokens) }}</div>
                        <div class="text-xs text-gray-500">{{ formatNumber(totalInputTokens) }} in / {{ formatNumber(totalOutputTokens) }} out</div>
                    </div>
                </div>

                <!-- Token Usage by Provider -->
                <div class="glass-card p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center"><i class="fas fa-chart-bar text-amber-400 mr-3"></i>{{ t('tokensByProvider') }}</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div v-for="provider in sortedProviders" :key="provider.name" class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg">{{ getProviderTierIcon(provider.name) }}</span>
                                    <span class="font-medium text-white">{{ provider.name }}</span>
                                </div>
                                <span :class="getStatusBadgeClass(provider.status)" class="text-xs px-2 py-0.5 rounded-full border">{{ provider.status }}</span>
                            </div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">{{ t('inputTokens') }}:</span>
                                    <span class="text-emerald-400 font-mono">{{ formatNumber(provider.total_input_tokens || 0) }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">{{ t('outputTokens') }}:</span>
                                    <span class="text-blue-400 font-mono">{{ formatNumber(provider.total_output_tokens || 0) }}</span>
                                </div>
                                <div class="flex justify-between border-t border-gray-700 pt-1 mt-1">
                                    <span class="text-gray-400">{{ t('total') }}:</span>
                                    <span class="text-white font-mono font-medium">{{ formatNumber((provider.total_input_tokens || 0) + (provider.total_output_tokens || 0)) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold flex items-center"><i class="fas fa-chart-bar text-indigo-400 mr-3"></i>{{ t('latencyDistribution') }}</h2>
                            <span class="badge badge-info">{{ t('last100') }}</span>
                        </div>
                        <div class="chart-container"><canvas ref="latencyChart" height="200"></canvas></div>
                    </div>
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold flex items-center"><i class="fas fa-chart-pie text-purple-400 mr-3"></i>{{ t('statusDistribution') }}</h2>
                            <span class="badge badge-info">{{ t('currentSession') }}</span>
                        </div>
                        <div class="chart-container flex justify-center"><canvas ref="statusChart" height="200" style="max-width: 280px;"></canvas></div>
                    </div>
                </div>

                <!-- Provider Status & Activity -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 glass-card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold flex items-center"><i class="fas fa-server text-cyan-400 mr-3"></i>{{ t('providerStatus') }}</h2>
                            <button @click="fetchStatus" class="btn-secondary text-sm"><i class="fas fa-sync-alt mr-2"></i>{{ t('refresh') }}</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            <div v-for="provider in status.providers" :key="provider.name" class="provider-card">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-lg">{{ getProviderTierIcon(provider.name) }}</span>
                                        <span class="font-semibold text-white">{{ provider.name }}</span>
                                        <span :class="getProviderTierClass(provider.name)" class="text-xs px-2 py-0.5 rounded-full border">{{ getProviderTierLabel(provider.name) }}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span :class="getStatusBadgeClass(provider.status)" class="badge"><span class="w-1.5 h-1.5 rounded-full bg-current"></span>{{ provider.status }}</span>
                                        <div @click="toggleProvider(provider)" :class="['toggle-switch', provider.enabled ? 'active' : '']" :title="provider.enabled ? t('clickToDisable') : t('clickToEnable')"></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div class="flex flex-col"><span class="text-gray-500 text-xs mb-1">{{ t('latency') }}</span><span class="font-medium text-white">{{ formatLatency(provider.avg_latency_ms) }}</span></div>
                                    <div class="flex flex-col"><span class="text-gray-500 text-xs mb-1">{{ t('success') }}</span><span class="font-medium" :class="provider.success_rate >= 0.9 ? 'text-emerald-400' : 'text-amber-400'">{{ formatPercent(provider.success_rate) }}</span></div>
                                    <div class="flex flex-col"><span class="text-gray-500 text-xs mb-1">{{ t('queue') }}</span><span class="font-medium text-white">{{ provider.queue_depth }}</span></div>
                                    <div class="flex flex-col"><span class="text-gray-500 text-xs mb-1">{{ t('requests') }}</span><span class="font-medium text-white">{{ provider.total_requests || 0 }}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold flex items-center"><i class="fas fa-stream text-emerald-400 mr-3"></i>{{ t('activityLog') }}</h2>
                            <button @click="activityLogs = []" class="text-xs text-gray-500 hover:text-white transition-colors">{{ t('clear') }}</button>
                        </div>
                        <div class="activity-log">
                            <div v-for="(log, i) in activityLogs" :key="i" class="log-entry" :class="getLogClass(log.type)">
                                <span class="text-gray-600">[{{ log.time }}]</span><span class="ml-2">{{ log.message }}</span>
                            </div>
                            <div v-if="activityLogs.length === 0" class="text-center py-8 text-gray-600"><i class="fas fa-inbox text-2xl mb-2"></i><p>{{ t('noActivity') }}</p></div>
                        </div>
                    </div>
                </div>

                <!-- Features -->
                <div class="glass-card p-6">
                    <h2 class="text-lg font-semibold flex items-center mb-6"><i class="fas fa-puzzle-piece text-amber-400 mr-3"></i>{{ t('features') }}</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <div v-for="(enabled, feature) in status.gateway?.features" :key="feature" class="flex items-center space-x-3 p-3 rounded-xl" :class="enabled ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-gray-500/10 border border-gray-500/20'">
                            <span :class="enabled ? 'text-emerald-400' : 'text-gray-500'" class="text-lg"><i :class="enabled ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i></span>
                            <span class="text-sm font-medium">{{ formatFeatureName(feature) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monitor Tab - Live AI Output -->
            <div v-show="activeTab === 'monitor'" class="space-y-6">
                <div class="glass-card p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-desktop text-cyan-400 mr-3"></i>{{ t('liveMonitor') }}
                            <span v-if="liveRequests.length > 0" class="ml-3 px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full animate-pulse">
                                {{ liveRequests.length }} {{ t('active') }}
                            </span>
                        </h2>
                        <div class="flex items-center gap-3">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" v-model="monitorAutoScroll" class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-indigo-500">
                                <span class="text-sm text-gray-400">{{ t('autoScroll') }}</span>
                            </label>
                            <button @click="monitorLayout = monitorLayout === 'grid' ? 'focus' : 'grid'" class="btn-secondary text-sm">
                                <i :class="monitorLayout === 'grid' ? 'fas fa-th-large' : 'fas fa-expand'"></i>
                                {{ monitorLayout === 'grid' ? t('gridView') : t('focusView') }}
                            </button>
                            <button @click="clearMonitorStreams" class="btn-secondary text-sm">
                                <i class="fas fa-trash-alt mr-1"></i>{{ t('clear') }}
                            </button>
                        </div>
                    </div>

                    <!-- Live Request Cards -->
                    <div v-if="liveRequests.length > 0" class="mb-6">
                        <h3 class="text-sm font-medium text-gray-400 mb-3">{{ t('processingNow') }}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                            <div v-for="req in liveRequests" :key="req.id"
                                 class="bg-gray-800/50 rounded-lg p-3 border border-indigo-500/30 animate-pulse-slow">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-lg">{{ getProviderTierIcon(req.provider) }}</span>
                                        <span class="font-medium text-white">{{ req.provider }}</span>
                                    </div>
                                    <span class="text-xs text-indigo-400 font-mono">{{ req.id.slice(0, 11) }}</span>
                                </div>
                                <div class="text-xs text-gray-400 truncate">{{ req.message?.slice(0, 50) }}...</div>
                                <div class="mt-2 flex items-center space-x-2">
                                    <div class="flex-1 h-1 bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-indigo-500 rounded-full animate-loading-bar"></div>
                                    </div>
                                    <span class="text-xs text-gray-500">{{ formatDuration((Date.now()/1000) - req.created_at) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Provider Output Panels -->
                    <div v-if="monitorProviders.length > 0" :class="monitorLayout === 'grid' ? 'grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4' : ''">
                        <template v-if="monitorLayout === 'grid'">
                            <div v-for="provider in monitorProviders" :key="provider.name"
                                 class="bg-gray-900/50 rounded-xl border border-gray-700/50 overflow-hidden"
                                 :class="{ 'border-emerald-500/30': provider.hasNewOutput }">
                                <div class="flex items-center justify-between px-4 py-3 bg-gray-800/50 border-b border-gray-700/30">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-lg">{{ getProviderTierIcon(provider.name) }}</span>
                                        <span class="font-semibold text-white">{{ provider.name }}</span>
                                        <span v-if="provider.active" class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span v-if="provider.requestId" class="text-xs text-gray-500 font-mono">{{ provider.requestId }}</span>
                                        <button @click="monitorFocusProvider = provider.name; monitorLayout = 'focus'"
                                                class="text-gray-400 hover:text-white transition-colors" :title="t('focus')">
                                            <i class="fas fa-expand-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="monitor-output h-64 overflow-y-auto p-4 font-mono text-sm"
                                     :ref="el => setMonitorRef(provider.name, el)">
                                    <div v-if="provider.output.length === 0" class="text-center text-gray-600 py-8">
                                        <i class="fas fa-hourglass-half text-2xl mb-2"></i>
                                        <p>{{ t('waitingForOutput') }}</p>
                                    </div>
                                    <div v-for="(line, i) in provider.output" :key="i" class="whitespace-pre-wrap break-words"
                                         :class="getOutputLineClass(line)">{{ line.text }}</div>
                                </div>
                            </div>
                        </template>

                        <!-- Focus View (Single Provider) -->
                        <template v-else>
                            <div v-if="monitorFocusProvider" class="bg-gray-900/50 rounded-xl border border-gray-700/50 overflow-hidden">
                                <div class="flex items-center justify-between px-4 py-3 bg-gray-800/50 border-b border-gray-700/30">
                                    <div class="flex items-center space-x-3">
                                        <button @click="monitorLayout = 'grid'" class="text-gray-400 hover:text-white">
                                            <i class="fas fa-arrow-left"></i>
                                        </button>
                                        <span class="text-xl">{{ getProviderTierIcon(monitorFocusProvider) }}</span>
                                        <span class="text-lg font-semibold text-white">{{ monitorFocusProvider }}</span>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <select v-model="monitorFocusProvider" class="input-field text-sm">
                                            <option v-for="p in monitorProviders" :key="p.name" :value="p.name">{{ p.name }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="monitor-output h-[calc(100vh-400px)] overflow-y-auto p-4 font-mono text-sm"
                                     :ref="el => setMonitorRef(monitorFocusProvider, el)">
                                    <div v-if="getMonitorOutput(monitorFocusProvider).length === 0" class="text-center text-gray-600 py-16">
                                        <i class="fas fa-satellite-dish text-4xl mb-4"></i>
                                        <p class="text-lg">{{ t('waitingForOutput') }}</p>
                                        <p class="text-sm mt-2">{{ t('sendRequestToMonitor') }}</p>
                                    </div>
                                    <div v-for="(line, i) in getMonitorOutput(monitorFocusProvider)" :key="i"
                                         class="whitespace-pre-wrap break-words py-0.5"
                                         :class="getOutputLineClass(line)">{{ line.text }}</div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Empty State - only show when no providers available -->
                    <div v-if="monitorProviders.length === 0"
                         class="text-center py-16 text-gray-500">
                        <i class="fas fa-satellite-dish text-5xl mb-4"></i>
                        <p class="text-lg">{{ t('noActiveStreams') }}</p>
                        <p class="text-sm mt-2">{{ t('sendRequestToMonitor') }}</p>
                    </div>
                </div>
            </div>

            <!-- Memory Tab -->
            <div v-show="activeTab === 'memory'" class="space-y-6">
                <!-- Memory Stats -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="stat-card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">{{ t('totalSessions') }}</div>
                                <div class="text-2xl font-semibold text-white">{{ memoryStats.total_sessions || 0 }}</div>
                            </div>
                            <div class="w-10 h-10 bg-indigo-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-folder-open text-indigo-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">{{ t('totalMessages') }}</div>
                                <div class="text-2xl font-semibold text-white">{{ memoryStats.total_messages || 0 }}</div>
                            </div>
                            <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-comments text-purple-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">{{ t('totalTokensLabel') }}</div>
                                <div class="text-2xl font-semibold text-white">{{ formatNumber(memoryStats.total_tokens || 0) }}</div>
                            </div>
                            <div class="w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-coins text-emerald-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">{{ t('observations') }}</div>
                                <div class="text-2xl font-semibold text-white">{{ observations.length }}</div>
                            </div>
                            <div class="w-10 h-10 bg-amber-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-lightbulb text-amber-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">{{ t('memoryInjections') }}</div>
                                <div class="text-2xl font-semibold text-white">{{ memoryInjections.length }}</div>
                            </div>
                            <div class="w-10 h-10 bg-cyan-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-syringe text-cyan-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memory Sub-tabs & Settings Button -->
                <div class="flex items-center justify-between">
                    <div class="flex space-x-2">
                        <button v-for="(label, key) in t('memorySubTabs')" :key="key"
                                @click="memorySubTab = key"
                                :class="['px-4 py-2 rounded-lg text-sm font-medium transition-colors',
                                         memorySubTab === key ? 'bg-indigo-500/20 text-indigo-400 border border-indigo-500/30' : 'text-gray-400 hover:text-white hover:bg-gray-700/30']">
                            {{ label }}
                        </button>
                    </div>
                    <button @click="showMemoryConfigModal = true; fetchMemoryConfig()" class="btn-secondary text-sm">
                        <i class="fas fa-cog mr-2"></i>{{ t('memorySettings') }}
                    </button>
                </div>

                <!-- Memory Search (always visible) -->
                <div class="glass-card p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">{{ t('searchConversations') }}</label>
                        <div class="flex gap-2">
                            <input v-model="memorySearchQuery" @keyup.enter="searchMemory" type="text"
                                   :placeholder="t('searchMessages')"
                                   class="flex-1 px-4 py-2 bg-gray-900/50 border border-gray-700/50 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500/50">
                            <button @click="searchMemory" class="btn-primary">
                                <i class="fas fa-search mr-2"></i>{{ t('search') }}
                            </button>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div v-if="memorySearchResults.length > 0" class="space-y-2 mt-4">
                        <div class="text-sm text-gray-400 mb-2">{{ t('foundResults') }} {{ memorySearchResults.length }} {{ t('results') }}</div>
                        <div v-for="result in memorySearchResults" :key="result.message_id"
                             class="p-4 bg-gray-900/30 border border-gray-700/30 rounded-lg hover:border-indigo-500/30 cursor-pointer transition-colors"
                             @click="viewSession(result.session_id)">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span :class="['px-2 py-1 text-xs rounded-full', getRoleColor(result.role)]">
                                        {{ result.role }}
                                    </span>
                                    <span v-if="result.provider" class="text-xs text-gray-500">{{ result.provider }}</span>
                                </div>
                                <span class="text-xs text-gray-500">{{ formatDate(result.timestamp) }}</span>
                            </div>
                            <div class="text-sm text-gray-300 line-clamp-2">{{ result.content }}</div>
                        </div>
                    </div>
                </div>

                <!-- Sessions Sub-tab -->
                <div v-show="memorySubTab === 'sessions'" class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-brain text-indigo-400 mr-3"></i>{{ t('recentSessions') }}
                        </h2>
                        <button @click="fetchMemorySessions" class="btn-secondary text-sm">
                            <i class="fas fa-sync mr-2"></i>{{ t('refresh') }}
                        </button>
                    </div>

                    <div v-if="memorySessions.length > 0" class="space-y-3">
                        <div v-for="session in memorySessions" :key="session.session_id"
                             class="p-4 bg-gray-900/30 border border-gray-700/30 rounded-lg hover:border-indigo-500/30 cursor-pointer transition-colors"
                             @click="viewSession(session.session_id)">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-gray-500 font-mono">{{ session.session_id.substring(0, 8) }}...</span>
                                    <span class="text-sm text-gray-300">{{ session.message_count }} messages</span>
                                </div>
                                <span class="text-xs text-gray-500">{{ formatDate(session.last_active) }}</span>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <span v-for="provider in (session.providers_used || '').split(',')" :key="provider"
                                      class="px-2 py-0.5 bg-purple-500/20 text-purple-400 text-xs rounded-full">
                                    {{ provider.trim() }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div v-else class="text-center py-12 text-gray-500">
                        <i class="fas fa-brain text-5xl mb-4"></i>
                        <p class="text-lg">{{ t('noSessionsFound') }}</p>
                        <p class="text-sm mt-2">{{ t('startConversationHint') }}</p>
                    </div>
                </div>

                <!-- Observations Sub-tab -->
                <div v-show="memorySubTab === 'observations'" class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-lightbulb text-amber-400 mr-3"></i>{{ t('observations') }}
                        </h2>
                        <div class="flex gap-2">
                            <button @click="fetchObservations" class="btn-secondary text-sm">
                                <i class="fas fa-sync mr-2"></i>{{ t('refresh') }}
                            </button>
                            <button @click="showAddObservationModal = true; newObservation = { content: '', category: 'insight', tags: '' }" class="btn-primary text-sm">
                                <i class="fas fa-plus mr-2"></i>{{ t('addObservation') }}
                            </button>
                        </div>
                    </div>

                    <div v-if="observations.length > 0" class="space-y-3">
                        <div v-for="obs in observations" :key="obs.observation_id"
                             class="p-4 bg-gray-900/30 border border-gray-700/30 rounded-lg">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span :class="['px-2 py-1 text-xs rounded-full', getCategoryColor(obs.category)]">
                                        {{ t(obs.category) }}
                                    </span>
                                    <span class="text-xs text-gray-500">{{ obs.source || 'manual' }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">{{ formatDate(obs.created_at) }}</span>
                                    <button @click="startEditObservation(obs)" class="text-gray-400 hover:text-indigo-400 text-sm">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="deleteObservation(obs.observation_id)" class="text-gray-400 hover:text-rose-400 text-sm">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-300 whitespace-pre-wrap">{{ obs.content }}</div>
                            <div v-if="obs.tags" class="mt-2 flex flex-wrap gap-1">
                                <span v-for="tag in JSON.parse(obs.tags || '[]')" :key="tag"
                                      class="px-2 py-0.5 bg-gray-700/50 text-gray-400 text-xs rounded-full">
                                    {{ tag }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div v-else class="text-center py-12 text-gray-500">
                        <i class="fas fa-lightbulb text-5xl mb-4"></i>
                        <p class="text-lg">{{ t('noObservations') }}</p>
                    </div>
                </div>

                <!-- Injections Sub-tab -->
                <div v-show="memorySubTab === 'injections'" class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-syringe text-cyan-400 mr-3"></i>{{ t('memoryInjections') }}
                        </h2>
                        <button @click="fetchMemoryInjections" class="btn-secondary text-sm">
                            <i class="fas fa-sync mr-2"></i>{{ t('refresh') }}
                        </button>
                    </div>

                    <div v-if="memoryInjections.length > 0" class="space-y-3">
                        <div v-for="inj in memoryInjections" :key="inj.request_id"
                             class="p-4 bg-gray-900/30 border border-gray-700/30 rounded-lg hover:border-cyan-500/30 cursor-pointer transition-colors"
                             @click="viewInjectionDetails(inj.request_id)">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-gray-500 font-mono">{{ inj.request_id.substring(0, 12) }}...</span>
                                    <span class="text-sm text-cyan-400">{{ JSON.parse(inj.injected_memory_ids || '[]').length }} memories</span>
                                    <span v-if="inj.injected_skills" class="text-sm text-purple-400">{{ JSON.parse(inj.injected_skills || '[]').length }} skills</span>
                                </div>
                                <span class="text-xs text-gray-500">{{ formatDate(inj.injection_timestamp) }}</span>
                            </div>
                        </div>
                    </div>

                    <div v-else class="text-center py-12 text-gray-500">
                        <i class="fas fa-syringe text-5xl mb-4"></i>
                        <p class="text-lg">{{ t('noInjections') }}</p>
                    </div>
                </div>

                <!-- Discussions Sub-tab -->
                <div v-show="memorySubTab === 'discussions'" class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-comments text-purple-400 mr-3"></i>{{ t('discussionMemories') }}
                        </h2>
                        <button @click="fetchDiscussionMemories" class="btn-secondary text-sm">
                            <i class="fas fa-sync mr-2"></i>{{ t('refresh') }}
                        </button>
                    </div>

                    <div v-if="discussionMemories.length > 0" class="space-y-3">
                        <div v-for="dm in discussionMemories" :key="dm.session_id"
                             class="p-4 bg-gray-900/30 border border-gray-700/30 rounded-lg">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <div class="text-sm font-medium text-white">{{ dm.topic }}</div>
                                    <div class="text-xs text-gray-500 mt-1">{{ dm.providers }}</div>
                                </div>
                                <span class="text-xs text-gray-500">{{ formatDate(dm.created_at) }}</span>
                            </div>
                            <div v-if="dm.summary" class="text-sm text-gray-400 mt-2">{{ dm.summary }}</div>
                        </div>
                    </div>

                    <div v-else class="text-center py-12 text-gray-500">
                        <i class="fas fa-comments text-5xl mb-4"></i>
                        <p class="text-lg">{{ t('noDiscussionMemories') }}</p>
                    </div>
                </div>

                <!-- System 2 Sub-tab -->
                <div v-show="memorySubTab === 'system2'" class="space-y-6">
                    <!-- System 2 Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="stat-card purple p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">{{ t('totalArchives') }}</div>
                                    <div class="text-2xl font-semibold text-white">{{ consolidationStats.total_archives || 0 }}</div>
                                </div>
                                <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-archive text-purple-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card cyan p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">{{ t('totalConsolidated') }}</div>
                                    <div class="text-2xl font-semibold text-white">{{ consolidationStats.total_consolidated || 0 }}</div>
                                </div>
                                <div class="w-10 h-10 bg-cyan-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-compress-arrows-alt text-cyan-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card emerald p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">{{ t('avgImportance') }}</div>
                                    <div class="text-2xl font-semibold text-white">{{ (consolidationStats.avg_importance || 0).toFixed(2) }}</div>
                                </div>
                                <div class="w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-star text-emerald-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card amber p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">{{ t('lastConsolidation') }}</div>
                                    <div class="text-lg font-semibold text-white">{{ consolidationStats.last_run ? formatDate(consolidationStats.last_run) : 'Never' }}</div>
                                </div>
                                <div class="w-10 h-10 bg-amber-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-amber-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System 2 Operations -->
                    <div class="glass-card p-6">
                        <h2 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-cogs text-purple-400 mr-3"></i>{{ t('system2Operations') }}
                        </h2>
                        <div class="system2-ops">
                            <button @click="showConsolidateModal = true" class="system2-op-btn consolidate" :disabled="system2Loading">
                                <i class="fas fa-compress-arrows-alt"></i>
                                <span>{{ t('runConsolidation') }}</span>
                            </button>
                            <button @click="applyDecay" class="system2-op-btn decay" :disabled="system2Loading">
                                <i class="fas fa-hourglass-half"></i>
                                <span>{{ t('applyDecay') }}</span>
                            </button>
                            <button @click="mergeMemories" class="system2-op-btn merge" :disabled="system2Loading">
                                <i class="fas fa-object-group"></i>
                                <span>{{ t('mergeMemories') }}</span>
                            </button>
                            <button @click="showForgetModal = true" class="system2-op-btn forget" :disabled="system2Loading">
                                <i class="fas fa-eraser"></i>
                                <span>{{ t('forgetMemories') }}</span>
                            </button>
                        </div>
                        <div v-if="system2Loading" class="mt-4 flex items-center text-sm text-gray-400">
                            <i class="fas fa-spinner fa-spin mr-2"></i>{{ t('processingText') }}
                        </div>
                    </div>

                    <!-- Consolidated Memories List -->
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-brain text-purple-400 mr-3"></i>{{ t('consolidatedMemories') }}
                            </h2>
                            <button @click="fetchConsolidatedMemories" class="btn-secondary text-sm">
                                <i class="fas fa-sync mr-2"></i>{{ t('refresh') }}
                            </button>
                        </div>

                        <div v-if="consolidatedMemories.length > 0" class="space-y-4">
                            <div v-for="mem in consolidatedMemories" :key="mem.id" class="consolidation-card">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="date-badge">
                                        <i class="fas fa-calendar-alt"></i>
                                        {{ formatDate(mem.consolidation_date) }}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">{{ mem.session_count || 0 }} sessions</span>
                                        <span v-if="mem.llm_enhanced" class="px-2 py-0.5 bg-purple-500/20 text-purple-400 text-xs rounded-full">
                                            <i class="fas fa-magic mr-1"></i>LLM Enhanced
                                        </span>
                                    </div>
                                </div>
                                <div class="summary">{{ mem.summary }}</div>
                                <div v-if="mem.learnings && mem.learnings.length" class="mt-3">
                                    <div class="text-xs text-gray-500 mb-2">{{ t('learnings') }}:</div>
                                    <div class="learnings-list">
                                        <span v-for="(learning, idx) in mem.learnings.slice(0, 5)" :key="idx" class="learning-tag">
                                            {{ learning }}
                                        </span>
                                    </div>
                                </div>
                                <div v-if="mem.patterns && mem.patterns.length" class="mt-3">
                                    <div class="text-xs text-gray-500 mb-2">{{ t('patterns') }}:</div>
                                    <div v-for="(pattern, idx) in mem.patterns.slice(0, 2)" :key="idx" class="pattern-card">
                                        {{ pattern }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-else class="text-center py-12 text-gray-500">
                            <i class="fas fa-brain text-5xl mb-4"></i>
                            <p class="text-lg">{{ t('noConsolidatedMemories') }}</p>
                            <p class="text-sm mt-2">{{ t('runConsolidationHint') }}</p>
                        </div>
                    </div>
                </div>

                <!-- Heuristic Sub-tab -->
                <div v-show="memorySubTab === 'heuristic'" class="space-y-6">
                    <!-- Heuristic Configuration Card -->
                    <div class="glass-card p-6">
                        <h2 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-sliders-h text-cyan-400 mr-3"></i>{{ t('heuristicConfig') }}
                        </h2>
                        <p class="text-sm text-gray-400 mb-4">{{ t('scoreFormula') }}</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Alpha (Relevance) -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-sm font-medium text-gray-300">{{ t('relevanceWeight') }}</label>
                                    <span class="score-badge relevance">{{ heuristicConfig.alpha.toFixed(2) }}</span>
                                </div>
                                <input type="range" v-model.number="heuristicConfig.alpha" min="0" max="1" step="0.05"
                                       class="heuristic-slider relevance w-full" @change="debouncedSaveHeuristicConfig">
                            </div>

                            <!-- Beta (Importance) -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-sm font-medium text-gray-300">{{ t('importanceWeight') }}</label>
                                    <span class="score-badge importance">{{ heuristicConfig.beta.toFixed(2) }}</span>
                                </div>
                                <input type="range" v-model.number="heuristicConfig.beta" min="0" max="1" step="0.05"
                                       class="heuristic-slider importance w-full" @change="debouncedSaveHeuristicConfig">
                            </div>

                            <!-- Gamma (Recency) -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-sm font-medium text-gray-300">{{ t('recencyWeight') }}</label>
                                    <span class="score-badge recency">{{ heuristicConfig.gamma.toFixed(2) }}</span>
                                </div>
                                <input type="range" v-model.number="heuristicConfig.gamma" min="0" max="1" step="0.05"
                                       class="heuristic-slider recency w-full" @change="debouncedSaveHeuristicConfig">
                            </div>

                            <!-- Lambda (Decay Rate) -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-sm font-medium text-gray-300">{{ t('decayRate') }}</label>
                                    <span class="score-badge final">{{ heuristicConfig.lambda.toFixed(2) }}</span>
                                </div>
                                <input type="range" v-model.number="heuristicConfig.lambda" min="0" max="0.5" step="0.01"
                                       class="heuristic-slider decay w-full" @change="debouncedSaveHeuristicConfig">
                            </div>
                        </div>

                        <div class="mt-4 flex justify-end">
                            <button @click="saveHeuristicConfig" class="btn-primary text-sm">
                                <i class="fas fa-save mr-2"></i>{{ t('saveConfig') }}
                            </button>
                        </div>
                    </div>

                    <!-- Memory Health -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Health Score -->
                        <div class="glass-card p-6 flex flex-col items-center">
                            <h3 class="text-sm font-medium text-gray-400 mb-4">{{ t('memoryHealth') }}</h3>
                            <div class="health-meter" :style="{ '--health-score': memoryHealth.health_score || 0 }">
                                <svg viewBox="0 0 120 120" class="w-full h-full">
                                    <circle cx="60" cy="60" r="50" class="health-meter-ring health-meter-bg"/>
                                    <circle cx="60" cy="60" r="50"
                                            :class="['health-meter-ring health-meter-value',
                                                     memoryHealth.health_score < 40 ? 'danger' :
                                                     memoryHealth.health_score < 70 ? 'warning' : '']"/>
                                </svg>
                                <div class="health-meter-text">
                                    <div class="health-meter-score">{{ memoryHealth.health_score || 0 }}</div>
                                    <div class="health-meter-label">{{ t('scoreLabel') }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Importance Distribution -->
                        <div class="glass-card p-6">
                            <h3 class="text-sm font-medium text-gray-400 mb-4">{{ t('importanceDistribution') }}</h3>
                            <div class="distribution-bar mb-2">
                                <div class="distribution-bar-segment high"
                                     :style="{ width: (memoryHealth.importance_distribution?.high || 0) / Math.max(1, (memoryHealth.importance_distribution?.high || 0) + (memoryHealth.importance_distribution?.medium || 0) + (memoryHealth.importance_distribution?.low || 0)) * 100 + '%' }"></div>
                                <div class="distribution-bar-segment medium"
                                     :style="{ width: (memoryHealth.importance_distribution?.medium || 0) / Math.max(1, (memoryHealth.importance_distribution?.high || 0) + (memoryHealth.importance_distribution?.medium || 0) + (memoryHealth.importance_distribution?.low || 0)) * 100 + '%' }"></div>
                                <div class="distribution-bar-segment low"
                                     :style="{ width: (memoryHealth.importance_distribution?.low || 0) / Math.max(1, (memoryHealth.importance_distribution?.high || 0) + (memoryHealth.importance_distribution?.medium || 0) + (memoryHealth.importance_distribution?.low || 0)) * 100 + '%' }"></div>
                            </div>
                            <div class="distribution-legend">
                                <div class="distribution-legend-item">
                                    <span class="distribution-legend-dot high"></span>
                                    <span>{{ t('highImportance') }}: {{ memoryHealth.importance_distribution?.high || 0 }}</span>
                                </div>
                                <div class="distribution-legend-item">
                                    <span class="distribution-legend-dot medium"></span>
                                    <span>{{ t('mediumImportance') }}: {{ memoryHealth.importance_distribution?.medium || 0 }}</span>
                                </div>
                                <div class="distribution-legend-item">
                                    <span class="distribution-legend-dot low"></span>
                                    <span>{{ t('lowImportance') }}: {{ memoryHealth.importance_distribution?.low || 0 }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Retrieval Performance -->
                        <div class="glass-card p-6">
                            <h3 class="text-sm font-medium text-gray-400 mb-4">{{ t('retrievalPerformance') }}</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-400">{{ t('avgQueryTime') }}</span>
                                    <span class="text-sm font-mono text-cyan-400">{{ memoryHealth.retrieval_performance?.avg_query_ms || 0 }}ms</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-400">{{ t('cacheHitRate') }}</span>
                                    <span class="text-sm font-mono text-emerald-400">{{ ((memoryHealth.retrieval_performance?.cache_hit_rate || 0) * 100).toFixed(1) }}%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-400">{{ t('p95Latency') }}</span>
                                    <span class="text-sm font-mono text-amber-400">{{ memoryHealth.retrieval_performance?.p95_ms || 0 }}ms</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-chart-bar text-amber-400 mr-3"></i>{{ t('heuristicStats') }}
                            </h2>
                            <button @click="fetchMemoryHealth" class="btn-secondary text-sm">
                                <i class="fas fa-sync mr-2"></i>{{ t('refresh') }}
                            </button>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="p-4 bg-gray-900/30 rounded-lg">
                                <div class="text-xs text-gray-500 mb-1">{{ t('totalMemories') }}</div>
                                <div class="text-xl font-semibold text-white">{{ detailedStats.total_memories || 0 }}</div>
                            </div>
                            <div class="p-4 bg-gray-900/30 rounded-lg">
                                <div class="text-xs text-gray-500 mb-1">{{ t('totalAccessCount') }}</div>
                                <div class="text-xl font-semibold text-white">{{ detailedStats.total_access_count || 0 }}</div>
                            </div>
                            <div class="p-4 bg-gray-900/30 rounded-lg">
                                <div class="text-xs text-gray-500 mb-1">{{ t('avgImportance') }}</div>
                                <div class="text-xl font-semibold text-white">{{ (detailedStats.avg_importance || 0).toFixed(3) }}</div>
                            </div>
                            <div class="p-4 bg-gray-900/30 rounded-lg">
                                <div class="text-xs text-gray-500 mb-1">{{ t('freshnessScore') }}</div>
                                <div class="text-xl font-semibold text-white">{{ (detailedStats.freshness_score || 0).toFixed(2) }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Detail Modal -->
                <div v-if="selectedSession" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" @click="selectedSession = null">
                    <div class="modal-content max-w-4xl w-full max-h-[80vh] overflow-y-auto" @click.stop>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">{{ t('sessionLabel') }}: {{ selectedSession.session_id.substring(0, 16) }}...</h3>
                            <button @click="selectedSession = null" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div v-if="selectedSession.messages" class="space-y-3">
                            <div v-for="msg in selectedSession.messages" :key="msg.message_id"
                                 class="p-4 bg-gray-900/30 border border-gray-700/30 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span :class="['px-2 py-1 text-xs rounded-full', getRoleColor(msg.role)]">
                                        {{ msg.role }}
                                    </span>
                                    <span class="text-xs text-gray-500">{{ formatDate(msg.timestamp) }}</span>
                                </div>
                                <div class="text-sm text-gray-300 whitespace-pre-wrap">{{ msg.content }}</div>
                                <div v-if="msg.provider" class="mt-2 text-xs text-gray-500">
                                    Provider: {{ msg.provider }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Observation Modal -->
                <div v-if="showAddObservationModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" @click="showAddObservationModal = false">
                    <div class="modal-content max-w-lg w-full p-6" @click.stop>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">{{ editingObservation ? t('editObservation') : t('addObservation') }}</h3>
                            <button @click="showAddObservationModal = false; editingObservation = null" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">{{ t('observationCategory') }}</label>
                                <select v-model="newObservation.category" class="input-field">
                                    <option value="insight">{{ t('insight') }}</option>
                                    <option value="preference">{{ t('preference') }}</option>
                                    <option value="fact">{{ t('fact') }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">{{ t('content') }}</label>
                                <textarea v-model="newObservation.content" rows="4" class="input-field" :placeholder="t('enterObservation')"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">{{ t('observationTags') }} (comma-separated)</label>
                                <input v-model="newObservation.tags" type="text" class="input-field" placeholder="tag1, tag2, tag3">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button @click="showAddObservationModal = false; editingObservation = null" class="btn-secondary">{{ t('cancelBtn') }}</button>
                                <button @click="saveObservation" class="btn-primary">{{ t('saveObservation') }}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memory Config Modal -->
                <div v-if="showMemoryConfigModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" @click="showMemoryConfigModal = false">
                    <div class="modal-content max-w-xl w-full max-h-[80vh] overflow-y-auto p-6" @click.stop>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">{{ t('memorySettings') }}</h3>
                            <button @click="showMemoryConfigModal = false" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Basic Memory Settings -->
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-memory"></i>
                                Basic Settings
                            </div>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm text-gray-300">{{ t('memoryEnabled') }}</label>
                                    <div @click="memoryConfig.enabled = !memoryConfig.enabled"
                                         :class="['toggle-switch', memoryConfig.enabled ? 'active' : '']"></div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="text-sm text-gray-300">{{ t('autoInject') }}</label>
                                    <div @click="memoryConfig.auto_inject = !memoryConfig.auto_inject"
                                         :class="['toggle-switch', memoryConfig.auto_inject ? 'active' : '']"></div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">{{ t('maxInjected') }}: {{ memoryConfig.max_injected_memories }}</label>
                                    <input type="range" v-model.number="memoryConfig.max_injected_memories" min="1" max="20" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">{{ t('injectionStrategy') }}</label>
                                    <select v-model="memoryConfig.injection_strategy" class="input-field">
                                        <option value="recent">{{ t('recent') }}</option>
                                        <option value="relevant">{{ t('relevant') }}</option>
                                        <option value="recent_plus_relevant">{{ t('recentPlusRelevant') }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Heuristic Retrieval Settings -->
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-sliders-h"></i>
                                {{ t('heuristicSection') }}
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="text-sm text-gray-300">{{ t('relevanceWeight') }}</label>
                                        <span class="text-sm font-mono text-cyan-400">{{ heuristicConfig.alpha.toFixed(2) }}</span>
                                    </div>
                                    <input type="range" v-model.number="heuristicConfig.alpha" min="0" max="1" step="0.05" class="heuristic-slider relevance w-full">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="text-sm text-gray-300">{{ t('importanceWeight') }}</label>
                                        <span class="text-sm font-mono text-amber-400">{{ heuristicConfig.beta.toFixed(2) }}</span>
                                    </div>
                                    <input type="range" v-model.number="heuristicConfig.beta" min="0" max="1" step="0.05" class="heuristic-slider importance w-full">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="text-sm text-gray-300">{{ t('recencyWeight') }}</label>
                                        <span class="text-sm font-mono text-emerald-400">{{ heuristicConfig.gamma.toFixed(2) }}</span>
                                    </div>
                                    <input type="range" v-model.number="heuristicConfig.gamma" min="0" max="1" step="0.05" class="heuristic-slider recency w-full">
                                </div>
                                <div>
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="text-sm text-gray-300">{{ t('decayRate') }}</label>
                                        <span class="text-sm font-mono text-rose-400">{{ heuristicConfig.lambda.toFixed(2) }}</span>
                                    </div>
                                    <input type="range" v-model.number="heuristicConfig.lambda" min="0" max="0.5" step="0.01" class="heuristic-slider decay w-full">
                                </div>
                            </div>
                        </div>

                        <!-- System 2 Settings -->
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-brain"></i>
                                {{ t('system2Section') }}
                            </div>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div class="settings-label">
                                        <span class="settings-label-text">{{ t('enableNightlyConsolidation') }}</span>
                                        <span class="settings-label-hint">{{ t('runNightlyAuto') }}</span>
                                    </div>
                                    <div @click="system2Config.nightly_enabled = !system2Config.nightly_enabled"
                                         :class="['toggle-switch', system2Config.nightly_enabled ? 'active' : '']"></div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="settings-label">
                                        <span class="settings-label-text">{{ t('enableLlmInsights') }}</span>
                                        <span class="settings-label-hint">{{ t('useLlmInsights') }}</span>
                                    </div>
                                    <div @click="system2Config.llm_insights = !system2Config.llm_insights"
                                         :class="['toggle-switch', system2Config.llm_insights ? 'active' : '']"></div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">{{ t('llmProvider') }}</label>
                                    <select v-model="system2Config.llm_provider" class="input-field">
                                        <option value="kimi">Kimi</option>
                                        <option value="qwen">Qwen</option>
                                        <option value="deepseek">DeepSeek</option>
                                        <option value="codex">Codex</option>
                                        <option value="gemini">Gemini</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-4">
                            <button @click="resetMemoryConfig" class="btn-secondary">{{ t('reset') }}</button>
                            <button @click="saveAllMemoryConfig" class="btn-primary">{{ t('save') }}</button>
                        </div>
                    </div>
                </div>

                <!-- Consolidate Modal -->
                <div v-if="showConsolidateModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" @click="showConsolidateModal = false">
                    <div class="modal-content max-w-md w-full p-6" @click.stop>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-compress-arrows-alt text-purple-400 mr-2"></i>
                                {{ t('runConsolidation') }}
                            </h3>
                            <button @click="showConsolidateModal = false" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">{{ t('hoursToConsolidate') }}: {{ consolidateOptions.hours }}</label>
                                <input type="range" v-model.number="consolidateOptions.hours" min="1" max="168" step="1" class="w-full">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-sm text-gray-300">{{ t('enableLlmEnhancement') }}</label>
                                <div @click="consolidateOptions.llm_enhanced = !consolidateOptions.llm_enhanced"
                                     :class="['toggle-switch', consolidateOptions.llm_enhanced ? 'active' : '']"></div>
                            </div>
                            <div class="flex justify-end gap-2 mt-6">
                                <button @click="showConsolidateModal = false" class="btn-secondary">{{ t('cancelBtn') }}</button>
                                <button @click="runConsolidation" class="btn-primary" :disabled="system2Loading">
                                    <i v-if="system2Loading" class="fas fa-spinner fa-spin mr-2"></i>
                                    {{ t('runConsolidation') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Forget Modal -->
                <div v-if="showForgetModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" @click="showForgetModal = false">
                    <div class="modal-content max-w-md w-full p-6" @click.stop>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-eraser text-rose-400 mr-2"></i>
                                {{ t('forgetMemories') }}
                            </h3>
                            <button @click="showForgetModal = false" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">{{ t('minImportanceThreshold') }}: {{ forgetOptions.min_importance.toFixed(2) }}</label>
                                <input type="range" v-model.number="forgetOptions.min_importance" min="0" max="0.5" step="0.01" class="w-full">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">{{ t('maxAgeDays') }}: {{ forgetOptions.max_age_days }}</label>
                                <input type="range" v-model.number="forgetOptions.max_age_days" min="7" max="365" step="1" class="w-full">
                            </div>
                            <div class="p-3 bg-rose-500/10 border border-rose-500/30 rounded-lg text-sm text-rose-400">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                This will permanently delete memories with importance below {{ forgetOptions.min_importance.toFixed(2) }} and older than {{ forgetOptions.max_age_days }} days.
                            </div>
                            <div class="flex justify-end gap-2 mt-6">
                                <button @click="showForgetModal = false" class="btn-secondary">{{ t('cancelBtn') }}</button>
                                <button @click="forgetMemoriesAction" class="btn-primary bg-rose-500 hover:bg-rose-600" :disabled="system2Loading">
                                    <i v-if="system2Loading" class="fas fa-spinner fa-spin mr-2"></i>
                                    {{ t('forgetMemories') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Injection Detail Modal -->
                <div v-if="selectedInjection" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" @click="selectedInjection = null">
                    <div class="modal-content max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6" @click.stop>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">{{ t('injectedMemories') }}</h3>
                            <button @click="selectedInjection = null" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div v-if="selectedInjection.memories && selectedInjection.memories.length > 0" class="space-y-3">
                            <div v-for="mem in selectedInjection.memories" :key="mem.message_id"
                                 class="p-3 bg-gray-900/30 border border-gray-700/30 rounded-lg">
                                <div class="text-sm text-gray-300">{{ mem.content }}</div>
                                <div class="text-xs text-gray-500 mt-1">{{ mem.role }} - {{ formatDate(mem.timestamp) }}</div>
                            </div>
                        </div>
                        <div v-else class="text-center py-8 text-gray-500">
                            No memory details available
                        </div>
                    </div>
                </div>
            </div>

            <!-- Skills Tab -->
            <div v-show="activeTab === 'skills'" class="space-y-6">
                <!-- Skills Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat-card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">{{ t('totalSkills') }}</div>
                                <div class="text-2xl font-semibold text-white">{{ skillsStats.total_skills || 0 }}</div>
                            </div>
                            <div class="w-10 h-10 bg-indigo-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tools text-indigo-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">{{ t('installed') }}</div>
                                <div class="text-2xl font-semibold text-white">{{ skillsStats.installed_skills || 0 }}</div>
                            </div>
                            <div class="w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-check-circle text-emerald-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-gray-400 mb-1">{{ t('totalUses') }}</div>
                                <div class="text-2xl font-semibold text-white">{{ skillsStats.total_usage || 0 }}</div>
                            </div>
                            <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-bar text-purple-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills Search -->
                <div class="glass-card p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">{{ t('findSkillsForTask') }}</label>
                        <div class="flex gap-2">
                            <input v-model="skillsSearchQuery" @keyup.enter="searchSkills" type="text"
                                   :placeholder="t('skillSearchPlaceholder')"
                                   class="flex-1 px-4 py-2 bg-gray-900/50 border border-gray-700/50 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500/50">
                            <button @click="searchSkills" class="btn-primary">
                                <i class="fas fa-search mr-2"></i>{{ t('findSkillsBtn') }}
                            </button>
                        </div>
                    </div>

                    <!-- Skill Recommendations -->
                    <div v-if="skillRecommendations.found" class="space-y-3 mt-4">
                        <div class="text-sm text-indigo-400 mb-2">
                            <i class="fas fa-lightbulb mr-2"></i>{{ skillRecommendations.message }}
                        </div>
                        <div v-for="skill in skillRecommendations.skills" :key="skill.name"
                             class="p-4 bg-gray-900/30 border border-gray-700/30 rounded-lg hover:border-indigo-500/30 transition-colors">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg font-semibold text-white">/{{ skill.name }}</span>
                                    <span v-if="skill.installed" class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">
                                        <i class="fas fa-check mr-1"></i>{{ t('installed') }}
                                    </span>
                                    <span v-else class="px-2 py-0.5 bg-gray-500/20 text-gray-400 text-xs rounded-full">
                                        <i class="fas fa-download mr-1"></i>{{ t('available') }}
                                    </span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-indigo-400">{{ t('skillScore') }}: {{ skill.relevance_score }}</span>
                                    <button @click="openSkillFeedback(skill)" class="text-gray-400 hover:text-amber-400 text-sm" :title="t('giveFeedback')">
                                        <i class="fas fa-star"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-300 mb-2">{{ skill.description }}</div>
                            <div class="flex items-center gap-4 text-xs text-gray-500">
                                <span v-if="skill.usage_count > 0">{{ t('usedTimes') }} {{ skill.usage_count }} {{ t('times') }}</span>
                                <span v-if="skill.feedback_boost" class="text-amber-400">
                                    <i class="fas fa-arrow-up mr-1"></i>{{ t('feedbackBoost') }}: +{{ (skill.feedback_boost * 100).toFixed(0) }}%
                                </span>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="skillRecommendations.message" class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>{{ skillRecommendations.message }}</p>
                    </div>
                </div>

                <!-- Top Used Skills -->
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-star text-amber-400 mr-3"></i>{{ t('topUsedSkills') }}
                        </h2>
                        <button @click="fetchSkillsStats" class="btn-secondary text-sm">
                            <i class="fas fa-sync mr-2"></i>{{ t('refresh') }}
                        </button>
                    </div>

                    <div v-if="skillsStats.top_skills && skillsStats.top_skills.length > 0" class="space-y-2">
                        <div v-for="skill in skillsStats.top_skills.slice(0, 10)" :key="skill.skill_name"
                             class="flex items-center justify-between p-3 bg-gray-900/30 border border-gray-700/30 rounded-lg hover:border-gray-600/50 transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-medium text-white">/{{ skill.skill_name }}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-gray-500">{{ skill.usage_count }} uses</span>
                                <div class="w-24 h-2 bg-gray-700/50 rounded-full overflow-hidden">
                                    <div class="h-full bg-indigo-500" :style="{ width: (skill.usage_count / skillsStats.top_skills[0].usage_count * 100) + '%' }"></div>
                                </div>
                                <button @click="openSkillFeedback({ name: skill.skill_name })" class="text-gray-400 hover:text-amber-400 text-sm" :title="t('giveFeedback')">
                                    <i class="fas fa-star"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div v-else class="text-center py-12 text-gray-500">
                        <i class="fas fa-tools text-5xl mb-4"></i>
                        <p class="text-lg">{{ t('noSkillsUsed') }}</p>
                        <p class="text-sm mt-2">{{ t('startUsingSkillsHint') }}</p>
                    </div>
                </div>

                <!-- Skill Feedback Modal -->
                <div v-if="showSkillFeedbackModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" @click="showSkillFeedbackModal = false">
                    <div class="modal-content max-w-md w-full p-6" @click.stop>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">{{ t('giveFeedback') }}: /{{ feedbackSkill?.name }}</h3>
                            <button @click="showSkillFeedbackModal = false" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">{{ t('feedbackRating') }}</label>
                                <div class="flex gap-2">
                                    <button v-for="n in 5" :key="n" @click="skillFeedback.rating = n"
                                            :class="['w-10 h-10 rounded-lg border transition-colors',
                                                     n <= skillFeedback.rating ? 'bg-amber-500/20 border-amber-500/50 text-amber-400' : 'border-gray-700 text-gray-500 hover:border-gray-600']">
                                        <i class="fas fa-star"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-sm text-gray-300">{{ t('feedbackHelpful') }}</label>
                                <div @click="skillFeedback.helpful = !skillFeedback.helpful"
                                     :class="['toggle-switch', skillFeedback.helpful ? 'active' : '']"></div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">{{ t('feedbackTask') }} (optional)</label>
                                <input v-model="skillFeedback.task_description" type="text" class="input-field" :placeholder="t('whatTaskForSkill')">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button @click="showSkillFeedbackModal = false" class="btn-secondary">{{ t('cancelBtn') }}</button>
                                <button @click="submitSkillFeedback" class="btn-primary">{{ t('submitFeedback') }}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discussions Tab -->
            <div v-show="activeTab === 'discussions'" class="space-y-6">
                <div class="glass-card p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-comments text-purple-400 mr-3"></i>{{ t('multiAiDiscussion') }}
                            <span v-if="activeDiscussions.length > 0" class="ml-3 px-2 py-0.5 bg-purple-500/20 text-purple-400 text-xs rounded-full animate-pulse">
                                {{ activeDiscussions.length }} {{ t('active') }}
                            </span>
                        </h2>
                        <div class="flex items-center gap-3">
                            <button @click="showNewDiscussionModal = true" class="btn-primary">
                                <i class="fas fa-plus mr-2"></i>{{ t('newDiscussion') }}
                            </button>
                            <button @click="showTemplateModal = true; fetchDiscussionTemplates();" class="btn-secondary bg-purple-500/10 border-purple-500/30 text-purple-400 hover:bg-purple-500/20">
                                <i class="fas fa-magic mr-2"></i>{{ t('useTemplate') }}
                            </button>
                            <button @click="exportDiscussionsJSON" class="btn-secondary" :title="t('exportData')">
                                <i class="fas fa-download mr-2"></i>{{ t('exportData') }}
                            </button>
                            <button @click="fetchDiscussions" class="btn-secondary">
                                <i class="fas fa-sync-alt mr-2" :class="{'fa-spin': loading.discussions}"></i>{{ t('refreshDiscussions') }}
                            </button>
                        </div>
                    </div>

                    <!-- Discussion List -->
                    <div v-if="discussions.length > 0" class="space-y-4">
                        <div v-for="disc in discussions" :key="disc.id"
                             class="bg-gray-800/50 rounded-xl border transition-all cursor-pointer hover:border-purple-500/50"
                             :class="disc.status === 'in_progress' ? 'border-purple-500/30 animate-pulse-slow' : 'border-gray-700/50'"
                             @click="selectDiscussion(disc)">
                            <div class="p-4">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1 mr-4">
                                        <h3 class="font-medium text-white text-sm line-clamp-2">{{ disc.topic }}</h3>
                                        <p class="text-xs text-gray-500 mt-1">ID: {{ disc.id }}</p>
                                    </div>
                                    <span class="badge shrink-0" :class="getDiscussionStatusClass(disc.status)">
                                        <i :class="getDiscussionStatusIcon(disc.status)" class="mr-1"></i>
                                        {{ t('discussionRound') }} {{ disc.current_round }}/{{ disc.config?.max_rounds || 3 }}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <span v-for="p in disc.providers" :key="p"
                                              class="text-xs px-2 py-0.5 rounded-full bg-gray-700/50 text-gray-300">
                                            {{ getProviderTierIcon(p) }} {{ p }}
                                        </span>
                                    </div>
                                    <span class="text-xs text-gray-500">{{ formatTime(disc.created_at) }}</span>
                                </div>
                            </div>
                            <!-- Progress Bar for Active Discussions -->
                            <div v-if="disc.status === 'in_progress'" class="h-1 bg-gray-700">
                                <div class="h-full bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-500"
                                     :style="{ width: ((disc.current_round / (disc.config?.max_rounds || 3)) * 100) + '%' }"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div v-else class="text-center py-16 text-gray-500">
                        <i class="fas fa-comments text-5xl mb-4"></i>
                        <p class="text-lg">{{ t('noDiscussions') }}</p>
                        <p class="text-sm mt-2">{{ t('newDiscussion') }}</p>
                    </div>
                </div>

                <!-- Selected Discussion Detail -->
                <div v-if="selectedDiscussion" class="glass-card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-stream text-cyan-400 mr-3"></i>
                            {{ t('discussionMessages') }}
                        </h3>
                        <div class="flex gap-2">
                            <button v-if="selectedDiscussion.status === 'completed'"
                                    @click="saveDiscussionToMemory(selectedDiscussion)"
                                    class="btn-secondary text-sm bg-purple-500/10 border-purple-500/30 text-purple-400 hover:bg-purple-500/20">
                                <i class="fas fa-brain mr-1"></i>{{ t('saveToMemory') }}
                            </button>
                            <button @click="selectedDiscussion = null" class="btn-secondary text-sm">
                                <i class="fas fa-times mr-1"></i>{{ t('close') }}
                            </button>
                        </div>
                    </div>

                    <!-- Discussion Timeline -->
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Summary (if completed) -->
                        <div v-if="selectedDiscussion.summary" class="bg-gradient-to-r from-purple-500/10 to-indigo-500/10 rounded-xl p-4 border border-purple-500/30">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-brain text-purple-400 mr-2"></i>
                                <span class="font-semibold text-purple-400">{{ t('discussionSummary') }}</span>
                            </div>
                            <div class="prose prose-invert prose-sm max-w-none text-gray-300 whitespace-pre-wrap">{{ selectedDiscussion.summary }}</div>
                        </div>

                        <!-- Messages by Round -->
                        <template v-for="round in [1, 2, 3]" :key="round">
                            <div v-if="getMessagesForRound(round).length > 0" class="space-y-3">
                                <div class="flex items-center gap-2 text-sm text-gray-400">
                                    <div class="h-px flex-1 bg-gray-700"></div>
                                    <span class="px-3 py-1 rounded-full bg-gray-800 border border-gray-700">
                                        <i :class="getRoundIcon(round)" class="mr-1"></i>
                                        {{ getRoundLabel(round) }}
                                    </span>
                                    <div class="h-px flex-1 bg-gray-700"></div>
                                </div>
                                <div v-for="msg in getMessagesForRound(round)" :key="msg.id"
                                     class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg">{{ getProviderTierIcon(msg.provider) }}</span>
                                            <span class="font-medium text-white">{{ msg.provider }}</span>
                                            <span class="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-400">{{ msg.message_type }}</span>
                                        </div>
                                        <span v-if="msg.latency_ms" class="text-xs text-gray-500">{{ (msg.latency_ms / 1000).toFixed(1) }}s</span>
                                    </div>
                                    <div class="text-sm text-gray-300 whitespace-pre-wrap max-h-64 overflow-y-auto">{{ msg.content?.slice(0, 2000) }}{{ msg.content?.length > 2000 ? '...' : '' }}</div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div v-show="activeTab === 'requests'" class="space-y-6">
                <div class="glass-card p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <h2 class="text-lg font-semibold flex items-center"><i class="fas fa-list text-indigo-400 mr-3"></i>{{ t('recentRequests') }}</h2>
                        <div class="flex flex-wrap items-center gap-3">
                            <input v-model="searchQuery" type="text" :placeholder="t('searchRequests')" class="input-field w-48">
                            <select v-model="requestFilter" class="input-field w-32">
                                <option value="">{{ t('allStatus') }}</option>
                                <option value="queued">{{ t('queued') }}</option>
                                <option value="processing">{{ t('processing') }}</option>
                                <option value="completed">{{ t('completed') }}</option>
                                <option value="failed">{{ t('failed') }}</option>
                            </select>
                            <select v-model="providerFilter" class="input-field w-32">
                                <option value="">{{ t('allProviders') }}</option>
                                <option v-for="p in status.providers" :key="p.name" :value="p.name">{{ p.name }}</option>
                            </select>
                            <div class="relative">
                                <button class="btn-secondary flex items-center" @click="showExportMenu = !showExportMenu">
                                    <i class="fas fa-download mr-2"></i>{{ t('exportData') }}
                                    <i class="fas fa-chevron-down ml-2 text-xs"></i>
                                </button>
                                <div v-if="showExportMenu" class="absolute right-0 mt-2 w-40 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-10">
                                    <button @click="exportRequestsCSV(); showExportMenu = false;" class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded-t-lg flex items-center">
                                        <i class="fas fa-file-csv mr-2 text-green-400"></i>CSV
                                    </button>
                                    <button @click="exportRequestsJSON(); showExportMenu = false;" class="w-full text-left px-4 py-2 hover:bg-gray-700 rounded-b-lg flex items-center">
                                        <i class="fas fa-file-code mr-2 text-blue-400"></i>JSON
                                    </button>
                                </div>
                            </div>
                            <button @click="fetchRequests" class="btn-primary"><i v-if="loading.requests" class="fas fa-spinner fa-spin mr-2"></i>{{ t('refresh') }}</button>
                        </div>
                    </div>
                    <div v-if="loading.requests" class="space-y-3">
                        <div v-for="i in 5" :key="i" class="animate-pulse flex space-x-4">
                            <div class="h-4 bg-gray-700 rounded w-24"></div>
                            <div class="h-4 bg-gray-700 rounded w-20"></div>
                            <div class="h-4 bg-gray-700 rounded w-16"></div>
                            <div class="h-4 bg-gray-700 rounded flex-1"></div>
                            <div class="h-4 bg-gray-700 rounded w-32"></div>
                        </div>
                    </div>
                    <div v-else class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>{{ t('id') }}</th>
                                    <th>{{ t('provider') }}</th>
                                    <th>{{ t('agent') }}</th>
                                    <th>{{ t('status') }}</th>
                                    <th>{{ t('message') }}</th>
                                    <th>{{ t('created') }}</th>
                                    <th>{{ t('actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="req in paginatedRequests" :key="req.id">
                                    <td class="font-mono text-sm text-indigo-400">{{ req.id }}</td>
                                    <td><span class="badge badge-info">{{ req.provider }}</span></td>
                                    <td>
                                        <span v-if="req.metadata?.agent" class="badge bg-purple-500/20 text-purple-300 border-purple-500/30">
                                            {{ getAgentIcon(req.metadata.agent) }} {{ req.metadata.agent }}
                                        </span>
                                        <span v-else class="text-gray-500 text-sm">-</span>
                                    </td>
                                    <td>
                                        <span :class="getRequestStatusClass(req.status)" class="badge">
                                            <span class="w-1.5 h-1.5 rounded-full" :class="getStatusDotClass(req.status)"></span>
                                            {{ req.status }}
                                        </span>
                                    </td>
                                    <td class="max-w-xs truncate text-gray-300" :title="req.message">{{ req.message }}</td>
                                    <td class="text-sm text-gray-400">{{ formatTime(req.created_at) }}</td>
                                    <td>
                                        <div class="flex space-x-2">
                                            <button @click="viewRequest(req)" class="btn-secondary text-xs py-1 px-2">{{ t('view') }}</button>
                                            <button v-if="req.status === 'failed'" @click="retryRequest(req)" class="btn-primary text-xs py-1 px-2"><i class="fas fa-redo"></i></button>
                                            <button v-if="req.status === 'queued' || req.status === 'processing'" @click="showConfirmDialog(t('cancelRequest'), t('confirmCancelRequest'), () => cancelRequest(req.id))" class="text-xs py-1 px-2 bg-rose-500/20 text-rose-400 rounded-lg hover:bg-rose-500/30">{{ t('cancel') }}</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div v-if="filteredRequests.length === 0" class="text-center py-12 text-gray-500"><i class="fas fa-inbox text-4xl mb-3"></i><p>{{ t('noRequests') }}</p></div>
                        <div v-if="filteredRequests.length > 0" class="flex flex-col md:flex-row justify-between items-center mt-6 pt-6 border-t border-gray-700/50 gap-4">
                            <span class="text-sm text-gray-400">{{ t('showing') }} {{ paginationStart }}-{{ paginationEnd }} {{ t('of') }} {{ filteredRequests.length }}</span>
                            <div class="flex items-center space-x-3">
                                <select v-model="pagination.pageSize" @change="pagination.page = 1" class="input-field w-20 text-sm">
                                    <option :value="10">10</option>
                                    <option :value="20">20</option>
                                    <option :value="50">50</option>
                                </select>
                                <span class="text-sm text-gray-400">{{ t('perPage') }}</span>
                                <div class="flex items-center space-x-1">
                                    <button @click="pagination.page--" :disabled="pagination.page <= 1" class="btn-secondary py-1 px-3 disabled:opacity-50"><i class="fas fa-chevron-left"></i></button>
                                    <span class="px-3 text-sm">{{ pagination.page }} / {{ totalPages }}</span>
                                    <button @click="pagination.page++" :disabled="pagination.page >= totalPages" class="btn-secondary py-1 px-3 disabled:opacity-50"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Costs Tab merged into Dashboard -->

            <!-- Settings Tab (merged Config + API Keys) -->
            <div v-show="activeTab === 'settings'" class="space-y-6">
                <!-- Sub-tabs for Settings -->
                <div class="flex space-x-2 mb-6">
                    <button @click="settingsSubTab = 'config'" :class="['px-4 py-2 rounded-lg transition-colors', settingsSubTab === 'config' ? 'bg-indigo-500/20 text-indigo-400' : 'text-gray-400 hover:text-white']">
                        <i class="fas fa-cog mr-2"></i>{{ t('systemConfig') }}
                    </button>
                    <button @click="settingsSubTab = 'keys'" :class="['px-4 py-2 rounded-lg transition-colors', settingsSubTab === 'keys' ? 'bg-amber-500/20 text-amber-400' : 'text-gray-400 hover:text-white']">
                        <i class="fas fa-key mr-2"></i>{{ t('apiKeys') }}
                    </button>
                </div>

                <!-- System Config Section -->
                <div v-show="settingsSubTab === 'config'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="glass-card p-6">
                        <h2 class="text-lg font-semibold flex items-center mb-6"><i class="fas fa-shield-alt text-indigo-400 mr-3"></i>{{ t('authentication') }}</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('enabled') }}</span>
                                <span :class="authConfig.enabled ? 'text-emerald-400' : 'text-gray-500'">{{ authConfig.enabled ? t('yes') : t('no') }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('headerName') }}</span>
                                <span class="font-mono text-indigo-400 text-sm">{{ authConfig.header_name }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-400">{{ t('allowLocalhost') }}</span>
                                <span>{{ authConfig.allow_localhost ? t('yes') : t('no') }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <h2 class="text-lg font-semibold flex items-center mb-6"><i class="fas fa-tachometer-alt text-purple-400 mr-3"></i>{{ t('rateLimiting') }}</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('enabled') }}</span>
                                <span :class="rateLimitConfig.enabled ? 'text-emerald-400' : 'text-gray-500'">{{ rateLimitConfig.enabled ? t('yes') : t('no') }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('requestsPerMin') }}</span>
                                <span class="text-indigo-400 font-medium">{{ rateLimitConfig.requests_per_minute }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-400">{{ t('burstSize') }}</span>
                                <span>{{ rateLimitConfig.burst_size }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <h2 class="text-lg font-semibold flex items-center mb-6"><i class="fas fa-redo text-cyan-400 mr-3"></i>{{ t('retryFallback') }}</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('retryEnabled') }}</span>
                                <span :class="retryConfig.enabled ? 'text-emerald-400' : 'text-gray-500'">{{ retryConfig.enabled ? t('yes') : t('no') }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('maxRetries') }}</span>
                                <span>{{ retryConfig.max_retries }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-400">{{ t('fallbackEnabled') }}</span>
                                <span :class="retryConfig.fallback_enabled ? 'text-emerald-400' : 'text-gray-500'">{{ retryConfig.fallback_enabled ? t('yes') : t('no') }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold flex items-center"><i class="fas fa-database text-emerald-400 mr-3"></i>{{ t('cacheManagement') }}</h2>
                            <div class="flex space-x-2">
                                <button @click="cleanupCache" class="btn-secondary text-xs py-1 px-2"><i class="fas fa-broom mr-1"></i>{{ t('cleanup') }}</button>
                                <button @click="showConfirmDialog(t('clearCache'), t('confirmClearCache'), clearCache)" class="text-xs py-1 px-2 bg-rose-500/20 text-rose-400 rounded-lg hover:bg-rose-500/30"><i class="fas fa-trash mr-1"></i>{{ t('clearAll') }}</button>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('hits') }}</span>
                                <span class="text-emerald-400 font-medium">{{ status.gateway?.cache?.hits || 0 }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('misses') }}</span>
                                <span class="text-amber-400">{{ status.gateway?.cache?.misses || 0 }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                                <span class="text-gray-400">{{ t('hitRate') }}</span>
                                <span class="text-indigo-400 font-medium">{{ formatPercent(status.gateway?.cache?.hit_rate || 0) }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-400">{{ t('totalEntries') }}</span>
                                <span>{{ status.gateway?.cache?.total_entries || 0 }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card p-6">
                        <h2 class="text-lg font-semibold flex items-center mb-6"><i class="fas fa-chart-line text-rose-400 mr-3"></i>{{ t('prometheusMetrics') }}</h2>
                        <a href="/metrics" target="_blank" class="flex items-center space-x-2 text-indigo-400 hover:text-indigo-300 transition-colors mb-3">
                            <span>{{ t('viewRawMetrics') }}</span><i class="fas fa-external-link-alt text-sm"></i>
                        </a>
                        <p class="text-xs text-gray-500">{{ t('endpoint') }}: <code class="bg-gray-800 px-2 py-1 rounded">/metrics</code></p>
                    </div>
                    <div class="glass-card p-6">
                        <h2 class="text-lg font-semibold flex items-center mb-6"><i class="fas fa-book text-amber-400 mr-3"></i>{{ t('apiDocs') }}</h2>
                        <a href="/docs" target="_blank" class="flex items-center space-x-2 text-indigo-400 hover:text-indigo-300 transition-colors mb-3">
                            <span>{{ t('openApiSwagger') }}</span><i class="fas fa-external-link-alt text-sm"></i>
                        </a>
                        <p class="text-xs text-gray-500">{{ t('interactiveApi') }}</p>
                    </div>
                </div>

                <!-- CLI Reference Section -->
                <div class="glass-card p-6">
                    <h2 class="text-lg font-semibold flex items-center mb-6"><i class="fas fa-terminal text-cyan-400 mr-3"></i>{{ t('cliReference') }}</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- ccb-cli Gateway Mode (NEW - Primary) -->
                        <div class="bg-gradient-to-br from-indigo-900/30 to-purple-900/30 rounded-xl p-5 border border-indigo-500/30">
                            <h3 class="font-medium text-indigo-400 mb-4 flex items-center">
                                <i class="fas fa-rocket mr-2"></i>ccb-cli (Gateway Mode)
                                <span class="ml-2 px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">{{ t('recommended') }}</span>
                            </h3>
                            <div class="space-y-3 font-mono text-sm">
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># Unified CLI - All calls go through Gateway</div>
                                    <div class="text-cyan-300">ccb-cli &lt;provider&gt; [model] "message"</div>
                                </div>
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># Examples with model shortcuts</div>
                                    <div class="text-cyan-300">ccb-cli kimi "你好"</div>
                                    <div class="text-cyan-300">ccb-cli kimi thinking "分析问题"</div>
                                    <div class="text-cyan-300">ccb-cli codex o3 "设计算法"</div>
                                    <div class="text-cyan-300">ccb-cli gemini 3f "React 组件"</div>
                                    <div class="text-cyan-300">ccb-cli deepseek chat "快速问答"</div>
                                </div>
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># Direct mode (bypass Gateway)</div>
                                    <div class="text-cyan-300">CCB_DIRECT_MODE=1 ccb-cli kimi "msg"</div>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
                                <div class="text-xs text-emerald-400 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Features: Caching, Retry, Monitoring, Logging
                                </div>
                            </div>
                        </div>
                        <!-- Sync API Mode -->
                        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
                            <h3 class="font-medium text-amber-400 mb-4 flex items-center"><i class="fas fa-sync mr-2"></i>{{ t('syncApiTitle') }}</h3>
                            <div class="space-y-3 font-mono text-sm">
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># Sync call - wait for completion</div>
                                    <div class="text-cyan-300 text-xs">curl -X POST "/api/ask?wait=true" \</div>
                                    <div class="text-cyan-300 text-xs ml-2">-d '{"provider":"kimi","message":"hi"}'</div>
                                </div>
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># With timeout (seconds)</div>
                                    <div class="text-cyan-300 text-xs">/api/ask?wait=true&timeout=120</div>
                                </div>
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># Response includes full result</div>
                                    <div class="text-emerald-300 text-xs">{"status":"completed",</div>
                                    <div class="text-emerald-300 text-xs ml-1">"response":"Hello!",</div>
                                    <div class="text-emerald-300 text-xs ml-1">"latency_ms":1234}</div>
                                </div>
                            </div>
                        </div>
                        <!-- Async Workflow -->
                        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
                            <h3 class="font-medium text-emerald-400 mb-4 flex items-center"><i class="fas fa-bolt mr-2"></i>{{ t('asyncWorkflow') }}</h3>
                            <div class="space-y-3 font-mono text-sm">
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># Submit (returns immediately)</div>
                                    <div class="text-cyan-300">ccb-submit &lt;provider&gt; "msg"</div>
                                </div>
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># {{ t('checkStatus') }}</div>
                                    <div class="text-cyan-300">ccb-query status &lt;id&gt;</div>
                                </div>
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># {{ t('getResponse') }}</div>
                                    <div class="text-cyan-300">ccb-query get &lt;id&gt;</div>
                                </div>
                                <div class="bg-gray-900/50 rounded-lg p-3">
                                    <div class="text-gray-400 text-xs mb-1"># {{ t('listPending') }}</div>
                                    <div class="text-cyan-300">ccb-query pending</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Model Shortcuts Reference -->
                    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
                            <h3 class="font-medium text-purple-400 mb-4 flex items-center"><i class="fas fa-magic mr-2"></i>{{ t('modelShortcuts') }}</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-gray-400 text-xs">
                                            <th class="text-left py-2">{{ t('provider') }}</th>
                                            <th class="text-left py-2">{{ t('shortcuts') }}</th>
                                            <th class="text-left py-2">{{ t('speed') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="font-mono text-cyan-300">
                                        <tr class="border-t border-gray-700/50"><td class="py-2 text-white">Kimi</td><td>thinking, normal</td><td class="text-emerald-400">🚀 Fast</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 text-white">Qwen</td><td>-</td><td class="text-emerald-400">🚀 Fast</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 text-white">DeepSeek</td><td>reasoner, chat</td><td class="text-amber-400">⚡ Medium</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 text-white">iFlow</td><td>thinking, normal</td><td class="text-amber-400">⚡ Medium</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 text-white">OpenCode</td><td>mm, kimi, ds, glm</td><td class="text-amber-400">⚡ Medium</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 text-white">Codex</td><td>o3, o4-mini, gpt-4o</td><td class="text-rose-400">🐢 Slow</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 text-white">Gemini</td><td>3f, 3p, 2.5f, 2.5p</td><td class="text-rose-400">🐢 Slow</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
                            <h3 class="font-medium text-cyan-400 mb-4 flex items-center"><i class="fas fa-users mr-2"></i>{{ t('providerGroups') }}</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-gray-400 text-xs">
                                            <th class="text-left py-2">{{ t('group') }}</th>
                                            <th class="text-left py-2">{{ t('providers') }}</th>
                                            <th class="text-left py-2">{{ t('useCase') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-300">
                                        <tr class="border-t border-gray-700/50"><td class="py-2 font-mono text-indigo-400">@all</td><td class="text-xs">{{ t('allProviders7') }}</td><td class="text-xs">{{ t('comprehensive') }}</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 font-mono text-emerald-400">@fast</td><td class="text-xs">Kimi, Qwen</td><td class="text-xs">{{ t('quickResponses') }}</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 font-mono text-purple-400">@coding</td><td class="text-xs">Kimi, Qwen, DS, Codex, Gemini</td><td class="text-xs">{{ t('codeTasks') }}</td></tr>
                                        <tr class="border-t border-gray-700/50"><td class="py-2 font-mono text-amber-400">@chinese</td><td class="text-xs">Kimi, Qwen, DeepSeek</td><td class="text-xs">{{ t('chineseNlp') }}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Keys Section -->
                <div v-show="settingsSubTab === 'keys'" class="space-y-6">
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold flex items-center"><i class="fas fa-key text-amber-400 mr-3"></i>{{ t('apiKeys') }}</h2>
                            <button @click="showCreateKeyModal = true" class="btn-primary"><i class="fas fa-plus mr-2"></i>{{ t('createKey') }}</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>{{ t('keyId') }}</th>
                                        <th>{{ t('name') }}</th>
                                        <th>{{ t('createdAt') }}</th>
                                        <th>{{ t('lastUsed') }}</th>
                                        <th>{{ t('rateLimit') }}</th>
                                        <th>{{ t('status') }}</th>
                                        <th>{{ t('actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="key in apiKeys" :key="key.key_id">
                                        <td class="font-mono text-sm">{{ key.key_id }}</td>
                                        <td class="font-medium">{{ key.name }}</td>
                                        <td class="text-sm text-gray-400">{{ formatTime(key.created_at) }}</td>
                                        <td class="text-sm text-gray-400">{{ key.last_used_at ? formatTime(key.last_used_at) : t('never') }}</td>
                                        <td>{{ key.rate_limit_rpm || t('default') }}</td>
                                        <td><span :class="key.enabled ? 'badge-success' : 'badge-error'" class="badge">{{ key.enabled ? t('activeStatus') : t('disabled') }}</span></td>
                                        <td>
                                            <div class="flex space-x-2">
                                                <button @click="toggleKey(key)" :class="key.enabled ? 'bg-amber-500/20 text-amber-400 hover:bg-amber-500/30' : 'bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30'" class="text-xs py-1 px-2 rounded-lg">{{ key.enabled ? t('disable') : t('enable') }}</button>
                                                <button @click="showConfirmDialog(t('deleteKey'), t('confirmDeleteKey'), () => deleteKey(key.key_id))" class="text-xs py-1 px-2 bg-rose-500/20 text-rose-400 rounded-lg hover:bg-rose-500/30">{{ t('delete') }}</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div v-if="newApiKey" class="glass-card p-6 border-emerald-500/30 bg-emerald-500/5">
                        <div class="font-semibold text-emerald-400 mb-2 flex items-center"><i class="fas fa-check-circle mr-2"></i>{{ t('newKeyCreated') }}</div>
                        <div class="text-sm text-gray-300 mb-3">{{ t('saveKeyNow') }}</div>
                        <div class="flex items-center space-x-3">
                            <div class="flex-1 bg-gray-900/50 p-4 rounded-xl font-mono text-sm break-all select-all border border-gray-700">{{ newApiKey }}</div>
                            <button @click="copyToClipboard(newApiKey)" class="btn-primary py-3 px-4"><i class="fas fa-copy mr-2"></i>{{ t('copy') }}</button>
                        </div>
                        <button @click="newApiKey = null" class="mt-4 btn-secondary text-sm">{{ t('dismiss') }}</button>
                    </div>
                </div>
            </div>

            <!-- Compare Tab merged into Dashboard -->
        </main>

        <!-- Modals -->
        <!-- Keyboard Shortcuts Modal -->
        <div v-if="showShortcuts" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showShortcuts = false">
            <div class="modal-content p-6 w-96 fade-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold flex items-center"><i class="fas fa-keyboard text-indigo-400 mr-3"></i>{{ t('keyboardShortcuts') }}</h3>
                    <button @click="showShortcuts = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between py-2 border-b border-gray-700/50"><span>{{ t('dashboard') }}</span><kbd class="kbd">1</kbd></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50"><span>{{ t('requests') }}</span><kbd class="kbd">2</kbd></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50"><span>{{ t('test') }}</span><kbd class="kbd">3</kbd></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50"><span>{{ t('compare') }}</span><kbd class="kbd">4</kbd></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50"><span>{{ t('keys') }}</span><kbd class="kbd">5</kbd></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50"><span>{{ t('config') }}</span><kbd class="kbd">6</kbd></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50"><span>{{ t('refresh') }}</span><kbd class="kbd">R</kbd></div>
                    <div class="flex justify-between py-2"><span>{{ t('closeModal') }}</span><kbd class="kbd">Esc</kbd></div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="fixed bottom-6 right-6 space-y-3 z-50">
            <div v-for="(toast, i) in toasts" :key="i" class="slide-in px-5 py-3 rounded-xl shadow-2xl flex items-center space-x-3 backdrop-blur-xl"
                 :class="toast.type === 'success' ? 'bg-emerald-500/90' : toast.type === 'error' ? 'bg-rose-500/90' : toast.type === 'warn' ? 'bg-amber-500/90' : 'bg-indigo-500/90'">
                <i :class="toast.type === 'success' ? 'fas fa-check-circle' : toast.type === 'error' ? 'fas fa-times-circle' : toast.type === 'warn' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle'"></i>
                <span class="flex-1 font-medium">{{ toast.message }}</span>
                <button @click="removeToast(i)" class="text-white/70 hover:text-white text-lg">&times;</button>
            </div>
        </div>

        <!-- Confirm Dialog -->
        <div v-if="confirmDialog.show" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="confirmDialog.show = false">
            <div class="modal-content p-6 w-96 fade-up">
                <h3 class="text-lg font-semibold mb-3">{{ confirmDialog.title }}</h3>
                <p class="text-gray-400 mb-6">{{ confirmDialog.message }}</p>
                <div class="flex justify-end space-x-3">
                    <button @click="confirmDialog.show = false" class="btn-secondary">{{ t('cancelBtn') }}</button>
                    <button @click="executeConfirmAction" class="bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-xl transition-colors">{{ t('confirm') }}</button>
                </div>
            </div>
        </div>

        <!-- Create Key Modal -->
        <div v-if="showCreateKeyModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="modal-content p-6 w-96 fade-up">
                <h3 class="text-lg font-semibold mb-6 flex items-center"><i class="fas fa-key text-amber-400 mr-3"></i>{{ t('createApiKey') }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">{{ t('name') }}</label>
                        <input v-model="newKeyName" type="text" class="input-field" :placeholder="t('myApiKey')">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">{{ t('rateLimitRpm') }}</label>
                        <input v-model.number="newKeyRateLimit" type="number" class="input-field" :placeholder="t('leaveEmpty')">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showCreateKeyModal = false" class="btn-secondary">{{ t('cancelBtn') }}</button>
                    <button @click="createKey" class="btn-primary">{{ t('create') }}</button>
                </div>
            </div>
        </div>

        <!-- Save Template Modal -->
        <div v-if="showSaveTemplateModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
            <div class="modal-content p-6 w-96 fade-up">
                <h3 class="text-lg font-semibold mb-6 flex items-center"><i class="fas fa-save text-emerald-400 mr-3"></i>{{ t('saveTemplate') }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">{{ t('templateName') }}</label>
                        <input v-model="newTemplateName" type="text" class="input-field" :placeholder="t('enterTemplateName')">
                    </div>
                    <div class="text-sm text-gray-400">
                        <div class="mb-2">{{ t('templatePreview') }}:</div>
                        <div class="bg-gray-800/50 rounded-xl p-3 space-y-1">
                            <div><span class="text-gray-500">{{ t('provider') }}:</span> {{ testForm.provider || t('autoDefault') }}</div>
                            <div><span class="text-gray-500">{{ t('message') }}:</span> {{ testForm.message.slice(0, 50) }}{{ testForm.message.length > 50 ? '...' : '' }}</div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showSaveTemplateModal = false" class="btn-secondary">{{ t('cancelBtn') }}</button>
                    <button @click="saveTemplate" class="btn-primary">{{ t('save') }}</button>
                </div>
            </div>
        </div>

        <!-- Alert Settings Modal -->
        <div v-if="showAlertSettings" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showAlertSettings = false">
            <div class="modal-content p-6 w-[450px] fade-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold flex items-center"><i class="fas fa-bell text-amber-400 mr-3"></i>{{ t('alertSettings') }}</h3>
                    <button @click="showAlertSettings = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <div class="provider-card">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-medium">{{ t('highLatencyAlert') }}</span>
                            <div @click="alerts.highLatency.enabled = !alerts.highLatency.enabled" :class="['toggle-switch', alerts.highLatency.enabled ? 'active' : '']"></div>
                        </div>
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-gray-400">{{ t('threshold') }}:</span>
                            <input type="number" v-model.number="alerts.highLatency.threshold" class="input-field w-24 text-sm">
                            <span class="text-gray-400">ms</span>
                        </div>
                    </div>
                    <div class="provider-card">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-medium">{{ t('lowSuccessRateAlert') }}</span>
                            <div @click="alerts.lowSuccessRate.enabled = !alerts.lowSuccessRate.enabled" :class="['toggle-switch', alerts.lowSuccessRate.enabled ? 'active' : '']"></div>
                        </div>
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-gray-400">{{ t('threshold') }}:</span>
                            <input type="number" v-model.number="alerts.lowSuccessRate.threshold" step="0.01" min="0" max="1" class="input-field w-24 text-sm">
                            <span class="text-gray-400">(0-1)</span>
                        </div>
                    </div>
                    <div class="provider-card">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-medium">{{ t('queueDepthAlert') }}</span>
                            <div @click="alerts.queueDepth.enabled = !alerts.queueDepth.enabled" :class="['toggle-switch', alerts.queueDepth.enabled ? 'active' : '']"></div>
                        </div>
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-gray-400">{{ t('threshold') }}:</span>
                            <input type="number" v-model.number="alerts.queueDepth.threshold" class="input-field w-24 text-sm">
                            <span class="text-gray-400">{{ t('requests') }}</span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button @click="saveAlerts" class="btn-primary">{{ t('save') }}</button>
                </div>
            </div>
        </div>

        <!-- Warmup Modal -->
        <div v-if="showWarmupModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showWarmupModal = false">
            <div class="modal-content p-6 w-[550px] max-h-[80vh] overflow-auto fade-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold flex items-center"><i class="fas fa-fire text-amber-400 mr-3"></i>{{ t('warmupAllCLIs') }}</h3>
                    <button @click="showWarmupModal = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
                </div>

                <div class="mb-6">
                    <p class="text-gray-400 text-sm mb-4">{{ t('warmupDescription') }}</p>
                    <div class="space-y-2">
                        <label class="block text-sm text-gray-400 mb-2">{{ t('warmupMessage') }}</label>
                        <textarea v-model="warmupMessage" class="input-field h-20 resize-none" :placeholder="t('enterWarmupMessage')"></textarea>
                    </div>
                </div>

                <!-- Provider Selection -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm text-gray-400">{{ t('selectProviders') }}</span>
                        <button @click="toggleAllWarmupProviders" class="text-xs text-indigo-400 hover:text-indigo-300">
                            {{ warmupProviders.every(p => p.selected) ? t('deselectAll') : t('selectAll') }}
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div v-for="provider in warmupProviders" :key="provider.name"
                             @click="provider.selected = !provider.selected"
                             :class="['provider-card cursor-pointer transition-all p-3', provider.selected ? 'border-indigo-500/50 bg-indigo-500/10' : '']">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <i :class="['fas', provider.selected ? 'fa-check-circle text-indigo-400' : 'fa-circle text-gray-600']"></i>
                                    <span class="font-medium">{{ provider.name }}</span>
                                </div>
                                <span v-if="provider.status" :class="getWarmupStatusClass(provider.status)" class="text-xs">
                                    <i :class="getWarmupStatusIcon(provider.status)"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warmup Results -->
                <div v-if="warmupResults.length > 0" class="mb-6">
                    <div class="text-sm text-gray-400 mb-3">{{ t('warmupResults') }}</div>
                    <div class="space-y-2 max-h-48 overflow-auto">
                        <div v-for="result in warmupResults" :key="result.provider"
                             :class="['p-3 rounded-lg border', result.success ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-rose-500/10 border-rose-500/30']">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <i :class="result.success ? 'fas fa-check-circle text-emerald-400' : 'fas fa-times-circle text-rose-400'"></i>
                                    <span class="font-medium">{{ result.provider }}</span>
                                </div>
                                <span class="text-sm" :class="result.success ? 'text-emerald-400' : 'text-rose-400'">
                                    {{ result.success ? formatLatency(result.latency) : result.error }}
                                </span>
                            </div>
                            <div v-if="result.success && result.response" class="mt-2 text-xs text-gray-400 truncate">
                                {{ result.response.slice(0, 100) }}{{ result.response.length > 100 ? '...' : '' }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        {{ warmupProviders.filter(p => p.selected).length }} {{ t('providersSelected') }}
                    </div>
                    <div class="flex space-x-3">
                        <button @click="showWarmupModal = false" class="btn-secondary">{{ t('close') }}</button>
                        <button @click="runWarmup" :disabled="warmupRunning || warmupProviders.filter(p => p.selected).length === 0"
                                :class="['btn-primary flex items-center space-x-2', warmupRunning ? 'opacity-50 cursor-not-allowed' : '']">
                            <i :class="warmupRunning ? 'fas fa-spinner fa-spin' : 'fas fa-fire'"></i>
                            <span>{{ warmupRunning ? t('warming') : t('startWarmup') }}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Discussion Modal -->
        <div v-if="showNewDiscussionModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showNewDiscussionModal = false">
            <div class="modal-content p-6 w-[550px] max-h-[80vh] overflow-auto fade-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold flex items-center"><i class="fas fa-comments text-purple-400 mr-3"></i>{{ t('newDiscussion') }}</h3>
                    <button @click="showNewDiscussionModal = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">{{ t('discussionTopic') }}</label>
                        <textarea v-model="newDiscussionTopic" class="input-field h-24 resize-none" :placeholder="t('enterTopic')"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-2">{{ t('selectDiscussionProviders') }}</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label v-for="p in availableDiscussionProviders" :key="p"
                                   class="flex items-center space-x-2 p-2 rounded-lg border cursor-pointer transition-all"
                                   :class="newDiscussionProviders.includes(p) ? 'border-purple-500 bg-purple-500/10' : 'border-gray-700 hover:border-gray-600'">
                                <input type="checkbox" :value="p" v-model="newDiscussionProviders" class="w-4 h-4 rounded">
                                <span class="text-sm">{{ getProviderTierIcon(p) }} {{ p }}</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" v-model="newDiscussionQuickMode" class="w-4 h-4 rounded">
                            <span class="text-sm text-gray-400">{{ t('quickMode') }}</span>
                        </label>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showNewDiscussionModal = false" class="btn-secondary">{{ t('close') }}</button>
                    <button @click="startNewDiscussion" :disabled="!newDiscussionTopic || newDiscussionProviders.length < 2 || startingDiscussion"
                            :class="['btn-primary flex items-center space-x-2', (!newDiscussionTopic || newDiscussionProviders.length < 2 || startingDiscussion) ? 'opacity-50 cursor-not-allowed' : '']">
                        <i :class="startingDiscussion ? 'fas fa-spinner fa-spin' : 'fas fa-play'"></i>
                        <span>{{ startingDiscussion ? t('starting') : t('startDiscussion') }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- B2: Discussion Template Selector Modal -->
        <div v-if="showTemplateModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showTemplateModal = false; clearTemplateSelection();">
            <div class="modal-content p-6 w-[600px] max-h-[80vh] overflow-auto fade-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-magic text-purple-400 mr-3"></i>Start Discussion from Template
                    </h3>
                    <button @click="showTemplateModal = false; clearTemplateSelection();" class="text-gray-400 hover:text-white text-xl">&times;</button>
                </div>

                <div class="space-y-4">
                    <!-- Template Selection -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">{{ t('selectTemplate') }}</label>
                        <select v-model="selectedDiscussionTemplate" @change="selectDiscussionTemplate(selectedDiscussionTemplate)"
                                class="input-field w-full">
                            <option value="">-- {{ t('chooseTemplate') }} --</option>
                            <optgroup v-for="category in [...new Set(discussionTemplates.map(t => t.category || 'Other'))]" :key="category" :label="category">
                                <option v-for="t in discussionTemplates.filter(tmpl => (tmpl.category || 'Other') === category)"
                                        :key="t.id" :value="t.id">
                                    {{ t.name }}
                                </option>
                            </optgroup>
                        </select>
                        <div v-if="selectedDiscussionTemplate" class="mt-2 p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                            <p class="text-sm text-gray-400">
                                {{ discussionTemplates.find(t => t.id === selectedDiscussionTemplate)?.description }}
                            </p>
                        </div>
                    </div>

                    <!-- Template Variables -->
                    <div v-if="Object.keys(templateVariables).length > 0" class="space-y-3">
                        <label class="block text-sm text-gray-400 mb-2">{{ t('fillInDetails') }}</label>
                        <div v-for="(value, key) in templateVariables" :key="key">
                            <label class="block text-xs text-gray-500 mb-1 capitalize">{{ key.replace(/_/g, ' ') }}</label>
                            <textarea v-model="templateVariables[key]"
                                      class="input-field h-20 resize-none w-full"
                                      :placeholder="`Enter ${key}...`"></textarea>
                        </div>
                    </div>

                    <!-- Provider Selection -->
                    <div v-if="selectedDiscussionTemplate">
                        <label class="block text-sm text-gray-400 mb-2">{{ t('participatingProviders') }}</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label v-for="p in availableDiscussionProviders" :key="p"
                                   class="flex items-center space-x-2 p-2 rounded-lg border cursor-pointer transition-all"
                                   :class="newDiscussionProviders.includes(p) ? 'border-purple-500 bg-purple-500/10' : 'border-gray-700 hover:border-gray-600'">
                                <input type="checkbox" :value="p" v-model="newDiscussionProviders" class="w-4 h-4 rounded">
                                <span class="text-sm">{{ getProviderTierIcon(p) }} {{ p }}</span>
                            </label>
                        </div>
                    </div>

                    <!-- Quick Mode -->
                    <div v-if="selectedDiscussionTemplate" class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" v-model="newDiscussionQuickMode" class="w-4 h-4 rounded">
                            <span class="text-sm text-gray-400">Quick Mode (2 rounds only)</span>
                        </label>
                    </div>

                    <!-- Loading State -->
                    <div v-if="loadingTemplates" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-3xl text-purple-400"></i>
                        <p class="text-sm text-gray-400 mt-3">{{ t('loadingTemplates') }}</p>
                    </div>

                    <!-- Empty State -->
                    <div v-if="!loadingTemplates && discussionTemplates.length === 0" class="text-center py-8 text-gray-500">
                        <i class="fas fa-folder-open text-4xl mb-3"></i>
                        <p class="text-sm">{{ t('noTemplatesAvailable') }}</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showTemplateModal = false; clearTemplateSelection();" class="btn-secondary">{{ t('cancel') }}</button>
                    <button @click="startDiscussionFromTemplate"
                            :disabled="!selectedDiscussionTemplate || Object.values(templateVariables).some(v => !v) || newDiscussionProviders.length < 2 || startingDiscussion"
                            :class="['btn-primary flex items-center space-x-2',
                                     (!selectedDiscussionTemplate || Object.values(templateVariables).some(v => !v) || newDiscussionProviders.length < 2 || startingDiscussion) ? 'opacity-50 cursor-not-allowed' : '']">
                        <i :class="startingDiscussion ? 'fas fa-spinner fa-spin' : 'fas fa-rocket'"></i>
                        <span>{{ startingDiscussion ? t('starting') : t('startDiscussion') }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Request Detail Modal -->
        <div v-if="selectedRequest" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="selectedRequest = null">
            <div class="modal-content p-6 w-[600px] max-h-[80vh] overflow-auto fade-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold flex items-center"><i class="fas fa-info-circle text-indigo-400 mr-3"></i>{{ t('requestDetails') }}</h3>
                    <button @click="selectedRequest = null" class="text-gray-400 hover:text-white text-xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><span class="text-gray-400 text-sm">{{ t('id') }}:</span><div class="font-mono text-indigo-400">{{ selectedRequest.id }}</div></div>
                        <div><span class="text-gray-400 text-sm">{{ t('provider') }}:</span><div><span class="badge badge-info">{{ selectedRequest.provider }}</span></div></div>
                        <div><span class="text-gray-400 text-sm">{{ t('agent') }}:</span><div>
                            <span v-if="selectedRequest.metadata?.agent" class="badge bg-purple-500/20 text-purple-300 border-purple-500/30">
                                {{ getAgentIcon(selectedRequest.metadata.agent) }} {{ selectedRequest.metadata.agent }}
                            </span>
                            <span v-else class="text-gray-500">-</span>
                        </div></div>
                        <div><span class="text-gray-400 text-sm">{{ t('status') }}:</span><div><span :class="getRequestStatusClass(selectedRequest.status)" class="badge">{{ selectedRequest.status }}</span></div></div>
                        <div><span class="text-gray-400 text-sm">{{ t('created') }}:</span><div>{{ formatTime(selectedRequest.created_at) }}</div></div>
                    </div>
                    <div>
                        <span class="text-gray-400 text-sm block mb-2">{{ t('message') }}:</span>
                        <pre class="bg-gray-900/50 rounded-xl p-4 text-sm overflow-auto max-h-32 font-mono">{{ selectedRequest.message }}</pre>
                    </div>
                    <div v-if="selectedRequest.response">
                        <span class="text-gray-400 text-sm block mb-2">{{ t('response') }}:</span>
                        <pre class="bg-gray-900/50 rounded-xl p-4 text-sm overflow-auto max-h-48 font-mono text-emerald-300">{{ selectedRequest.response }}</pre>
                    </div>
                    <div v-if="selectedRequestResponse?.thinking">
                        <span class="text-gray-400 text-sm block mb-2 flex items-center">
                            <i class="fas fa-brain text-purple-400 mr-2"></i>{{ t('thinking') }}:
                        </span>
                        <pre class="bg-purple-900/20 border border-purple-500/30 rounded-xl p-4 text-sm overflow-auto max-h-48 font-mono text-purple-300">{{ selectedRequestResponse.thinking }}</pre>
                    </div>
                    <div v-if="selectedRequestResponse?.raw_output">
                        <details class="group">
                            <summary class="text-gray-400 text-sm cursor-pointer hover:text-gray-300 flex items-center">
                                <i class="fas fa-terminal text-cyan-400 mr-2"></i>{{ t('rawOutput') }}
                                <i class="fas fa-chevron-right ml-2 text-xs transition-transform group-open:rotate-90"></i>
                            </summary>
                            <pre class="mt-2 bg-gray-900/50 rounded-xl p-4 text-sm overflow-auto max-h-64 font-mono text-gray-400">{{ selectedRequestResponse.raw_output }}</pre>
                        </details>
                    </div>
                    <div v-if="selectedRequest.error">
                        <span class="text-gray-400 text-sm block mb-2">{{ t('error') }}:</span>
                        <pre class="bg-gray-900/50 rounded-xl p-4 text-sm overflow-auto max-h-32 font-mono text-rose-300">{{ selectedRequest.error }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // State
                const connected = ref(false);
                const activeTab = ref('dashboard');
                const status = ref({ gateway: {}, providers: [] });
                const requests = ref([]);
                const apiKeys = ref([]);
                const authConfig = ref({});
                const rateLimitConfig = ref({});
                const retryConfig = ref({});
                const showCreateKeyModal = ref(false);
                const newKeyName = ref('');
                const newKeyRateLimit = ref(null);
                const newApiKey = ref(null);
                const activityLogs = ref([]);
                const requestFilter = ref('');
                const providerFilter = ref('');
                const searchQuery = ref('');
                const selectedRequest = ref(null);
                const selectedRequestResponse = ref(null);

                // Loading states
                const loading = ref({
                    status: false,
                    requests: false,
                    keys: false,
                    test: false,
                    discussions: false
                });

                // Pagination state
                const pagination = ref({
                    page: 1,
                    pageSize: 20
                });

                // Confirm dialog state
                const confirmDialog = ref({
                    show: false,
                    title: '',
                    message: '',
                    onConfirm: null
                });

                // Test panel state
                const testForm = ref({
                    provider: '',
                    message: 'Hello! Please respond with a short greeting.',
                    stream: false,
                    cacheBypass: false,
                    waitMode: true,
                    timeout: 120
                });
                const testSending = ref(false);
                const testResult = ref(null);

                // Test templates state
                const testTemplates = ref(JSON.parse(localStorage.getItem('ccb-test-templates') || '[]'));
                const selectedTemplate = ref('');
                const showSaveTemplateModal = ref(false);
                const showManageTemplatesModal = ref(false);
                const newTemplateName = ref('');

                // Compare tab state
                const radarChart = ref(null);
                const timelineChart = ref(null);
                let radarChartInstance = null;
                let timelineChartInstance = null;
                const timelineRange = ref('1h');

                // Monitor tab state
                const monitorStreams = ref({});  // { provider: { active: bool, output: string[], requestId: string } }
                const monitorAutoScroll = ref(true);
                const monitorLayout = ref('grid');  // 'grid' or 'focus'
                const monitorFocusProvider = ref(null);
                const liveRequests = ref([]);  // Currently processing requests
                const benchmarkMessage = ref('Hello! Please respond briefly.');
                const benchmarkRunning = ref(false);
                const benchmarkResults = ref([]);

                // Memory tab state
                const memoryStats = ref({});
                const memorySessions = ref([]);
                const memorySearchQuery = ref('');
                const memorySearchResults = ref([]);
                const selectedSession = ref(null);
                // v0.21: Memory Transparency
                const memoryInjections = ref([]);
                const selectedInjection = ref(null);
                // v0.21: Observations CRUD
                const observations = ref([]);
                const observationSearchQuery = ref('');
                const showAddObservationModal = ref(false);
                const newObservation = ref({ content: '', category: 'insight', tags: '' });
                const editingObservation = ref(null);
                // v0.21: Memory Config
                const memoryConfig = ref({
                    enabled: true,
                    auto_inject: true,
                    max_injected_memories: 5,
                    injection_strategy: 'recent_plus_relevant'
                });
                const showMemoryConfigModal = ref(false);
                // v0.21: Memory sub-tabs
                const memorySubTab = ref('sessions');  // 'sessions', 'observations', 'injections', 'discussions', 'system2', 'heuristic'
                // Settings sub-tab state (NEW)
                const settingsSubTab = ref('config');  // 'config', 'keys'
                // v0.21: Discussion memories
                const discussionMemories = ref([]);

                // v0.22: System 2 state
                const consolidatedMemories = ref([]);
                const consolidationStats = ref({
                    total_archives: 0,
                    total_consolidated: 0,
                    avg_importance: 0,
                    last_run: null
                });
                const showConsolidateModal = ref(false);
                const showForgetModal = ref(false);
                const system2Loading = ref(false);
                const consolidateOptions = ref({
                    hours: 24,
                    llm_enhanced: true
                });
                const forgetOptions = ref({
                    min_importance: 0.1,
                    max_age_days: 90
                });
                const system2Config = ref({
                    nightly_enabled: false,
                    llm_insights: true,
                    llm_provider: 'kimi'
                });

                // v0.22: Heuristic retrieval state
                const heuristicConfig = ref({
                    alpha: 0.4,
                    beta: 0.3,
                    gamma: 0.3,
                    lambda: 0.1
                });
                const memoryHealth = ref({
                    health_score: 0,
                    importance_distribution: { high: 0, medium: 0, low: 0 },
                    retrieval_performance: { avg_query_ms: 0, cache_hit_rate: 0, p95_ms: 0 }
                });
                const detailedStats = ref({
                    total_memories: 0,
                    total_access_count: 0,
                    avg_importance: 0,
                    freshness_score: 0
                });
                let heuristicConfigDebounceTimer = null;

                // Skills tab state
                const skillsStats = ref({});
                const skillsSearchQuery = ref('');
                const skillRecommendations = ref({ found: false, skills: [], message: '' });
                // v0.21: Skills Feedback
                const showSkillFeedbackModal = ref(false);
                const feedbackSkill = ref(null);
                const skillFeedback = ref({ rating: 5, helpful: true, task_description: '' });
                const allSkillsFeedback = ref([]);

                // UI state
                const showShortcuts = ref(false);
                const toasts = ref([]);
                const showAlertSettings = ref(false);
                const showExportMenu = ref(false);

                // Theme state
                const theme = ref(localStorage.getItem('ccb-theme') || 'dark');

                // Alert settings state
                const alerts = ref(JSON.parse(localStorage.getItem('ccb-alerts') || JSON.stringify({
                    highLatency: { enabled: true, threshold: 5000 },
                    lowSuccessRate: { enabled: true, threshold: 0.9 },
                    queueDepth: { enabled: true, threshold: 10 }
                })));

                // Warmup state
                const showWarmupModal = ref(false);
                const warmupRunning = ref(false);
                const warmupMessage = ref('Hello! Please respond with a brief greeting to confirm you are ready.');
                const warmupResults = ref([]);

                // B1: Cost tracking state
                const costSummary = ref({ today: {}, week: {}, month: {} });
                const costByProvider = ref([]);
                const costByDay = ref([]);
                const costChart = ref(null);
                let costChartInstance = null;
                const defaultProviderList = ['qoder', 'codex', 'gemini', 'opencode', 'iflow', 'kimi', 'qwen', 'deepseek'];
                const warmupProviders = ref(defaultProviderList.map(name => ({ name, selected: true, status: null })));

                // Discussion state
                const discussions = ref([]);
                const selectedDiscussion = ref(null);
                const discussionMessages = ref([]);
                const showNewDiscussionModal = ref(false);
                const newDiscussionTopic = ref('');
                const newDiscussionProviders = ref(['kimi', 'qwen', 'deepseek']);
                const newDiscussionQuickMode = ref(false);
                const startingDiscussion = ref(false);
                const availableDiscussionProviders = ['kimi', 'qwen', 'deepseek', 'iflow', 'codex', 'gemini'];

                // B2: Discussion templates state
                const discussionTemplates = ref([]);
                const selectedDiscussionTemplate = ref('');
                const templateVariables = ref({});
                const showTemplateModal = ref(false);
                const loadingTemplates = ref(false);

                // Cost tracking state
                const tokenPricing = {
                    claude: { input: 0.003, output: 0.015 },
                    qoder: { input: 0.001, output: 0.003 },
                    gemini: { input: 0.00025, output: 0.0005 },
                    openai: { input: 0.005, output: 0.015 },
                    default: { input: 0.001, output: 0.002 }
                };

                // i18n - Language support
                const lang = ref(localStorage.getItem('ccb-lang') || 'en');
                const i18n = {
                    en: {
                        // Header
                        connected: 'Connected', disconnected: 'Disconnected', uptime: 'Uptime', switchLang: 'Switch Language',
                        // Tabs
                        dashboard: 'Dashboard', monitor: 'Monitor', memory: 'Memory', skills: 'Skills',
                        discussions: 'Discussions', requests: 'Requests', costs: 'Costs',
                        test: 'Test', compare: 'Compare', keys: 'API Keys', config: 'Config',
                        // Skills tab
                        totalSkills: 'Total Skills', installed: 'Installed', searchSkills: 'Search skills...',
                        totalUses: 'Total Uses',
                        // Memory tab
                        searchAccuracy: 'Search Accuracy', searchConversations: 'Search Conversations',
                        noSessionsFound: 'No sessions found', startConversationHint: 'Start a conversation to create memory sessions',
                        noSkillsUsed: 'No skills used yet', startUsingSkillsHint: 'Start using skills to see statistics',
                        noCostData: 'No cost data available',
                        // Dashboard cards
                        totalRequests: 'Total Requests', allTime: 'All time', active: 'Active', processingNow: 'Processing now',
                        queue: 'Queue', waiting: 'Waiting', cacheHit: 'Cache Hit', hits: 'hits', providers: 'Providers', healthy: 'Healthy',
                        // Charts
                        latencyDistribution: 'Request Latency Distribution', last100: 'Last 100 requests',
                        statusDistribution: 'Request Status Distribution', currentSession: 'Current session',
                        // Provider status
                        providerStatus: 'Provider Status', latency: 'Latency', success: 'Success', enabled: 'Enabled', yes: 'Yes', no: 'No',
                        // Activity log
                        activityLog: 'Activity Log', clear: 'Clear', noActivity: 'No activity yet...',
                        // Features
                        features: 'Features',
                        // Requests tab
                        recentRequests: 'Recent Requests', allStatus: 'All Status', queued: 'Queued', processing: 'Processing',
                        completed: 'Completed', failed: 'Failed', allProviders: 'All Providers', refresh: 'Refresh',
                        id: 'ID', provider: 'Provider', agent: 'Agent', status: 'Status', message: 'Message', created: 'Created', actions: 'Actions',
                        view: 'View', cancel: 'Cancel', noRequests: 'No requests found',
                        // Test tab
                        quickTest: 'Quick Test', autoDefault: 'Auto (Default)', parallel: 'Parallel', fastProviders: 'Fast Providers 🚀',
                        mediumProviders: 'Medium Providers ⚡', slowProviders: 'Slow Providers 🐢', chineseProviders: 'Chinese Providers',
                        codingProviders: 'Coding Providers', allProvidersGroup: 'All Providers @all',
                        enterMessage: 'Enter your test message...', stream: 'Stream', bypassCache: 'Bypass Cache',
                        sendTest: 'Send Test Request', sending: 'Sending...', result: 'Result', requestId: 'Request ID',
                        cached: 'Cached', response: 'Response', sendToSee: 'Send a test request to see results',
                        // Compare tab
                        providerComparison: 'Provider Comparison', performanceMetrics: 'Performance Metrics',
                        avgLatency: 'Avg Latency', successRate: 'Success Rate', score: 'Score',
                        requestTimeline: 'Request Timeline', last1h: 'Last 1 Hour', last6h: 'Last 6 Hours', last24h: 'Last 24 Hours',
                        quickBenchmark: 'Quick Benchmark', enterBenchmark: 'Enter test message for benchmark...',
                        runBenchmark: 'Run Benchmark', running: 'Running...',
                        // API Keys tab
                        apiKeys: 'API Keys', createKey: '+ Create Key', keyId: 'Key ID', name: 'Name',
                        createdAt: 'Created', lastUsed: 'Last Used', rateLimit: 'Rate Limit', never: 'Never', default: 'Default',
                        activeStatus: 'Active', disabled: 'Disabled', disable: 'Disable', enable: 'Enable', delete: 'Delete',
                        newKeyCreated: 'New API Key Created', saveKeyNow: "Save this key now - it won't be shown again!",
                        dismiss: 'Dismiss', createApiKey: 'Create API Key', rateLimitRpm: 'Rate Limit (RPM, optional)',
                        leaveEmpty: 'Leave empty for default', cancelBtn: 'Cancel', create: 'Create',
                        // Config tab
                        authentication: 'Authentication', rateLimiting: 'Rate Limiting', retryFallback: 'Retry & Fallback',
                        cacheStats: 'Cache Statistics', prometheusMetrics: 'Prometheus Metrics', apiDocs: 'API Documentation',
                        cliReference: 'CLI Reference', asyncWorkflow: 'Async Workflow', blockingCall: 'Blocking Call',
                        checkStatus: 'Check Status', getResponse: 'Get Response', listPending: 'List Pending',
                        getLatest: 'Get Latest', pingProvider: 'Ping Provider',
                        requestsPerMin: 'Requests/min', burstSize: 'Burst Size', retryEnabled: 'Retry Enabled',
                        maxRetries: 'Max Retries', fallbackEnabled: 'Fallback Enabled', misses: 'Misses',
                        totalEntries: 'Total Entries', tokensSaved: 'Tokens Saved', viewRawMetrics: 'View Raw Metrics',
                        endpoint: 'Endpoint', openApiSwagger: 'OpenAPI / Swagger UI', interactiveApi: 'Interactive API documentation',
                        headerName: 'Header', allowLocalhost: 'Allow Localhost',
                        // Request detail modal
                        requestDetails: 'Request Details', thinking: 'Thinking Chain', rawOutput: 'Raw Output',
                        // Shortcuts modal
                        keyboardShortcuts: 'Keyboard Shortcuts', closeModal: 'Close Modal',
                        // Misc
                        exportSuccess: 'Data exported successfully', refreshed: 'Refreshed', benchmarkComplete: 'Benchmark completed',
                        // Phase 8A additions
                        copy: 'Copy', copyToClipboard: 'Copy to clipboard', copiedToClipboard: 'Copied to clipboard!',
                        searchRequests: 'Search requests...', showing: 'Showing', of: 'of', perPage: 'per page',
                        confirm: 'Confirm', deleteKey: 'Delete API Key', confirmDeleteKey: 'Are you sure you want to delete this API key? This action cannot be undone.',
                        cancelRequest: 'Cancel Request', confirmCancelRequest: 'Are you sure you want to cancel this request?',
                        retry: 'Retry', requestRetried: 'Request retried successfully',
                        // Phase 8B additions
                        selectTemplate: 'Select template...', saveTemplate: 'Save Template', templateName: 'Template Name',
                        enterTemplateName: 'Enter template name', templatePreview: 'Preview', save: 'Save',
                        templateSaved: 'Template saved', templateLoaded: 'Template loaded', templateDeleted: 'Template deleted',
                        manageTemplates: 'Manage Templates', noTemplates: 'No templates saved',
                        chooseTemplate: 'Choose a template', fillInDetails: 'Fill in Details',
                        // Error messages
                        failedToCopy: 'Failed to copy to clipboard', failedToRetry: 'Failed to retry request',
                        failedToFetch: 'Failed to fetch requests', failedToDelete: 'Failed to delete API key',
                        keyDeleted: 'API key deleted',
                        // Phase 8C additions
                        cacheManagement: 'Cache Management', clearCache: 'Clear Cache', clearAll: 'Clear All',
                        cleanup: 'Cleanup', cleanupExpired: 'Cleanup expired entries',
                        confirmClearCache: 'Are you sure you want to clear all cache entries? This cannot be undone.',
                        cacheCleared: 'Cache cleared successfully', failedToClearCache: 'Failed to clear cache',
                        cleanupComplete: 'Cleanup complete', entriesRemoved: 'entries removed',
                        failedToCleanupCache: 'Failed to cleanup cache', hitRate: 'Hit Rate',
                        memorySaved: 'Memory Used', clickToDisable: 'Click to disable', clickToEnable: 'Click to enable',
                        failedToToggleProvider: 'Failed to toggle provider',
                        // Phase 8D additions
                        tokenUsage: 'Token Usage', tokensByProvider: 'Tokens by Provider',
                        inputTokens: 'Input', outputTokens: 'Output', total: 'Total',
                        estimatedCost: 'Est. Cost', toggleTheme: 'Toggle theme',
                        alertSettings: 'Alert Settings', highLatencyAlert: 'High Latency Alert',
                        lowSuccessRateAlert: 'Low Success Rate Alert', queueDepthAlert: 'Queue Depth Alert',
                        threshold: 'Threshold', items: 'items', saveSettings: 'Save Settings',
                        alertsSaved: 'Alert settings saved', highLatencyDetected: 'High latency detected',
                        lowSuccessRateDetected: 'Low success rate detected', highQueueDepthDetected: 'High queue depth detected',
                        // Warmup additions
                        warmup: 'Warmup', warmupAll: 'Warmup All CLIs', warmupAllCLIs: 'Warmup All CLIs',
                        warmupDescription: 'Send a warmup request to all selected AI providers to initialize their connections and reduce first-request latency.',
                        warmupMessage: 'Warmup Message', enterWarmupMessage: 'Enter warmup message...',
                        selectProviders: 'Select Providers', selectAll: 'Select All', deselectAll: 'Deselect All',
                        providersSelected: 'providers selected', startWarmup: 'Start Warmup', warming: 'Warming...',
                        warmupResults: 'Results', warmupComplete: 'Warmup complete', warmupFailed: 'Warmup failed',
                        close: 'Close',
                        // Monitor tab
                        liveMonitor: 'Live Monitor', autoScroll: 'Auto Scroll', gridView: 'Grid', focusView: 'Focus',
                        waitingForOutput: 'Waiting for output...', sendRequestToMonitor: 'Send a request to see live output',
                        noActiveStreams: 'No active streams', streamingOutput: 'Streaming Output',
                        // Discussions tab
                        discussions: 'Discussions', multiAiDiscussion: 'Multi-AI Discussion',
                        discussionTopic: 'Topic', discussionStatus: 'Status', discussionRound: 'Round',
                        discussionProviders: 'Providers', discussionCreated: 'Created',
                        noDiscussions: 'No discussions found', viewDiscussion: 'View',
                        discussionInProgress: 'In Progress', discussionCompleted: 'Completed',
                        discussionFailed: 'Failed', roundProposal: 'Proposal', roundReview: 'Review',
                        roundRevision: 'Revision', roundSummary: 'Summary',
                        discussionMessages: 'Messages', discussionSummary: 'Summary',
                        newDiscussion: 'New Discussion', startDiscussion: 'Start Discussion',
                        enterTopic: 'Enter discussion topic...', selectDiscussionProviders: 'Select Providers',
                        discussionRounds: 'Rounds', quickMode: 'Quick Mode (2 rounds)',
                        starting: 'Starting...', refreshDiscussions: 'Refresh',
                        // Memory & Skills tabs
                        recentSessions: 'Recent Sessions', topUsedSkills: 'Most Used Skills',
                        costByProvider: 'Cost by Provider', tokens: 'Tokens',
                        // v0.21: Memory enhancements
                        memorySubTabs: { sessions: 'Sessions', observations: 'Observations', injections: 'Injections', discussions: 'Discussions', system2: 'System 2', heuristic: 'Heuristic' },
                        memoryInjections: 'Memory Injections', injectedMemories: 'Injected Memories',
                        viewInjection: 'View Injection', noInjections: 'No injection records yet',
                        observations: 'Observations', addObservation: 'Add Observation',
                        editObservation: 'Edit', deleteObservation: 'Delete',
                        observationCategory: 'Category', observationTags: 'Tags',
                        insight: 'Insight', preference: 'Preference', fact: 'Fact',
                        noObservations: 'No observations recorded', saveObservation: 'Save',
                        memorySettings: 'Memory Settings', memoryEnabled: 'Memory Enabled',
                        autoInject: 'Auto Inject', maxInjected: 'Max Injected',
                        injectionStrategy: 'Injection Strategy', recent: 'Recent Only',
                        relevant: 'Relevant Only', recentPlusRelevant: 'Recent + Relevant',
                        configSaved: 'Configuration saved', configReset: 'Configuration reset',
                        discussionMemories: 'Saved Discussions', saveToMemory: 'Save to Memory',
                        savedToMemory: 'Saved to memory', noDiscussionMemories: 'No discussions saved',
                        // v0.21: Skills feedback
                        giveFeedback: 'Give Feedback', feedbackRating: 'Rating',
                        feedbackHelpful: 'Was it helpful?', feedbackTask: 'Task Description',
                        submitFeedback: 'Submit Feedback', feedbackSubmitted: 'Feedback submitted',
                        feedbackBoost: 'Feedback Boost',
                        // Discussion templates
                        loadingTemplates: 'Loading templates...', noTemplatesAvailable: 'No templates available',
                        // v0.22: Additional UI translations
                        multiAiOrchestrator: 'Multi-AI Orchestrator',
                        totalSessions: 'Total Sessions', totalMessages: 'Total Messages', totalTokensLabel: 'Total Tokens',
                        search: 'Search', foundResults: 'Found', results: 'results',
                        system2Operations: 'System 2 Operations', processingText: 'Processing...',
                        noConsolidatedMemories: 'No consolidated memories yet',
                        runConsolidationHint: 'Run consolidation to generate insights from your sessions',
                        scoreLabel: 'Score', sessionLabel: 'Session',
                        content: 'Content', reset: 'Reset',
                        runNightlyAuto: 'Run consolidation automatically at night',
                        useLlmInsights: 'Use LLM to generate insights from memories',
                        findSkillsForTask: 'Find Skills for Your Task',
                        findSkillsBtn: 'Find Skills', available: 'Available',
                        skillScore: 'Score', usedTimes: 'Used', times: 'times',
                        useTemplate: 'Use Template', exportData: 'Export',
                        costAnalysis: 'Cost Analysis',
                        today: 'Today', thisWeek: 'This Week', thisMonth: 'This Month',
                        dailyCostTrend: 'Daily Cost Trend (Last 7 Days)',
                        cost: 'Cost',
                        gatewayModeActive: 'Gateway Mode Active',
                        gatewayModeDesc: 'All requests go through Gateway API with caching, retry, and monitoring',
                        syncApi: 'Sync API', waitMode: 'Wait Mode',
                        timeoutSeconds: 'Timeout (seconds)',
                        syncMode: 'Sync Mode', waitingForResponse: 'Waiting for response...',
                        sendSync: 'Send (Sync)',
                        recommended: 'Recommended',
                        syncApiTitle: 'Sync API (wait=true)',
                        modelShortcuts: 'Model Shortcuts',
                        shortcuts: 'Shortcuts',
                        totalAccessCount: 'Total Access Count', avgImportance: 'Avg Importance',
                        freshnessScore: 'Freshness Score', totalMemories: 'Total Memories',
                        searchMessages: 'Search messages...',
                        enterObservation: 'Enter observation...',
                        whatTaskForSkill: 'What task did you use this skill for?',
                        myApiKey: 'My API Key', focus: 'Focus', requests: 'Requests',
                        // v0.22 additional
                        speed: 'Speed', providerGroups: 'Provider Groups', group: 'Group', useCase: 'Use Case',
                        allProviders7: 'All 7 providers', quickResponses: 'Quick responses', codeTasks: 'Code tasks',
                        comprehensive: 'Comprehensive', participatingProviders: 'Participating Providers',
                        skillSearchPlaceholder: 'E.g., create PDF, analyze data, test React...',
                        chineseNlp: 'Chinese NLP',
                    },
                    zh: {
                        // Header
                        connected: '已连接', disconnected: '已断开', uptime: '运行时间', switchLang: '切换语言',
                        // Tabs
                        dashboard: '仪表板', monitor: '监控', memory: '记忆', skills: '技能',
                        discussions: '讨论', requests: '请求', costs: '费用',
                        test: '测试', compare: '对比', keys: 'API 密钥', config: '配置',
                        // Skills tab
                        totalSkills: '总技能数', installed: '已安装', searchSkills: '搜索技能...',
                        totalUses: '总使用次数',
                        // Memory tab
                        searchAccuracy: '搜索准确率', searchConversations: '搜索对话',
                        noSessionsFound: '暂无会话', startConversationHint: '开始对话以创建记忆会话',
                        noSkillsUsed: '暂无已使用技能', startUsingSkillsHint: '开始使用技能以查看统计',
                        noCostData: '暂无费用数据',
                        // Dashboard cards
                        totalRequests: '总请求数', allTime: '累计', active: '活跃', processingNow: '正在处理',
                        queue: '队列', waiting: '等待中', cacheHit: '缓存命中', hits: '次', providers: '提供者', healthy: '健康',
                        // Charts
                        latencyDistribution: '请求延迟分布', last100: '最近 100 个请求',
                        statusDistribution: '请求状态分布', currentSession: '当前会话',
                        // Provider status
                        providerStatus: '提供者状态', latency: '延迟', success: '成功率', enabled: '启用', yes: '是', no: '否',
                        // Activity log
                        activityLog: '活动日志', clear: '清除', noActivity: '暂无活动...',
                        // Features
                        features: '功能',
                        // Requests tab
                        recentRequests: '最近请求', allStatus: '全部状态', queued: '排队中', processing: '处理中',
                        completed: '已完成', failed: '失败', allProviders: '全部提供者', refresh: '刷新',
                        id: 'ID', provider: '提供者', agent: 'Agent', status: '状态', message: '消息', created: '创建时间', actions: '操作',
                        view: '查看', cancel: '取消', noRequests: '未找到请求',
                        // Test tab
                        quickTest: '快速测试', autoDefault: '自动（默认）', parallel: '并行', fastProviders: '快速提供者 🚀',
                        mediumProviders: '中速提供者 ⚡', slowProviders: '慢速提供者 🐢', chineseProviders: '中文提供者',
                        codingProviders: '编程提供者', allProvidersGroup: '全部提供者 @all',
                        enterMessage: '输入测试消息...', stream: '流式', bypassCache: '绕过缓存',
                        sendTest: '发送测试请求', sending: '发送中...', result: '结果', requestId: '请求 ID',
                        cached: '已缓存', response: '响应', sendToSee: '发送测试请求以查看结果',
                        // Compare tab
                        providerComparison: '提供者对比', performanceMetrics: '性能指标',
                        avgLatency: '平均延迟', successRate: '成功率', score: '评分',
                        requestTimeline: '请求时间线', last1h: '最近 1 小时', last6h: '最近 6 小时', last24h: '最近 24 小时',
                        quickBenchmark: '快速基准测试', enterBenchmark: '输入基准测试消息...',
                        runBenchmark: '运行基准测试', running: '运行中...',
                        // API Keys tab
                        apiKeys: 'API 密钥', createKey: '+ 创建密钥', keyId: '密钥 ID', name: '名称',
                        createdAt: '创建时间', lastUsed: '最后使用', rateLimit: '速率限制', never: '从未', default: '默认',
                        activeStatus: '活跃', disabled: '已禁用', disable: '禁用', enable: '启用', delete: '删除',
                        newKeyCreated: '新 API 密钥已创建', saveKeyNow: '请立即保存此密钥 - 之后将不再显示！',
                        dismiss: '关闭', createApiKey: '创建 API 密钥', rateLimitRpm: '速率限制（每分钟，可选）',
                        leaveEmpty: '留空使用默认值', cancelBtn: '取消', create: '创建',
                        // Config tab
                        authentication: '认证', rateLimiting: '速率限制', retryFallback: '重试与降级',
                        cacheStats: '缓存统计', prometheusMetrics: 'Prometheus 指标', apiDocs: 'API 文档',
                        cliReference: 'CLI 命令参考', asyncWorkflow: '异步工作流', blockingCall: '阻塞调用',
                        checkStatus: '检查状态', getResponse: '获取响应', listPending: '列出待处理',
                        getLatest: '获取最新', pingProvider: '检查连接',
                        requestsPerMin: '每分钟请求数', burstSize: '突发大小', retryEnabled: '重试启用',
                        maxRetries: '最大重试次数', fallbackEnabled: '降级启用', misses: '未命中',
                        totalEntries: '总条目', tokensSaved: '节省 Token', viewRawMetrics: '查看原始指标',
                        endpoint: '端点', openApiSwagger: 'OpenAPI / Swagger UI', interactiveApi: '交互式 API 文档',
                        headerName: '请求头', allowLocalhost: '允许本地访问',
                        // Request detail modal
                        requestDetails: '请求详情', thinking: '思考链', rawOutput: '原始输出',
                        // Shortcuts modal
                        keyboardShortcuts: '键盘快捷键', closeModal: '关闭弹窗',
                        // Misc
                        exportSuccess: '数据导出成功', refreshed: '已刷新', benchmarkComplete: '基准测试完成',
                        // Phase 8A additions
                        copy: '复制', copyToClipboard: '复制到剪贴板', copiedToClipboard: '已复制到剪贴板！',
                        searchRequests: '搜索请求...', showing: '显示', of: '共', perPage: '每页',
                        confirm: '确认', deleteKey: '删除 API 密钥', confirmDeleteKey: '确定要删除此 API 密钥吗？此操作无法撤销。',
                        cancelRequest: '取消请求', confirmCancelRequest: '确定要取消此请求吗？',
                        retry: '重试', requestRetried: '请求重试成功',
                        // Phase 8B additions
                        selectTemplate: '选择模板...', saveTemplate: '保存模板', templateName: '模板名称',
                        enterTemplateName: '输入模板名称', templatePreview: '预览', save: '保存',
                        templateSaved: '模板已保存', templateLoaded: '模板已加载', templateDeleted: '模板已删除',
                        manageTemplates: '管理模板', noTemplates: '暂无保存的模板',
                        chooseTemplate: '选择一个模板', fillInDetails: '填写详细信息',
                        // Error messages
                        failedToCopy: '复制到剪贴板失败', failedToRetry: '重试请求失败',
                        failedToFetch: '获取请求失败', failedToDelete: '删除 API 密钥失败',
                        keyDeleted: 'API 密钥已删除',
                        // Phase 8C additions
                        cacheManagement: '缓存管理', clearCache: '清除缓存', clearAll: '清除全部',
                        cleanup: '清理', cleanupExpired: '清理过期条目',
                        confirmClearCache: '确定要清除所有缓存条目吗？此操作无法撤销。',
                        cacheCleared: '缓存已清除', failedToClearCache: '清除缓存失败',
                        cleanupComplete: '清理完成', entriesRemoved: '条目已移除',
                        failedToCleanupCache: '清理缓存失败', hitRate: '命中率',
                        memorySaved: '内存占用', clickToDisable: '点击禁用', clickToEnable: '点击启用',
                        failedToToggleProvider: '切换提供者状态失败',
                        // Phase 8D additions
                        tokenUsage: 'Token 用量', tokensByProvider: '各提供者 Token 统计',
                        inputTokens: '输入', outputTokens: '输出', total: '合计',
                        estimatedCost: '预估成本', toggleTheme: '切换主题',
                        alertSettings: '告警设置', highLatencyAlert: '高延迟告警',
                        lowSuccessRateAlert: '低成功率告警', queueDepthAlert: '队列深度告警',
                        threshold: '阈值', items: '项', saveSettings: '保存设置',
                        alertsSaved: '告警设置已保存', highLatencyDetected: '检测到高延迟',
                        lowSuccessRateDetected: '检测到低成功率', highQueueDepthDetected: '检测到队列深度过高',
                        // Warmup additions
                        warmup: '预热', warmupAll: '预热所有 CLI', warmupAllCLIs: '预热所有 CLI',
                        warmupDescription: '向所有选中的 AI 提供者发送预热请求，初始化连接并减少首次请求延迟。',
                        warmupMessage: '预热消息', enterWarmupMessage: '输入预热消息...',
                        selectProviders: '选择提供者', selectAll: '全选', deselectAll: '取消全选',
                        providersSelected: '个提供者已选中', startWarmup: '开始预热', warming: '预热中...',
                        warmupResults: '结果', warmupComplete: '预热完成', warmupFailed: '预热失败',
                        close: '关闭',
                        // Monitor tab
                        liveMonitor: '实时监控', autoScroll: '自动滚动', gridView: '网格', focusView: '聚焦',
                        waitingForOutput: '等待输出...', sendRequestToMonitor: '发送请求以查看实时输出',
                        noActiveStreams: '无活跃流', streamingOutput: '流式输出',
                        // Discussions tab
                        discussions: '讨论', multiAiDiscussion: '多 AI 讨论',
                        discussionTopic: '主题', discussionStatus: '状态', discussionRound: '轮次',
                        discussionProviders: '参与者', discussionCreated: '创建时间',
                        noDiscussions: '未找到讨论', viewDiscussion: '查看',
                        discussionInProgress: '进行中', discussionCompleted: '已完成',
                        discussionFailed: '失败', roundProposal: '提案', roundReview: '互评',
                        roundRevision: '修订', roundSummary: '汇总',
                        discussionMessages: '消息', discussionSummary: '总结',
                        newDiscussion: '新建讨论', startDiscussion: '开始讨论',
                        enterTopic: '输入讨论主题...', selectDiscussionProviders: '选择参与者',
                        discussionRounds: '讨论轮数', quickMode: '快速模式（2轮）',
                        starting: '启动中...', refreshDiscussions: '刷新',
                        // Memory & Skills tab
                        recentSessions: '最近会话', topUsedSkills: '常用技能',
                        // v0.21: Memory enhancements
                        memorySubTabs: { sessions: '会话', observations: '观察', injections: '注入记录', discussions: '讨论', system2: '系统 2', heuristic: '启发式' },
                        memoryInjections: '记忆注入', injectedMemories: '注入的记忆',
                        viewInjection: '查看注入', noInjections: '暂无注入记录',
                        observations: '观察', addObservation: '添加观察',
                        editObservation: '编辑', deleteObservation: '删除',
                        observationCategory: '类别', observationTags: '标签',
                        insight: '洞察', preference: '偏好', fact: '事实',
                        noObservations: '暂无观察记录', saveObservation: '保存',
                        memorySettings: '记忆设置', memoryEnabled: '启用记忆',
                        autoInject: '自动注入', maxInjected: '最大注入数',
                        injectionStrategy: '注入策略', recent: '仅最近',
                        relevant: '仅相关', recentPlusRelevant: '最近+相关',
                        configSaved: '配置已保存', configReset: '配置已重置',
                        discussionMemories: '已保存讨论', saveToMemory: '保存到记忆',
                        savedToMemory: '已保存到记忆', noDiscussionMemories: '暂无保存的讨论',
                        // v0.21: Skills feedback
                        giveFeedback: '提供反馈', feedbackRating: '评分',
                        feedbackHelpful: '是否有帮助？', feedbackTask: '任务描述',
                        submitFeedback: '提交反馈', feedbackSubmitted: '反馈已提交',
                        feedbackBoost: '反馈加成',
                        // Cost tracking
                        costByProvider: '各提供者成本', tokens: 'Token数',
                        // Discussion templates
                        loadingTemplates: '加载模板中...', noTemplatesAvailable: '暂无可用模板',
                        // v0.22: Additional UI translations
                        multiAiOrchestrator: '多 AI 协调器',
                        totalSessions: '总会话数', totalMessages: '总消息数', totalTokensLabel: '总 Token 数',
                        search: '搜索', foundResults: '找到', results: '条结果',
                        system2Operations: '系统 2 操作', processingText: '处理中...',
                        noConsolidatedMemories: '暂无整合记忆',
                        runConsolidationHint: '运行整合以从会话中生成洞察',
                        scoreLabel: '分数', sessionLabel: '会话',
                        content: '内容', reset: '重置',
                        runNightlyAuto: '每晚自动运行整合',
                        useLlmInsights: '使用 LLM 从记忆中生成洞察',
                        findSkillsForTask: '为任务查找技能',
                        findSkillsBtn: '查找技能', available: '可用',
                        skillScore: '分数', usedTimes: '已使用', times: '次',
                        useTemplate: '使用模板', exportData: '导出',
                        costAnalysis: '成本分析',
                        today: '今日', thisWeek: '本周', thisMonth: '本月',
                        dailyCostTrend: '每日成本趋势（近 7 天）',
                        cost: '成本',
                        gatewayModeActive: 'Gateway 模式已启用',
                        gatewayModeDesc: '所有请求通过 Gateway API 处理，支持缓存、重试和监控',
                        syncApi: '同步 API', waitMode: '等待模式',
                        timeoutSeconds: '超时时间（秒）',
                        syncMode: '同步模式', waitingForResponse: '等待响应中...',
                        sendSync: '发送（同步）',
                        recommended: '推荐',
                        syncApiTitle: '同步 API (wait=true)',
                        modelShortcuts: '模型快捷方式',
                        shortcuts: '快捷方式',
                        totalAccessCount: '总访问次数', avgImportance: '平均重要性',
                        freshnessScore: '新鲜度分数', totalMemories: '总记忆数',
                        searchMessages: '搜索消息...',
                        enterObservation: '输入观察内容...',
                        whatTaskForSkill: '你用这个技能完成了什么任务？',
                        myApiKey: '我的 API 密钥', focus: '聚焦', requests: '请求',
                        // v0.22 additional
                        speed: '速度', providerGroups: '提供者分组', group: '分组', useCase: '用途',
                        allProviders7: '全部 7 个提供者', quickResponses: '快速响应', codeTasks: '编程任务',
                        comprehensive: '全面', participatingProviders: '参与的提供者',
                        skillSearchPlaceholder: '例如：创建 PDF、分析数据、测试 React...',
                        chineseNlp: '中文 NLP',
                    }
                };

                const t = (key) => i18n[lang.value][key] || key;

                const toggleLang = () => {
                    lang.value = lang.value === 'en' ? 'zh' : 'en';
                    localStorage.setItem('ccb-lang', lang.value);
                };

                // Chart refs
                const latencyChart = ref(null);
                const statusChart = ref(null);
                let latencyChartInstance = null;
                let statusChartInstance = null;
                const latencyData = ref([]);
                const statusCounts = ref({ completed: 0, failed: 0, queued: 0, processing: 0 });

                // Optimized tabs: 11 → 7 (removed Test, merged Costs/Compare to Dashboard, merged Keys to Settings)
                const tabs = [
                    { id: 'dashboard', name: 'Dashboard', icon: '<i class="fas fa-chart-line"></i>', shortcut: '1' },
                    { id: 'monitor', name: 'Monitor', icon: '<i class="fas fa-desktop"></i>', shortcut: '2' },
                    { id: 'memory', name: 'Memory', icon: '<i class="fas fa-brain"></i>', shortcut: '3' },
                    { id: 'skills', name: 'Skills', icon: '<i class="fas fa-tools"></i>', shortcut: '4' },
                    { id: 'discussions', name: 'Discussions', icon: '<i class="fas fa-comments"></i>', shortcut: '5' },
                    { id: 'requests', name: 'Requests', icon: '<i class="fas fa-list"></i>', shortcut: '6' },
                    { id: 'settings', name: 'Settings', icon: '<i class="fas fa-cog"></i>', shortcut: '7' },
                ];

                // Computed
                const healthyProviders = computed(() => {
                    return (status.value.providers || []).filter(p => p.status === 'healthy' || p.status === 'available').length;
                });

                const activeDiscussions = computed(() => {
                    return discussions.value.filter(d => d.status === 'in_progress');
                });

                const filteredRequests = computed(() => {
                    return requests.value.filter(r => {
                        if (requestFilter.value && r.status !== requestFilter.value) return false;
                        if (providerFilter.value && r.provider !== providerFilter.value) return false;
                        if (searchQuery.value) {
                            const query = searchQuery.value.toLowerCase();
                            const matchesId = r.id && String(r.id).toLowerCase().includes(query);
                            const matchesMessage = r.message && String(r.message).toLowerCase().includes(query);
                            const matchesProvider = r.provider && String(r.provider).toLowerCase().includes(query);
                            if (!matchesId && !matchesMessage && !matchesProvider) return false;
                        }
                        return true;
                    });
                });

                // Watch for filter changes to reset pagination
                watch([requestFilter, providerFilter, searchQuery], () => {
                    pagination.value.page = 1;
                });

                // Watch for status changes to set default monitor focus provider
                watch(() => status.value.providers, (providers) => {
                    if (providers && providers.length > 0 && !monitorFocusProvider.value) {
                        monitorFocusProvider.value = providers[0].name;
                    }
                }, { immediate: true });

                // Pagination computed properties
                const totalPages = computed(() => Math.max(1, Math.ceil(filteredRequests.value.length / pagination.value.pageSize)));
                const paginationStart = computed(() => Math.min((pagination.value.page - 1) * pagination.value.pageSize + 1, filteredRequests.value.length));
                const paginationEnd = computed(() => Math.min(pagination.value.page * pagination.value.pageSize, filteredRequests.value.length));
                const paginatedRequests = computed(() => {
                    const start = (pagination.value.page - 1) * pagination.value.pageSize;
                    const end = start + pagination.value.pageSize;
                    return filteredRequests.value.slice(start, end);
                });

                const sortedProviders = computed(() => {
                    return (status.value.providers || []).map(p => ({
                        ...p,
                        score: calculateProviderScore(p)
                    })).sort((a, b) => (b.score || 0) - (a.score || 0));
                });

                // Monitor tab computed properties
                const monitorProviders = computed(() => {
                    const providers = status.value.providers || [];
                    return providers.map(p => {
                        const stream = monitorStreams.value[p.name] || { output: [], active: false, requestId: null };
                        return {
                            name: p.name,
                            active: stream.active,
                            requestId: stream.requestId,
                            output: stream.output,
                            hasNewOutput: stream.hasNewOutput || false
                        };
                    });
                });

                // Token tracking computed properties
                const totalTokens = computed(() => {
                    return (status.value.providers || []).reduce((sum, p) => {
                        return sum + (p.total_input_tokens || 0) + (p.total_output_tokens || 0);
                    }, 0);
                });

                const totalInputTokens = computed(() => {
                    return (status.value.providers || []).reduce((sum, p) => {
                        return sum + (p.total_input_tokens || 0);
                    }, 0);
                });

                const totalOutputTokens = computed(() => {
                    return (status.value.providers || []).reduce((sum, p) => {
                        return sum + (p.total_output_tokens || 0);
                    }, 0);
                });

                const estimatedCost = computed(() => {
                    return (status.value.providers || []).reduce((sum, p) => {
                        const pricing = tokenPricing[p.name.toLowerCase()] || tokenPricing.default;
                        const inputCost = ((p.total_input_tokens || 0) / 1000) * pricing.input;
                        const outputCost = ((p.total_output_tokens || 0) / 1000) * pricing.output;
                        return sum + inputCost + outputCost;
                    }, 0);
                });

                const calculateProviderScore = (provider) => {
                    if (!provider.enabled) return 0;
                    const successWeight = 50;
                    const latencyWeight = 30;
                    const availabilityWeight = 20;

                    const successScore = (provider.success_rate || 0) * successWeight;
                    const maxLatency = 60000;
                    const latencyScore = Math.max(0, (1 - (provider.avg_latency_ms || maxLatency) / maxLatency)) * latencyWeight;
                    const availScore = provider.status === 'healthy' ? availabilityWeight : 0;

                    return successScore + latencyScore + availScore;
                };

                const getScoreColor = (score) => {
                    if (score >= 70) return 'bg-emerald-500';
                    if (score >= 40) return 'bg-amber-500';
                    return 'bg-rose-500';
                };

                // WebSocket
                let ws = null;
                let refreshInterval = null;

                // A2: WebSocket message batching - prevent UI lag from high-frequency events
                const wsMessageQueue = [];
                let wsFlushTimer = null;
                const WS_BATCH_DELAY = 50; // milliseconds

                const connectWebSocket = () => {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    ws = new WebSocket(`${protocol}//${window.location.host}/api/ws`);

                    ws.onopen = () => {
                        connected.value = true;
                        ws.send(JSON.stringify({ type: 'subscribe', channels: ['all'] }));
                        addLog('info', 'WebSocket connected');
                    };

                    ws.onclose = () => {
                        connected.value = false;
                        addLog('warn', 'WebSocket disconnected, reconnecting...');
                        setTimeout(connectWebSocket, 3000);
                    };

                    ws.onerror = () => {
                        addLog('error', 'WebSocket error');
                    };

                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        // Queue message for batch processing
                        wsMessageQueue.push(data);

                        // Debounce: accumulate messages for WS_BATCH_DELAY ms
                        if (wsFlushTimer) clearTimeout(wsFlushTimer);
                        wsFlushTimer = setTimeout(() => {
                            flushMessageQueue();
                            wsFlushTimer = null;
                        }, WS_BATCH_DELAY);
                    };
                };

                const flushMessageQueue = () => {
                    // Process all queued messages in a single batch
                    const batch = [...wsMessageQueue];
                    wsMessageQueue.length = 0;

                    // Process each message
                    batch.forEach(data => {
                        handleWebSocketEvent(data);
                    });
                };

                const handleWebSocketEvent = (event) => {
                    const type = event.type;
                    const data = event.data || {};
                    const reqId = data.request_id ? data.request_id.slice(0, 11) : 'unknown';
                    const provider = data.provider;

                    if (type === 'request_queued' || type === 'request_submitted') {
                        addLog('info', `Request ${reqId} queued → ${provider}`);
                        statusCounts.value.queued++;
                        // Add to live requests for monitor
                        if (provider && data.request_id) {
                            liveRequests.value.push({
                                id: data.request_id,
                                provider: provider,
                                message: data.message || '',
                                created_at: Date.now() / 1000
                            });
                            addMonitorOutput(provider, `[${reqId}] Request queued`, 'info');
                        }
                        fetchRequests();
                        fetchStatus();
                    } else if (type === 'request_processing') {
                        addLog('info', `Request ${reqId} processing...`);
                        statusCounts.value.processing++;
                        // Update monitor stream status
                        if (provider) {
                            if (!monitorStreams.value[provider]) {
                                monitorStreams.value[provider] = { output: [], active: true, requestId: reqId, hasNewOutput: false };
                            }
                            monitorStreams.value[provider].active = true;
                            monitorStreams.value[provider].requestId = reqId;
                            addMonitorOutput(provider, `[${reqId}] Processing started...`, 'info');
                        }
                    } else if (type === 'request_completed') {
                        const latency = data.latency_ms ? `${Math.round(data.latency_ms)}ms` : '';
                        addLog('success', `Request ${reqId} completed ${latency}`);
                        statusCounts.value.completed++;
                        if (data.latency_ms) {
                            latencyData.value.push(data.latency_ms);
                            if (latencyData.value.length > 100) latencyData.value.shift();
                            updateLatencyChart();
                        }
                        // Remove from live requests
                        liveRequests.value = liveRequests.value.filter(r => r.id !== data.request_id);
                        // Update monitor with completion
                        if (provider) {
                            if (monitorStreams.value[provider]) {
                                monitorStreams.value[provider].active = false;
                            }
                            addMonitorOutput(provider, `━━━ [${reqId}] Completed in ${latency} ━━━`, 'success');
                            // Add thinking chain if available
                            if (data.thinking) {
                                addMonitorOutput(provider, `🧠 [Thinking Chain]`, 'thinking');
                                addMonitorOutput(provider, data.thinking, 'thinking');
                            }
                            // Add full response
                            if (data.response) {
                                addMonitorOutput(provider, `📝 [Response]`, 'info');
                                addMonitorOutput(provider, data.response, 'default');
                            }
                            addMonitorOutput(provider, '', 'default'); // Empty line separator
                        }
                        fetchRequests();
                        fetchStatus();
                    } else if (type === 'request_failed') {
                        const errMsg = data.error ? data.error.slice(0, 50) : 'unknown error';
                        addLog('error', `Request ${reqId} failed: ${errMsg}`);
                        statusCounts.value.failed++;
                        // Remove from live requests
                        liveRequests.value = liveRequests.value.filter(r => r.id !== data.request_id);
                        // Update monitor with error
                        if (provider) {
                            if (monitorStreams.value[provider]) {
                                monitorStreams.value[provider].active = false;
                            }
                            addMonitorOutput(provider, `[${reqId}] Failed: ${errMsg}`, 'error');
                        }
                        fetchRequests();
                        fetchStatus();
                    } else if (type === 'stream_chunk' || type === 'output_chunk') {
                        // Handle streaming output for real-time monitoring
                        if (provider && data.chunk) {
                            addMonitorOutput(provider, data.chunk, data.is_thinking ? 'thinking' : 'default');
                        }
                    } else if (type === 'thinking_started') {
                        if (provider) {
                            addMonitorOutput(provider, `[${reqId}] Thinking...`, 'thinking');
                        }
                    } else if (type === 'thinking_complete') {
                        if (provider && data.thinking) {
                            addMonitorOutput(provider, `[Thinking] ${data.thinking.slice(0, 200)}...`, 'thinking');
                        }
                    }

                    updateStatusChart();
                };

                const addLog = (type, message) => {
                    const time = new Date().toLocaleTimeString();
                    activityLogs.value.push({ type, message, time });
                    if (activityLogs.value.length > 100) activityLogs.value.shift();
                };

                // Charts
                const initCharts = () => {
                    // Latency histogram
                    if (latencyChart.value) {
                        latencyChartInstance = new Chart(latencyChart.value, {
                            type: 'bar',
                            data: {
                                labels: ['0-100ms', '100-500ms', '500ms-1s', '1-5s', '5-10s', '>10s'],
                                datasets: [{
                                    label: 'Requests',
                                    data: [0, 0, 0, 0, 0, 0],
                                    backgroundColor: 'rgba(99, 102, 241, 0.7)',
                                    borderColor: 'rgba(99, 102, 241, 1)',
                                    borderWidth: 1,
                                    borderRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af' } },
                                    x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
                                }
                            }
                        });
                    }

                    // Status pie chart
                    if (statusChart.value) {
                        statusChartInstance = new Chart(statusChart.value, {
                            type: 'doughnut',
                            data: {
                                labels: ['Completed', 'Failed', 'Queued', 'Processing'],
                                datasets: [{
                                    data: [0, 0, 0, 0],
                                    backgroundColor: [
                                        'rgba(16, 185, 129, 0.8)',
                                        'rgba(244, 63, 94, 0.8)',
                                        'rgba(99, 102, 241, 0.8)',
                                        'rgba(245, 158, 11, 0.8)'
                                    ],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '70%',
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: '#9ca3af', padding: 16 } }
                                }
                            }
                        });
                    }
                };

                const initCompareCharts = () => {
                    // Radar chart for provider comparison
                    if (radarChart.value) {
                        const providers = status.value.providers || [];
                        radarChartInstance = new Chart(radarChart.value, {
                            type: 'radar',
                            data: {
                                labels: ['Success Rate', 'Speed', 'Availability', 'Reliability', 'Queue'],
                                datasets: providers.slice(0, 5).map((p, i) => ({
                                    label: p.name,
                                    data: [
                                        (p.success_rate || 0) * 100,
                                        Math.max(0, 100 - (p.avg_latency_ms || 0) / 600),
                                        p.status === 'healthy' ? 100 : 50,
                                        (p.success_rate || 0) * 100,
                                        Math.max(0, 100 - (p.queue_depth || 0) * 10)
                                    ],
                                    borderColor: ['#6366f1', '#10b981', '#f59e0b', '#f43f5e', '#8b5cf6'][i],
                                    backgroundColor: ['rgba(99,102,241,0.15)', 'rgba(16,185,129,0.15)', 'rgba(245,158,11,0.15)', 'rgba(244,63,94,0.15)', 'rgba(139,92,246,0.15)'][i],
                                    borderWidth: 2
                                }))
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    r: {
                                        beginAtZero: true,
                                        max: 100,
                                        grid: { color: 'rgba(255,255,255,0.05)' },
                                        pointLabels: { color: '#9ca3af' },
                                        ticks: { display: false }
                                    }
                                },
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: '#9ca3af' } }
                                }
                            }
                        });
                    }

                    // Timeline chart
                    if (timelineChart.value) {
                        timelineChartInstance = new Chart(timelineChart.value, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Requests',
                                    data: [],
                                    borderColor: '#6366f1',
                                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af' } },
                                    x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
                                }
                            }
                        });
                    }
                };

                const updateRadarChart = () => {
                    if (!radarChartInstance) return;
                    const providers = status.value.providers || [];
                    radarChartInstance.data.datasets = providers.slice(0, 5).map((p, i) => ({
                        label: p.name,
                        data: [
                            (p.success_rate || 0) * 100,
                            Math.max(0, 100 - (p.avg_latency_ms || 0) / 600),
                            p.status === 'healthy' ? 100 : 50,
                            (p.success_rate || 0) * 100,
                            Math.max(0, 100 - (p.queue_depth || 0) * 10)
                        ],
                        borderColor: ['#6366f1', '#10b981', '#f59e0b', '#f43f5e', '#8b5cf6'][i],
                        backgroundColor: ['rgba(99,102,241,0.15)', 'rgba(16,185,129,0.15)', 'rgba(245,158,11,0.15)', 'rgba(244,63,94,0.15)', 'rgba(139,92,246,0.15)'][i],
                        borderWidth: 2
                    }));
                    radarChartInstance.update('none');
                };

                const updateLatencyChart = () => {
                    if (!latencyChartInstance) return;
                    const buckets = [0, 0, 0, 0, 0, 0];
                    for (const ms of latencyData.value) {
                        if (ms < 100) buckets[0]++;
                        else if (ms < 500) buckets[1]++;
                        else if (ms < 1000) buckets[2]++;
                        else if (ms < 5000) buckets[3]++;
                        else if (ms < 10000) buckets[4]++;
                        else buckets[5]++;
                    }
                    latencyChartInstance.data.datasets[0].data = buckets;
                    latencyChartInstance.update('none');
                };

                const updateStatusChart = () => {
                    if (!statusChartInstance) return;
                    statusChartInstance.data.datasets[0].data = [
                        statusCounts.value.completed,
                        statusCounts.value.failed,
                        statusCounts.value.queued,
                        statusCounts.value.processing
                    ];
                    statusChartInstance.update('none');
                };

                // API calls
                const fetchStatus = async () => {
                    try {
                        const res = await fetch('/api/status');
                        status.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch status:', e);
                    }
                };

                const fetchRequests = async () => {
                    loading.value.requests = true;
                    try {
                        const res = await fetch('/api/requests?limit=100');
                        requests.value = await res.json();
                        // Reset to page 1 if current page is out of bounds
                        if (pagination.value.page > totalPages.value) {
                            pagination.value.page = 1;
                        }
                    } catch (e) {
                        console.error('Failed to fetch requests:', e);
                        showToast('error', t('failedToFetch'));
                    } finally {
                        loading.value.requests = false;
                    }
                };

                // Discussion methods
                const fetchDiscussions = async () => {
                    loading.value.discussions = true;
                    try {
                        const res = await fetch('/api/discussions');
                        discussions.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch discussions:', e);
                    } finally {
                        loading.value.discussions = false;
                    }
                };

                // Memory methods
                const fetchMemoryStats = async () => {
                    try {
                        const res = await fetch('/api/memory/stats');
                        memoryStats.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch memory stats:', e);
                    }
                };

                const fetchMemorySessions = async () => {
                    try {
                        const res = await fetch('/api/memory/sessions?limit=20');
                        const data = await res.json();
                        memorySessions.value = data.sessions || [];
                    } catch (e) {
                        console.error('Failed to fetch memory sessions:', e);
                    }
                };

                const searchMemory = async () => {
                    if (!memorySearchQuery.value.trim()) return;
                    try {
                        const res = await fetch(`/api/memory/search?query=${encodeURIComponent(memorySearchQuery.value)}&limit=10`);
                        const data = await res.json();
                        memorySearchResults.value = data.results || [];
                    } catch (e) {
                        console.error('Failed to search memory:', e);
                        showToast('error', 'Memory search failed');
                    }
                };

                const viewSession = async (sessionId) => {
                    try {
                        const res = await fetch(`/api/memory/sessions/${sessionId}?window_size=20`);
                        const data = await res.json();
                        selectedSession.value = { session_id: sessionId, messages: data.messages };
                    } catch (e) {
                        console.error('Failed to fetch session:', e);
                        showToast('error', 'Failed to load session');
                    }
                };

                // v0.21: Observations CRUD
                const fetchObservations = async () => {
                    try {
                        const res = await fetch('/api/memory/observations?limit=50');
                        const data = await res.json();
                        observations.value = data.observations || [];
                    } catch (e) {
                        console.error('Failed to fetch observations:', e);
                    }
                };

                const saveObservation = async () => {
                    try {
                        const tags = newObservation.value.tags.split(',').map(t => t.trim()).filter(t => t);
                        const payload = {
                            content: newObservation.value.content,
                            category: newObservation.value.category,
                            tags: tags
                        };
                        if (editingObservation.value) {
                            await fetch(`/api/memory/${editingObservation.value.observation_id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                        } else {
                            await fetch('/api/memory/add', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                        }
                        showAddObservationModal.value = false;
                        editingObservation.value = null;
                        fetchObservations();
                        showToast('success', t('configSaved'));
                    } catch (e) {
                        console.error('Failed to save observation:', e);
                        showToast('error', 'Failed to save observation');
                    }
                };

                const startEditObservation = (obs) => {
                    editingObservation.value = obs;
                    newObservation.value = {
                        content: obs.content,
                        category: obs.category,
                        tags: JSON.parse(obs.tags || '[]').join(', ')
                    };
                    showAddObservationModal.value = true;
                };

                const deleteObservation = async (obsId) => {
                    try {
                        await fetch(`/api/memory/${obsId}`, { method: 'DELETE' });
                        fetchObservations();
                        showToast('success', 'Observation deleted');
                    } catch (e) {
                        console.error('Failed to delete observation:', e);
                        showToast('error', 'Failed to delete observation');
                    }
                };

                const getCategoryColor = (category) => {
                    const colors = {
                        insight: 'bg-amber-500/20 text-amber-400',
                        preference: 'bg-purple-500/20 text-purple-400',
                        fact: 'bg-cyan-500/20 text-cyan-400'
                    };
                    return colors[category] || 'bg-gray-500/20 text-gray-400';
                };

                // v0.21: Memory Injections
                const fetchMemoryInjections = async () => {
                    try {
                        const res = await fetch('/api/memory/injections?limit=20');
                        const data = await res.json();
                        memoryInjections.value = data.injections || [];
                    } catch (e) {
                        console.error('Failed to fetch memory injections:', e);
                    }
                };

                const viewInjectionDetails = async (requestId) => {
                    try {
                        const res = await fetch(`/api/memory/request/${requestId}`);
                        const data = await res.json();
                        selectedInjection.value = data;
                    } catch (e) {
                        console.error('Failed to fetch injection details:', e);
                        showToast('error', 'Failed to load injection details');
                    }
                };

                // v0.21: Memory Config
                const fetchMemoryConfig = async () => {
                    try {
                        const res = await fetch('/api/memory/config');
                        const data = await res.json();
                        memoryConfig.value = data.config || memoryConfig.value;
                    } catch (e) {
                        console.error('Failed to fetch memory config:', e);
                    }
                };

                const saveMemoryConfig = async () => {
                    try {
                        await fetch('/api/memory/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(memoryConfig.value)
                        });
                        showMemoryConfigModal.value = false;
                        showToast('success', t('configSaved'));
                    } catch (e) {
                        console.error('Failed to save memory config:', e);
                        showToast('error', 'Failed to save configuration');
                    }
                };

                const resetMemoryConfig = async () => {
                    try {
                        await fetch('/api/memory/config/reset', { method: 'POST' });
                        fetchMemoryConfig();
                        showToast('success', t('configReset'));
                    } catch (e) {
                        console.error('Failed to reset memory config:', e);
                    }
                };

                // v0.21: Discussion Memories
                const fetchDiscussionMemories = async () => {
                    try {
                        const res = await fetch('/api/memory/discussions?limit=20');
                        const data = await res.json();
                        discussionMemories.value = data.discussions || [];
                    } catch (e) {
                        console.error('Failed to fetch discussion memories:', e);
                    }
                };

                const saveDiscussionToMemory = async (discussion) => {
                    try {
                        await fetch(`/api/discussion/${discussion.session_id}/save-to-memory`, {
                            method: 'POST'
                        });
                        showToast('success', t('savedToMemory'));
                        fetchDiscussionMemories();
                    } catch (e) {
                        console.error('Failed to save discussion to memory:', e);
                        showToast('error', 'Failed to save to memory');
                    }
                };

                // v0.22: System 2 - Consolidated Memory Methods
                const fetchConsolidatedMemories = async () => {
                    try {
                        const res = await fetch('/api/memory/consolidated?days=30&limit=20');
                        const data = await res.json();
                        consolidatedMemories.value = data.memories || [];
                    } catch (e) {
                        console.error('Failed to fetch consolidated memories:', e);
                    }
                };

                const fetchConsolidationStats = async () => {
                    try {
                        const res = await fetch('/api/memory/consolidation/stats');
                        const data = await res.json();
                        consolidationStats.value = data;
                    } catch (e) {
                        console.error('Failed to fetch consolidation stats:', e);
                    }
                };

                const runConsolidation = async () => {
                    system2Loading.value = true;
                    try {
                        const res = await fetch('/api/memory/consolidate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(consolidateOptions.value)
                        });
                        const data = await res.json();
                        showConsolidateModal.value = false;
                        showToast('success', t('consolidationComplete'));
                        fetchConsolidatedMemories();
                        fetchConsolidationStats();
                    } catch (e) {
                        console.error('Failed to run consolidation:', e);
                        showToast('error', 'Consolidation failed');
                    } finally {
                        system2Loading.value = false;
                    }
                };

                const applyDecay = async () => {
                    system2Loading.value = true;
                    try {
                        const res = await fetch('/api/memory/decay', { method: 'POST' });
                        const data = await res.json();
                        showToast('success', t('decayApplied').replace('{count}', data.affected || 0));
                        fetchConsolidationStats();
                        fetchMemoryHealth();
                    } catch (e) {
                        console.error('Failed to apply decay:', e);
                        showToast('error', 'Failed to apply decay');
                    } finally {
                        system2Loading.value = false;
                    }
                };

                const mergeMemories = async () => {
                    system2Loading.value = true;
                    try {
                        const res = await fetch('/api/memory/merge', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        });
                        const data = await res.json();
                        showToast('success', t('mergeComplete').replace('{count}', data.merged_count || 0));
                        fetchConsolidatedMemories();
                        fetchConsolidationStats();
                    } catch (e) {
                        console.error('Failed to merge memories:', e);
                        showToast('error', 'Failed to merge memories');
                    } finally {
                        system2Loading.value = false;
                    }
                };

                const forgetMemoriesAction = async () => {
                    system2Loading.value = true;
                    try {
                        const res = await fetch('/api/memory/forget', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(forgetOptions.value)
                        });
                        const data = await res.json();
                        showForgetModal.value = false;
                        showToast('success', t('forgetComplete').replace('{count}', data.deleted_count || 0));
                        fetchConsolidatedMemories();
                        fetchConsolidationStats();
                        fetchMemoryHealth();
                    } catch (e) {
                        console.error('Failed to forget memories:', e);
                        showToast('error', 'Failed to cleanup memories');
                    } finally {
                        system2Loading.value = false;
                    }
                };

                // v0.22: Heuristic Retrieval Methods
                const fetchHeuristicConfig = async () => {
                    try {
                        const res = await fetch('/api/memory/heuristic/config');
                        const data = await res.json();
                        if (data.config) {
                            heuristicConfig.value = data.config;
                        }
                    } catch (e) {
                        console.error('Failed to fetch heuristic config:', e);
                    }
                };

                const saveHeuristicConfig = async () => {
                    try {
                        await fetch('/api/memory/heuristic/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(heuristicConfig.value)
                        });
                        showToast('success', t('configSaved'));
                    } catch (e) {
                        console.error('Failed to save heuristic config:', e);
                        showToast('error', t('configSaveFailed'));
                    }
                };

                const debouncedSaveHeuristicConfig = () => {
                    if (heuristicConfigDebounceTimer) {
                        clearTimeout(heuristicConfigDebounceTimer);
                    }
                    heuristicConfigDebounceTimer = setTimeout(() => {
                        saveHeuristicConfig();
                    }, 500);
                };

                const fetchMemoryHealth = async () => {
                    try {
                        const res = await fetch('/api/memory/stats/health');
                        const data = await res.json();
                        memoryHealth.value = data;
                    } catch (e) {
                        console.error('Failed to fetch memory health:', e);
                    }
                };

                const fetchDetailedStats = async () => {
                    try {
                        const res = await fetch('/api/memory/stats/detailed');
                        const data = await res.json();
                        detailedStats.value = data;
                    } catch (e) {
                        console.error('Failed to fetch detailed stats:', e);
                    }
                };

                // v0.22: Save all memory config (basic + heuristic + system2)
                const saveAllMemoryConfig = async () => {
                    try {
                        // Save basic memory config
                        await fetch('/api/memory/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(memoryConfig.value)
                        });
                        // Save heuristic config
                        await fetch('/api/memory/heuristic/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(heuristicConfig.value)
                        });
                        showMemoryConfigModal.value = false;
                        showToast('success', t('configSaved'));
                    } catch (e) {
                        console.error('Failed to save memory config:', e);
                        showToast('error', 'Failed to save configuration');
                    }
                };

                // Skills methods
                const fetchSkillsStats = async () => {
                    try {
                        const res = await fetch('/api/skills/stats');
                        skillsStats.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch skills stats:', e);
                    }
                };

                const searchSkills = async () => {
                    if (!skillsSearchQuery.value.trim()) return;
                    try {
                        const res = await fetch(`/api/skills/recommendations?query=${encodeURIComponent(skillsSearchQuery.value)}`);
                        skillRecommendations.value = await res.json();
                        if (!skillRecommendations.value.found) {
                            skillRecommendations.value.message = 'No matching skills found. Try different keywords.';
                        }
                    } catch (e) {
                        console.error('Failed to search skills:', e);
                        showToast('error', 'Skills search failed');
                    }
                };

                // v0.21: Skills Feedback
                const openSkillFeedback = (skill) => {
                    feedbackSkill.value = skill;
                    skillFeedback.value = { rating: 5, helpful: true, task_description: '' };
                    showSkillFeedbackModal.value = true;
                };

                const submitSkillFeedback = async () => {
                    try {
                        await fetch(`/api/skills/${feedbackSkill.value.name}/feedback`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                rating: skillFeedback.value.rating,
                                helpful: skillFeedback.value.helpful,
                                task_description: skillFeedback.value.task_description
                            })
                        });
                        showSkillFeedbackModal.value = false;
                        showToast('success', t('feedbackSubmitted'));
                        // Refresh skills to show updated feedback boost
                        if (skillsSearchQuery.value) {
                            searchSkills();
                        }
                    } catch (e) {
                        console.error('Failed to submit skill feedback:', e);
                        showToast('error', 'Failed to submit feedback');
                    }
                };

                const fetchAllSkillsFeedback = async () => {
                    try {
                        const res = await fetch('/api/skills/feedback/all');
                        allSkillsFeedback.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch skills feedback:', e);
                    }
                };

                // Discussion methods (continued)

                // B2: Discussion template management
                const fetchDiscussionTemplates = async () => {
                    loadingTemplates.value = true;
                    try {
                        const res = await fetch('/api/discussion/templates?include_builtin=true');
                        discussionTemplates.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch discussion templates:', e);
                        showToast('error', 'Failed to load templates');
                    } finally {
                        loadingTemplates.value = false;
                    }
                };

                const selectDiscussionTemplate = (templateId) => {
                    selectedDiscussionTemplate.value = templateId;
                    const template = discussionTemplates.value.find(t => t.id === templateId);
                    if (template) {
                        // Parse variables from topic_template (e.g., {subject}, {context})
                        const matches = template.topic_template.match(/\{(\w+)\}/g);
                        if (matches) {
                            const vars = {};
                            matches.forEach(match => {
                                const key = match.slice(1, -1); // Remove { }
                                vars[key] = '';
                            });
                            templateVariables.value = vars;
                        } else {
                            templateVariables.value = {};
                        }
                        // Pre-fill providers if template has defaults
                        if (template.default_providers && template.default_providers.length > 0) {
                            newDiscussionProviders.value = template.default_providers;
                        }
                    }
                };

                const startDiscussionFromTemplate = async () => {
                    if (!selectedDiscussionTemplate.value) {
                        showToast('error', 'Please select a template');
                        return;
                    }

                    const template = discussionTemplates.value.find(t => t.id === selectedDiscussionTemplate.value);
                    if (!template) return;

                    // Validate required variables
                    const missingVars = Object.entries(templateVariables.value).filter(([k, v]) => !v);
                    if (missingVars.length > 0) {
                        showToast('error', `Please fill in: ${missingVars.map(([k]) => k).join(', ')}`);
                        return;
                    }

                    startingDiscussion.value = true;
                    try {
                        const res = await fetch(`/api/discussion/templates/${selectedDiscussionTemplate.value}/use`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                variables: templateVariables.value,
                                providers: newDiscussionProviders.value.length > 0 ? newDiscussionProviders.value : null,
                                config: newDiscussionQuickMode.value ? { max_rounds: 2 } : null
                            })
                        });

                        if (res.ok) {
                            showToast('success', 'Discussion started from template');
                            showTemplateModal.value = false;
                            selectedDiscussionTemplate.value = '';
                            templateVariables.value = {};
                            await fetchDiscussions();
                        } else {
                            const error = await res.json();
                            showToast('error', error.detail || 'Failed to start discussion');
                        }
                    } catch (e) {
                        console.error('Failed to start discussion from template:', e);
                        showToast('error', 'Failed to start discussion');
                    } finally {
                        startingDiscussion.value = false;
                    }
                };

                const clearTemplateSelection = () => {
                    selectedDiscussionTemplate.value = '';
                    templateVariables.value = {};
                };

                // B1: Cost tracking API calls
                const fetchCostSummary = async () => {
                    try {
                        const res = await fetch('/api/costs/summary?days=30');
                        costSummary.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch cost summary:', e);
                    }
                };

                const fetchCostByProvider = async () => {
                    try {
                        const res = await fetch('/api/costs/by-provider?days=30');
                        costByProvider.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch cost by provider:', e);
                    }
                };

                const fetchCostByDay = async () => {
                    try {
                        const res = await fetch('/api/costs/by-day?days=7');
                        const data = await res.json();
                        costByDay.value = data;
                        updateCostChart();
                    } catch (e) {
                        console.error('Failed to fetch cost by day:', e);
                    }
                };

                const updateCostChart = () => {
                    if (!costChart.value || costByDay.value.length === 0) return;

                    const labels = costByDay.value.map(d => d.date);
                    const costs = costByDay.value.map(d => d.total_cost);

                    if (costChartInstance) {
                        costChartInstance.data.labels = labels;
                        costChartInstance.data.datasets[0].data = costs;
                        costChartInstance.update();
                    } else {
                        costChartInstance = new Chart(costChart.value, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Daily Cost (USD)',
                                    data: costs,
                                    borderColor: 'rgb(99, 102, 241)',
                                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: (value) => '$' + value.toFixed(4)
                                        }
                                    }
                                }
                            }
                        });
                    }
                };

                const selectDiscussion = async (disc) => {
                    selectedDiscussion.value = disc;
                    try {
                        const res = await fetch(`/api/discussion/${disc.id}/messages`);
                        discussionMessages.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch discussion messages:', e);
                    }
                };

                const startNewDiscussion = async () => {
                    if (!newDiscussionTopic.value || newDiscussionProviders.value.length < 2) return;
                    startingDiscussion.value = true;
                    try {
                        const res = await fetch('/api/discussion/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                topic: newDiscussionTopic.value,
                                providers: newDiscussionProviders.value,
                                max_rounds: newDiscussionQuickMode.value ? 2 : 3
                            })
                        });
                        if (res.ok) {
                            showToast('success', 'Discussion started');
                            showNewDiscussionModal.value = false;
                            newDiscussionTopic.value = '';
                            await fetchDiscussions();
                        }
                    } catch (e) {
                        console.error('Failed to start discussion:', e);
                        showToast('error', 'Failed to start discussion');
                    } finally {
                        startingDiscussion.value = false;
                    }
                };

                const getMessagesForRound = (round) => {
                    return discussionMessages.value.filter(m => m.round_number === round && m.message_type !== 'summary');
                };

                const getRoundLabel = (round) => {
                    const labels = { 1: t('roundProposal'), 2: t('roundReview'), 3: t('roundRevision') };
                    return labels[round] || `Round ${round}`;
                };

                const getRoundIcon = (round) => {
                    const icons = { 1: 'fas fa-lightbulb text-amber-400', 2: 'fas fa-comments text-cyan-400', 3: 'fas fa-edit text-purple-400' };
                    return icons[round] || 'fas fa-circle';
                };

                const getDiscussionStatusClass = (status) => {
                    const classes = {
                        'in_progress': 'badge-warning',
                        'completed': 'badge-success',
                        'failed': 'badge-error'
                    };
                    return classes[status] || 'badge-info';
                };

                const getDiscussionStatusIcon = (status) => {
                    const icons = {
                        'in_progress': 'fas fa-spinner fa-spin',
                        'completed': 'fas fa-check',
                        'failed': 'fas fa-times'
                    };
                    return icons[status] || 'fas fa-circle';
                };

                const fetchApiKeys = async () => {
                    try {
                        const res = await fetch('/api/admin/keys');
                        if (res.ok) {
                            apiKeys.value = await res.json();
                        }
                    } catch (e) {
                        console.error('Failed to fetch API keys:', e);
                    }
                };

                const fetchConfigs = async () => {
                    try {
                        const [auth, rateLimit, retry] = await Promise.all([
                            fetch('/api/admin/auth/config').then(r => r.json()),
                            fetch('/api/admin/rate-limit/config').then(r => r.json()),
                            fetch('/api/retry/config').then(r => r.json()),
                        ]);
                        authConfig.value = auth;
                        rateLimitConfig.value = rateLimit;
                        retryConfig.value = retry;
                    } catch (e) {
                        console.error('Failed to fetch configs:', e);
                    }
                };

                const createKey = async () => {
                    try {
                        const res = await fetch('/api/admin/keys', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: newKeyName.value,
                                rate_limit_rpm: newKeyRateLimit.value || null,
                            }),
                        });
                        if (res.ok) {
                            const data = await res.json();
                            newApiKey.value = data.api_key;
                            showCreateKeyModal.value = false;
                            newKeyName.value = '';
                            newKeyRateLimit.value = null;
                            fetchApiKeys();
                            addLog('success', 'API key created');
                        }
                    } catch (e) {
                        console.error('Failed to create key:', e);
                        addLog('error', 'Failed to create API key');
                    }
                };

                const toggleKey = async (key) => {
                    const action = key.enabled ? 'disable' : 'enable';
                    try {
                        await fetch(`/api/admin/keys/${key.key_id}/${action}`, { method: 'POST' });
                        fetchApiKeys();
                    } catch (e) {
                        console.error('Failed to toggle key:', e);
                    }
                };

                const deleteKey = async (keyId) => {
                    try {
                        await fetch(`/api/admin/keys/${keyId}`, { method: 'DELETE' });
                        fetchApiKeys();
                        showToast('success', t('keyDeleted'));
                    } catch (e) {
                        console.error('Failed to delete key:', e);
                        showToast('error', t('failedToDelete'));
                    }
                };

                const cancelRequest = async (requestId) => {
                    try {
                        await fetch(`/api/request/${requestId}`, { method: 'DELETE' });
                        fetchRequests();
                    } catch (e) {
                        console.error('Failed to cancel request:', e);
                    }
                };

                const viewRequest = async (req) => {
                    selectedRequest.value = req;
                    selectedRequestResponse.value = null;
                    try {
                        const res = await fetch(`/api/reply/${req.id}`);
                        if (res.ok) {
                            const data = await res.json();
                            // Store full response data including thinking and raw_output
                            selectedRequestResponse.value = data;
                            // Also update the request with response/error for display
                            if (data.response) {
                                selectedRequest.value = { ...req, response: data.response };
                            } else if (data.error) {
                                selectedRequest.value = { ...req, error: data.error };
                            }
                        }
                    } catch (e) {
                        selectedRequestResponse.value = { error: 'Failed to load response' };
                    }
                };

                const sendTestRequest = async () => {
                    testSending.value = true;
                    testResult.value = null;
                    const startTime = performance.now();

                    // Use message directly (agent is assigned by orchestrator, not manually)
                    let message = testForm.value.message;

                    try {
                        // Build endpoint URL with wait mode parameters
                        let endpoint = '/api/ask';
                        const params = new URLSearchParams();

                        if (testForm.value.waitMode) {
                            params.append('wait', 'true');
                            params.append('timeout', String(testForm.value.timeout || 120));
                        }

                        if (testForm.value.stream && !testForm.value.waitMode) {
                            endpoint = '/api/ask/stream';
                        }

                        const queryString = params.toString();
                        if (queryString) {
                            endpoint += '?' + queryString;
                        }

                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                provider: testForm.value.provider || null,
                                message: message,
                                cache_bypass: testForm.value.cacheBypass,
                            }),
                        });

                        const data = await res.json();
                        const latency = Math.round(performance.now() - startTime);

                        if (testForm.value.waitMode) {
                            // Sync mode: response is inline
                            testResult.value = {
                                success: data.status === 'completed',
                                requestId: data.request_id,
                                response: data.response,
                                error: data.error,
                                latency: data.latency_ms ? Math.round(data.latency_ms) : latency,
                                cached: data.cached
                            };
                            testSending.value = false;
                            if (data.status === 'completed') {
                                addLog('success', `Test completed in ${testResult.value.latency}ms`);
                            } else {
                                addLog('error', `Test failed: ${data.error || data.status}`);
                            }
                        } else if (data.request_id) {
                            // Async mode: poll for result
                            addLog('info', `Test request sent: ${data.request_id.slice(0, 11)}`);

                            let attempts = 0;
                            const pollResult = async () => {
                                attempts++;
                                const replyRes = await fetch(`/api/reply/${data.request_id}`);
                                if (replyRes.ok) {
                                    const reply = await replyRes.json();
                                    if (reply.status === 'completed' || reply.status === 'failed') {
                                        testResult.value = {
                                            success: reply.status === 'completed',
                                            requestId: data.request_id,
                                            response: reply.response,
                                            error: reply.error,
                                            latency: reply.latency_ms ? Math.round(reply.latency_ms) : latency,
                                            cached: data.cached
                                        };
                                        testSending.value = false;
                                        return;
                                    }
                                }
                                if (attempts < 60) {
                                    setTimeout(pollResult, 1000);
                                } else {
                                    testResult.value = {
                                        success: false,
                                        requestId: data.request_id,
                                        error: 'Request timed out',
                                        latency
                                    };
                                    testSending.value = false;
                                }
                            };
                            setTimeout(pollResult, 1000);
                        } else {
                            testResult.value = {
                                success: false,
                                error: data.detail || 'Unknown error',
                                latency
                            };
                            testSending.value = false;
                        }
                    } catch (e) {
                        testResult.value = {
                            success: false,
                            error: e.message,
                            latency: Math.round(performance.now() - startTime)
                        };
                        testSending.value = false;
                    }
                };

                // New features: Export, Benchmark, Shortcuts
                // B4: Enhanced data export functions
                const downloadFile = (content, filename, mimeType) => {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                const convertToCSV = (data, fields) => {
                    if (data.length === 0) return '';

                    const headers = fields.join(',');
                    const rows = data.map(item => {
                        return fields.map(field => {
                            let value = item[field];
                            if (typeof value === 'object') value = JSON.stringify(value);
                            if (typeof value === 'string' && value.includes(',')) {
                                value = `"${value.replace(/"/g, '""')}"`;
                            }
                            return value || '';
                        }).join(',');
                    });

                    return [headers, ...rows].join('\n');
                };

                const exportRequestsCSV = () => {
                    const fields = ['id', 'provider', 'status', 'created_at', 'latency_ms', 'cached', 'message'];
                    const csv = convertToCSV(filteredRequests.value, fields);
                    downloadFile(csv, `ccb-requests-${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
                    showToast('success', 'Requests exported to CSV');
                };

                const exportRequestsJSON = () => {
                    const json = JSON.stringify(filteredRequests.value, null, 2);
                    downloadFile(json, `ccb-requests-${new Date().toISOString().slice(0,10)}.json`, 'application/json');
                    showToast('success', 'Requests exported to JSON');
                };

                const exportDiscussionsJSON = () => {
                    const json = JSON.stringify(discussions.value, null, 2);
                    downloadFile(json, `ccb-discussions-${new Date().toISOString().slice(0,10)}.json`, 'application/json');
                    showToast('success', 'Discussions exported to JSON');
                };

                const exportData = () => {
                    const data = {
                        exportedAt: new Date().toISOString(),
                        status: status.value,
                        requests: requests.value,
                        activityLogs: activityLogs.value
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ccb-gateway-export-${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('success', 'Data exported successfully');
                };

                const toggleFullscreen = () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                };

                const showToast = (type, message) => {
                    const id = Date.now();
                    toasts.value.push({ id, type, message });
                    setTimeout(() => {
                        const index = toasts.value.findIndex(t => t.id === id);
                        if (index !== -1) toasts.value.splice(index, 1);
                    }, 3000);
                };

                const removeToast = (index) => {
                    toasts.value.splice(index, 1);
                };

                const copyToClipboard = async (text) => {
                    try {
                        await navigator.clipboard.writeText(text);
                        showToast('success', t('copiedToClipboard'));
                    } catch (e) {
                        console.error('Failed to copy:', e);
                        // Fallback for non-HTTPS environments
                        try {
                            const textarea = document.createElement('textarea');
                            textarea.value = text;
                            textarea.style.position = 'fixed';
                            textarea.style.opacity = '0';
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                            showToast('success', t('copiedToClipboard'));
                        } catch (fallbackError) {
                            showToast('error', t('failedToCopy'));
                        }
                    }
                };

                const showConfirmDialog = (title, message, onConfirm) => {
                    confirmDialog.value = {
                        show: true,
                        title,
                        message,
                        onConfirm
                    };
                };

                const executeConfirmAction = () => {
                    if (confirmDialog.value.onConfirm) {
                        confirmDialog.value.onConfirm();
                    }
                    confirmDialog.value.show = false;
                };

                const retryRequest = async (req) => {
                    try {
                        await fetch('/api/ask', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                provider: req.provider,
                                message: req.message
                            })
                        });
                        showToast('success', t('requestRetried'));
                        fetchRequests();
                    } catch (e) {
                        console.error('Failed to retry request:', e);
                        showToast('error', t('failedToRetry'));
                    }
                };

                // Warmup functions
                const toggleAllWarmupProviders = () => {
                    const allSelected = warmupProviders.value.every(p => p.selected);
                    warmupProviders.value.forEach(p => p.selected = !allSelected);
                };

                const getWarmupStatusClass = (status) => ({
                    pending: 'text-gray-400',
                    running: 'text-amber-400',
                    success: 'text-emerald-400',
                    failed: 'text-rose-400'
                }[status] || 'text-gray-400');

                const getWarmupStatusIcon = (status) => ({
                    pending: 'fas fa-clock',
                    running: 'fas fa-spinner fa-spin',
                    success: 'fas fa-check-circle',
                    failed: 'fas fa-times-circle'
                }[status] || 'fas fa-circle');

                const runWarmup = async () => {
                    warmupRunning.value = true;
                    warmupResults.value = [];

                    const selectedProviders = warmupProviders.value.filter(p => p.selected);

                    // Reset all statuses
                    warmupProviders.value.forEach(p => p.status = p.selected ? 'pending' : null);

                    // Run warmup for each selected provider in parallel
                    // Use wait=true with longer timeout for slow providers
                    const warmupPromises = selectedProviders.map(async (provider) => {
                        provider.status = 'running';
                        const startTime = performance.now();

                        // Determine timeout based on provider speed tier
                        const slowProviders = ['codex', 'gemini', 'claude', 'deepseek', 'iflow'];
                        const timeout = slowProviders.includes(provider.name) ? 180 : 60;

                        try {
                            // Use synchronous wait mode for more reliable results
                            const res = await fetch(`/api/ask?wait=true&timeout=${timeout}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    provider: provider.name,
                                    message: warmupMessage.value,
                                }),
                            });
                            const data = await res.json();

                            if (data.status === 'completed' && data.response) {
                                provider.status = 'success';
                                return {
                                    provider: provider.name,
                                    success: true,
                                    latency: data.latency_ms || (performance.now() - startTime),
                                    response: data.response
                                };
                            } else if (data.status === 'failed' || data.error) {
                                provider.status = 'failed';
                                return {
                                    provider: provider.name,
                                    success: false,
                                    error: data.error || 'Failed'
                                };
                            } else if (data.status === 'timeout') {
                                provider.status = 'failed';
                                return {
                                    provider: provider.name,
                                    success: false,
                                    error: 'Timeout'
                                };
                            } else if (data.request_id) {
                                // Fallback: poll for result if wait didn't work
                                let attempts = 0;
                                const maxAttempts = Math.ceil(timeout / 2); // Poll every 2 seconds
                                const pollResult = () => new Promise((resolve) => {
                                    const check = async () => {
                                        attempts++;
                                        try {
                                            const replyRes = await fetch(`/api/reply/${data.request_id}`);
                                            if (replyRes.ok) {
                                                const reply = await replyRes.json();
                                                if (reply.status === 'completed') {
                                                    resolve({
                                                        success: true,
                                                        latency: reply.latency_ms || (performance.now() - startTime),
                                                        response: reply.response
                                                    });
                                                    return;
                                                } else if (reply.status === 'failed') {
                                                    resolve({ success: false, error: reply.error || 'Failed' });
                                                    return;
                                                }
                                            }
                                        } catch (e) {
                                            // Continue polling
                                        }
                                        if (attempts < maxAttempts) setTimeout(check, 2000);
                                        else resolve({ success: false, error: 'Timeout' });
                                    };
                                    setTimeout(check, 1000);
                                });

                                const result = await pollResult();
                                provider.status = result.success ? 'success' : 'failed';
                                return { provider: provider.name, ...result };
                            } else {
                                provider.status = 'failed';
                                return { provider: provider.name, success: false, error: data.detail || 'Unknown error' };
                            }
                        } catch (e) {
                            provider.status = 'failed';
                            return { provider: provider.name, success: false, error: e.message };
                        }
                    });

                    // Wait for all warmup requests to complete
                    const results = await Promise.all(warmupPromises);
                    warmupResults.value = results;
                    warmupRunning.value = false;

                    const successCount = results.filter(r => r.success).length;
                    const totalCount = results.length;

                    if (successCount === totalCount) {
                        showToast('success', `${t('warmupComplete')}: ${successCount}/${totalCount}`);
                        addLog('success', `Warmup completed: ${successCount}/${totalCount} providers ready`);
                    } else {
                        showToast('warn', `${t('warmupComplete')}: ${successCount}/${totalCount}`);
                        addLog('warn', `Warmup partial: ${successCount}/${totalCount} providers ready`);
                    }

                    fetchStatus();
                };

                // Test template functions
                const saveTemplate = () => {
                    if (!newTemplateName.value.trim()) {
                        showToast('error', t('enterTemplateName'));
                        return;
                    }
                    testTemplates.value.push({
                        name: newTemplateName.value.trim(),
                        provider: testForm.value.provider,
                        message: testForm.value.message,
                        stream: testForm.value.stream,
                        cacheBypass: testForm.value.cacheBypass
                    });
                    localStorage.setItem('ccb-test-templates', JSON.stringify(testTemplates.value));
                    showSaveTemplateModal.value = false;
                    newTemplateName.value = '';
                    showToast('success', t('templateSaved'));
                };

                const loadTemplate = () => {
                    if (selectedTemplate.value === '' || selectedTemplate.value === null) return;
                    const index = parseInt(selectedTemplate.value);
                    const tpl = testTemplates.value[index];
                    if (tpl) {
                        testForm.value.provider = tpl.provider || '';
                        testForm.value.message = tpl.message || '';
                        testForm.value.stream = tpl.stream || false;
                        testForm.value.cacheBypass = tpl.cacheBypass || false;
                        showToast('info', t('templateLoaded'));
                    }
                    selectedTemplate.value = '';
                };

                const deleteTemplate = (index) => {
                    testTemplates.value.splice(index, 1);
                    localStorage.setItem('ccb-test-templates', JSON.stringify(testTemplates.value));
                    showToast('success', t('templateDeleted'));
                };

                // Theme toggle function
                const toggleTheme = () => {
                    theme.value = theme.value === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('ccb-theme', theme.value);
                    document.documentElement.className = theme.value;
                };

                // Provider toggle function
                const toggleProvider = async (provider) => {
                    try {
                        const action = provider.enabled ? 'disable' : 'enable';
                        await fetch(`/api/admin/providers/${provider.name}/${action}`, { method: 'POST' });
                        fetchStatus();
                        showToast('success', `${provider.name} ${provider.enabled ? t('disabled') : t('enabled')}`);
                    } catch (e) {
                        console.error('Failed to toggle provider:', e);
                        showToast('error', t('failedToToggleProvider'));
                    }
                };

                // Cache management functions
                const clearCache = async () => {
                    try {
                        await fetch('/api/cache', { method: 'DELETE' });
                        fetchStatus();
                        showToast('success', t('cacheCleared'));
                    } catch (e) {
                        console.error('Failed to clear cache:', e);
                        showToast('error', t('failedToClearCache'));
                    }
                };

                const cleanupCache = async () => {
                    try {
                        const res = await fetch('/api/cache/cleanup', { method: 'POST' });
                        const data = await res.json();
                        fetchStatus();
                        showToast('success', `${t('cleanupComplete')}: ${data.removed || 0} ${t('entriesRemoved')}`);
                    } catch (e) {
                        console.error('Failed to cleanup cache:', e);
                        showToast('error', t('failedToCleanupCache'));
                    }
                };

                // Alert functions
                const saveAlerts = () => {
                    localStorage.setItem('ccb-alerts', JSON.stringify(alerts.value));
                    showAlertSettings.value = false;
                    showToast('success', t('alertsSaved'));
                };

                const checkAlerts = () => {
                    if (!status.value.providers) return;

                    status.value.providers.forEach(p => {
                        if (alerts.value.highLatency.enabled && p.avg_latency_ms > alerts.value.highLatency.threshold) {
                            showToast('warn', `${p.name}: ${t('highLatencyDetected')} (${formatLatency(p.avg_latency_ms)})`);
                        }
                        if (alerts.value.lowSuccessRate.enabled && p.success_rate < alerts.value.lowSuccessRate.threshold && p.total_requests > 0) {
                            showToast('warn', `${p.name}: ${t('lowSuccessRateDetected')} (${formatPercent(p.success_rate)})`);
                        }
                        if (alerts.value.queueDepth.enabled && p.queue_depth > alerts.value.queueDepth.threshold) {
                            showToast('warn', `${p.name}: ${t('highQueueDepthDetected')} (${p.queue_depth})`);
                        }
                    });
                };

                const runBenchmark = async () => {
                    benchmarkRunning.value = true;
                    benchmarkResults.value = [];
                    const providers = (status.value.providers || []).filter(p => p.enabled);

                    for (const provider of providers) {
                        const startTime = performance.now();
                        try {
                            const res = await fetch('/api/ask', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    provider: provider.name,
                                    message: benchmarkMessage.value,
                                }),
                            });
                            const data = await res.json();

                            if (data.request_id) {
                                let attempts = 0;
                                const pollResult = () => new Promise((resolve) => {
                                    const check = async () => {
                                        attempts++;
                                        const replyRes = await fetch(`/api/reply/${data.request_id}`);
                                        if (replyRes.ok) {
                                            const reply = await replyRes.json();
                                            if (reply.status === 'completed') {
                                                resolve({ success: true, latency: reply.latency_ms || (performance.now() - startTime) });
                                                return;
                                            } else if (reply.status === 'failed') {
                                                resolve({ success: false, error: reply.error || 'Failed' });
                                                return;
                                            }
                                        }
                                        if (attempts < 60) setTimeout(check, 1000);
                                        else resolve({ success: false, error: 'Timeout' });
                                    };
                                    setTimeout(check, 1000);
                                });

                                const result = await pollResult();
                                benchmarkResults.value.push({ provider: provider.name, ...result });
                            }
                        } catch (e) {
                            benchmarkResults.value.push({ provider: provider.name, success: false, error: e.message });
                        }
                    }
                    benchmarkRunning.value = false;
                    showToast('success', 'Benchmark completed');
                };

                // Monitor tab methods
                const monitorRefs = {};
                const setMonitorRef = (provider, el) => {
                    if (el) monitorRefs[provider] = el;
                };

                const getMonitorOutput = (provider) => {
                    return monitorStreams.value[provider]?.output || [];
                };

                const getOutputLineClass = (line) => {
                    if (!line || !line.type) return 'monitor-line-default';
                    return {
                        info: 'monitor-line-info',
                        error: 'monitor-line-error',
                        success: 'monitor-line-success',
                        thinking: 'monitor-line-thinking'
                    }[line.type] || 'monitor-line-default';
                };

                const clearMonitorStreams = () => {
                    monitorStreams.value = {};
                    liveRequests.value = [];
                };

                // A1: Monitor output limit - prevent memory overflow
                const MAX_MONITOR_LINES = 1000;

                const addMonitorOutput = (provider, text, type = 'default') => {
                    if (!monitorStreams.value[provider]) {
                        monitorStreams.value[provider] = { output: [], active: false, requestId: null, hasNewOutput: false };
                    }

                    const stream = monitorStreams.value[provider];
                    stream.output.push({ text, type, timestamp: Date.now() });

                    // Circular buffer: remove oldest lines when exceeding limit
                    if (stream.output.length > MAX_MONITOR_LINES) {
                        stream.output.splice(0, stream.output.length - MAX_MONITOR_LINES);
                    }

                    stream.hasNewOutput = true;

                    // Auto-scroll if enabled
                    if (monitorAutoScroll.value) {
                        nextTick(() => {
                            const el = monitorRefs[provider];
                            if (el) el.scrollTop = el.scrollHeight;
                        });
                    }

                    // Clear hasNewOutput after animation
                    setTimeout(() => {
                        if (monitorStreams.value[provider]) {
                            monitorStreams.value[provider].hasNewOutput = false;
                        }
                    }, 1000);
                };

                const handleKeydown = (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                    if (e.key === 'Escape') {
                        showShortcuts.value = false;
                        selectedRequest.value = null;
                        showCreateKeyModal.value = false;
                        confirmDialog.value.show = false;
                        showSaveTemplateModal.value = false;
                        showManageTemplatesModal.value = false;
                        showAlertSettings.value = false;
                        showNewDiscussionModal.value = false;
                        selectedDiscussion.value = null;
                    } else if (e.key >= '1' && e.key <= '8') {
                        const tabIndex = parseInt(e.key) - 1;
                        if (tabs[tabIndex]) activeTab.value = tabs[tabIndex].id;
                    } else if (e.key.toLowerCase() === 'r') {
                        fetchStatus();
                        fetchRequests();
                        fetchDiscussions();
                        showToast('info', t('refreshed'));
                    } else if (e.key.toLowerCase() === 'e') {
                        exportData();
                    } else if (e.key === '?') {
                        showShortcuts.value = true;
                    }
                };

                // Formatters
                const formatDuration = (seconds) => {
                    if (!seconds) return '0s';
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = Math.floor(seconds % 60);
                    if (h > 0) return `${h}h ${m}m`;
                    if (m > 0) return `${m}m ${s}s`;
                    return `${s}s`;
                };

                const formatPercent = (value) => `${(value * 100).toFixed(1)}%`;
                const formatLatency = (ms) => {
                    if (!ms) return '0ms';
                    if (ms < 1000) return `${ms.toFixed(0)}ms`;
                    return `${(ms / 1000).toFixed(2)}s`;
                };

                // Provider speed tiers (A3: Added qoder)
                const providerSpeedTiers = {
                    kimi: { tier: 'fast', icon: '🚀', label: 'Fast', color: 'emerald' },
                    qwen: { tier: 'fast', icon: '🚀', label: 'Fast', color: 'emerald' },
                    deepseek: { tier: 'medium', icon: '⚡', label: 'Medium', color: 'amber' },
                    iflow: { tier: 'medium', icon: '⚡', label: 'Medium', color: 'amber' },
                    opencode: { tier: 'medium', icon: '⚡', label: 'Medium', color: 'amber' },
                    qoder: { tier: 'medium', icon: '🤖', label: 'Medium', color: 'purple' },
                    codex: { tier: 'slow', icon: '🐢', label: 'Slow', color: 'rose' },
                    gemini: { tier: 'slow', icon: '🐢', label: 'Slow', color: 'rose' },
                };

                const getProviderTier = (name) => providerSpeedTiers[name?.toLowerCase()] || { tier: 'unknown', icon: '❓', label: 'Unknown', color: 'gray' };
                const getProviderTierIcon = (name) => getProviderTier(name).icon;
                const getProviderTierLabel = (name) => getProviderTier(name).label;
                const getProviderTierClass = (name) => {
                    const tier = getProviderTier(name);
                    // A3: Provider-specific colors (qoder gets purple)
                    const colorMap = {
                        emerald: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                        amber: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                        rose: 'bg-rose-500/20 text-rose-400 border-rose-500/30',
                        purple: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
                        gray: 'bg-gray-500/20 text-gray-400 border-gray-500/30'
                    };
                    return colorMap[tier.color] || colorMap.gray;
                };

                const formatTime = (timestamp) => {
                    if (!timestamp) return '-';
                    return new Date(timestamp * 1000).toLocaleString();
                };
                const formatDate = (isoString) => {
                    if (!isoString) return '-';
                    const date = new Date(isoString);
                    const now = new Date();
                    const diff = now - date;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);

                    if (minutes < 1) return 'just now';
                    if (minutes < 60) return `${minutes}m ago`;
                    if (hours < 24) return `${hours}h ago`;
                    if (days < 7) return `${days}d ago`;
                    return date.toLocaleDateString();
                };
                const getRoleColor = (role) => {
                    const colors = {
                        user: 'bg-indigo-500/20 text-indigo-400',
                        assistant: 'bg-emerald-500/20 text-emerald-400',
                        system: 'bg-amber-500/20 text-amber-400'
                    };
                    return colors[role] || 'bg-gray-500/20 text-gray-400';
                };
                const formatFeatureName = (name) => name.replace(/_/g, ' ').replace(/enabled/i, '').trim();
                const formatCost = (cost) => {
                    if (!cost || cost < 0.01) return '0.00';
                    return cost.toFixed(2);
                };
                const formatNumber = (num) => {
                    if (!num) return '0';
                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                    return num.toString();
                };
                const formatBytes = (bytes) => {
                    if (!bytes) return '0 B';
                    const units = ['B', 'KB', 'MB', 'GB'];
                    let i = 0;
                    while (bytes >= 1024 && i < units.length - 1) {
                        bytes /= 1024;
                        i++;
                    }
                    return `${bytes.toFixed(1)} ${units[i]}`;
                };

                // Style helpers
                const getStatusClass = (status) => ({
                    healthy: 'text-emerald-400', available: 'text-emerald-400',
                    degraded: 'text-amber-400', unavailable: 'text-rose-400', unknown: 'text-gray-400'
                }[status] || 'text-gray-400');

                const getStatusBadgeClass = (status) => ({
                    healthy: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30', 
                    available: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                    degraded: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                    unavailable: 'bg-rose-500/20 text-rose-400 border-rose-500/30', 
                    unknown: 'bg-gray-500/20 text-gray-400 border-gray-500/30'
                }[status] || 'bg-gray-500/20 text-gray-400 border-gray-500/30');

                const getRequestStatusClass = (status) => ({
                    queued: 'badge-info', processing: 'badge-warning',
                    completed: 'badge-success', failed: 'badge-error',
                    cancelled: 'badge', timeout: 'badge-warning', retrying: 'badge-info'
                }[status] || 'badge');

                const getStatusDotClass = (status) => ({
                    queued: 'bg-indigo-400', processing: 'bg-amber-400 animate-pulse',
                    completed: 'bg-emerald-400', failed: 'bg-rose-400',
                    cancelled: 'bg-gray-400', timeout: 'bg-orange-400', retrying: 'bg-violet-400'
                }[status] || 'bg-gray-400');

                const getLogClass = (type) => ({
                    info: 'text-indigo-300', success: 'text-emerald-300',
                    warn: 'text-amber-300', error: 'text-rose-300'
                }[type] || 'text-gray-300');

                const getAgentIcon = (agent) => ({
                    sisyphus: '🪨', oracle: '🔮', librarian: '📚', explorer: '🧭',
                    frontend: '🎨', reviewer: '🔍', workflow: '⚙️', polyglot: '🌐', autonomous: '🤖'
                }[agent] || '🤖');

                // Lifecycle
                onMounted(() => {
                    // Initialize theme on page load
                    document.documentElement.className = theme.value;

                    fetchStatus();
                    fetchRequests();
                    fetchDiscussions();
                    fetchApiKeys();
                    fetchConfigs();
                    fetchCostSummary();
                    fetchCostByProvider();
                    fetchCostByDay();
                    fetchMemoryStats();
                    fetchMemorySessions();
                    fetchSkillsStats();
                    // v0.22: Fetch System 2 and Heuristic data
                    fetchConsolidationStats();
                    fetchHeuristicConfig();
                    fetchMemoryHealth();
                    fetchDetailedStats();
                    connectWebSocket();
                    nextTick(() => {
                        initCharts();
                        initCompareCharts();
                    });
                    refreshInterval = setInterval(() => {
                        fetchStatus();
                        fetchDiscussions();
                        updateRadarChart();
                        // Refresh cost data every 5 seconds
                        if (activeTab.value === 'costs') {
                            fetchCostSummary();
                            fetchCostByProvider();
                            fetchCostByDay();
                        }
                        // Refresh memory and skills data if on those tabs
                        if (activeTab.value === 'memory') {
                            fetchMemoryStats();
                            fetchMemorySessions();
                            // v0.21: Also refresh observations and injections based on sub-tab
                            if (memorySubTab.value === 'observations') {
                                fetchObservations();
                            } else if (memorySubTab.value === 'injections') {
                                fetchMemoryInjections();
                            } else if (memorySubTab.value === 'discussions') {
                                fetchDiscussionMemories();
                            } else if (memorySubTab.value === 'system2') {
                                // v0.22: Refresh System 2 data
                                fetchConsolidatedMemories();
                                fetchConsolidationStats();
                            } else if (memorySubTab.value === 'heuristic') {
                                // v0.22: Refresh Heuristic data
                                fetchMemoryHealth();
                                fetchDetailedStats();
                            }
                        }
                        if (activeTab.value === 'skills') {
                            fetchSkillsStats();
                        }
                    }, 5000);
                    document.addEventListener('keydown', handleKeydown);
                });

                onUnmounted(() => {
                    if (ws) ws.close();
                    if (refreshInterval) clearInterval(refreshInterval);
                    if (latencyChartInstance) latencyChartInstance.destroy();
                    if (statusChartInstance) statusChartInstance.destroy();
                    if (radarChartInstance) radarChartInstance.destroy();
                    if (timelineChartInstance) timelineChartInstance.destroy();
                    if (costChartInstance) costChartInstance.destroy();
                    document.removeEventListener('keydown', handleKeydown);
                });

                return {
                    connected, activeTab, tabs, status, requests, apiKeys,
                    authConfig, rateLimitConfig, retryConfig,
                    showCreateKeyModal, newKeyName, newKeyRateLimit, newApiKey,
                    activityLogs, requestFilter, providerFilter, searchQuery,
                    selectedRequest, selectedRequestResponse,
                    testForm, testSending, testResult,
                    latencyChart, statusChart, radarChart, timelineChart,
                    healthyProviders, filteredRequests, sortedProviders,
                    // Phase 8A additions
                    loading, pagination, totalPages, paginationStart, paginationEnd, paginatedRequests,
                    confirmDialog, showConfirmDialog, executeConfirmAction,
                    copyToClipboard, removeToast, retryRequest,
                    // Phase 8B additions
                    testTemplates, selectedTemplate, showSaveTemplateModal, showManageTemplatesModal, newTemplateName,
                    saveTemplate, loadTemplate, deleteTemplate,
                    // Phase 8C additions
                    toggleProvider, clearCache, cleanupCache,
                    // Phase 8D additions
                    theme, toggleTheme, alerts, showAlertSettings, saveAlerts,
                    totalTokens, totalInputTokens, totalOutputTokens, formatNumber, formatBytes,
                    // Warmup
                    showWarmupModal, warmupRunning, warmupMessage, warmupResults, warmupProviders,
                    toggleAllWarmupProviders, getWarmupStatusClass, getWarmupStatusIcon, runWarmup,
                    // Monitor tab
                    monitorStreams, monitorAutoScroll, monitorLayout, monitorFocusProvider, liveRequests,
                    monitorProviders, setMonitorRef, getMonitorOutput, getOutputLineClass, clearMonitorStreams,
                    // Memory tab
                    memoryStats, memorySessions, memorySearchQuery, memorySearchResults, selectedSession,
                    fetchMemoryStats, fetchMemorySessions, searchMemory, viewSession, formatDate, getRoleColor,
                    // v0.21: Memory enhancements
                    memorySubTab, observations, observationSearchQuery, showAddObservationModal, newObservation, editingObservation,
                    fetchObservations, saveObservation, startEditObservation, deleteObservation, getCategoryColor,
                    memoryInjections, selectedInjection, fetchMemoryInjections, viewInjectionDetails,
                    memoryConfig, showMemoryConfigModal, fetchMemoryConfig, saveMemoryConfig, resetMemoryConfig,
                    discussionMemories, fetchDiscussionMemories, saveDiscussionToMemory,
                    // v0.22: System 2 & Heuristic
                    consolidatedMemories, consolidationStats, showConsolidateModal, showForgetModal,
                    system2Loading, consolidateOptions, forgetOptions, system2Config,
                    fetchConsolidatedMemories, fetchConsolidationStats, runConsolidation,
                    applyDecay, mergeMemories, forgetMemoriesAction,
                    heuristicConfig, memoryHealth, detailedStats,
                    fetchHeuristicConfig, saveHeuristicConfig, debouncedSaveHeuristicConfig,
                    fetchMemoryHealth, fetchDetailedStats, saveAllMemoryConfig,
                    // Skills tab
                    skillsStats, skillsSearchQuery, skillRecommendations,
                    fetchSkillsStats, searchSkills,
                    // v0.21: Skills feedback
                    showSkillFeedbackModal, feedbackSkill, skillFeedback, allSkillsFeedback,
                    openSkillFeedback, submitSkillFeedback, fetchAllSkillsFeedback,
                    // Discussions tab
                    discussions, selectedDiscussion, discussionMessages, showNewDiscussionModal,
                    newDiscussionTopic, newDiscussionProviders, newDiscussionQuickMode, startingDiscussion,
                    availableDiscussionProviders, activeDiscussions,
                    fetchDiscussions, selectDiscussion, startNewDiscussion,
                    getMessagesForRound, getRoundLabel, getRoundIcon,
                    getDiscussionStatusClass, getDiscussionStatusIcon,
                    // B2: Discussion templates
                    discussionTemplates, selectedDiscussionTemplate, templateVariables, showTemplateModal, loadingTemplates,
                    fetchDiscussionTemplates, selectDiscussionTemplate, startDiscussionFromTemplate, clearTemplateSelection,
                    // B1: Cost tracking
                    costSummary, costByProvider, costByDay, costChart,
                    fetchCostSummary, fetchCostByProvider, fetchCostByDay, formatCost,
                    // Original functions
                    fetchRequests, createKey, toggleKey, deleteKey, cancelRequest, viewRequest,
                    sendTestRequest, exportData, toggleFullscreen, showShortcuts, toasts, showToast,
                    // B4: Export functions
                    showExportMenu, exportRequestsCSV, exportRequestsJSON, exportDiscussionsJSON,
                    timelineRange, benchmarkMessage, benchmarkRunning, benchmarkResults, runBenchmark,
                    formatDuration, formatPercent, formatLatency, formatTime, formatFeatureName,
                    getStatusClass, getStatusBadgeClass, getRequestStatusClass, getStatusDotClass, getLogClass, getAgentIcon, getScoreColor,
                    getProviderTier, getProviderTierIcon, getProviderTierLabel, getProviderTierClass,
                    lang, t, toggleLang,
                };
            },
        }).mount('#app');
    </script>
</body>
</html>
