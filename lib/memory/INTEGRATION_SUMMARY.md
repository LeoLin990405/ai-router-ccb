# CCB Memory æ·±åº¦é›†æˆ - å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆç»„ä»¶

### 1. æ ¸å¿ƒä¸­é—´ä»¶
**æ–‡ä»¶ï¼š** `lib/gateway/middleware/memory_middleware.py`

**åŠŸèƒ½ï¼š**
- âœ… Pre-Request Hook - è®°å¿†æœç´¢å’Œä¸Šä¸‹æ–‡æ³¨å…¥
- âœ… Post-Response Hook - å¯¹è¯è®°å½•å’Œç»Ÿè®¡æ›´æ–°
- âœ… å…³é”®è¯æå– - æ™ºèƒ½è¯†åˆ«ä»»åŠ¡ç±»å‹
- âœ… Provider æ¨è - åŸºäºä»»åŠ¡å…³é”®è¯
- âœ… å¯é…ç½® - æ”¯æŒå¯ç”¨/ç¦ç”¨å„é¡¹åŠŸèƒ½

### 2. é…ç½®ç³»ç»Ÿ
**æ–‡ä»¶ï¼š** `~/.ccb/gateway_config.json`

```json
{
  "memory": {
    "enabled": true,           // å¯ç”¨è®°å¿†ç³»ç»Ÿ
    "auto_inject": true,       // è‡ªåŠ¨æ³¨å…¥ä¸Šä¸‹æ–‡
    "auto_record": true,       // è‡ªåŠ¨è®°å½•å¯¹è¯
    "max_injected_memories": 5 // æœ€å¤šæ³¨å…¥ 5 æ¡è®°å¿†
  },
  "recommendation": {
    "enabled": true,                // å¯ç”¨æ™ºèƒ½æ¨è
    "auto_switch_provider": false,  // ä¸è‡ªåŠ¨åˆ‡æ¢ï¼ˆä»…æç¤ºï¼‰
    "confidence_threshold": 0.7     // æ¨èç½®ä¿¡åº¦é˜ˆå€¼
  }
}
```

### 3. æµ‹è¯•è„šæœ¬
**æ–‡ä»¶ï¼š** `lib/gateway/middleware/test_middleware.py`

**æµ‹è¯•åœºæ™¯ï¼š**
1. âœ… Pre-Request Hook - æå–å…³é”®è¯ï¼Œæœç´¢è®°å¿†
2. âœ… Post-Response Hook - è®°å½•å¯¹è¯
3. âœ… ç»Ÿè®¡ä¿¡æ¯ - æŸ¥çœ‹è®°å¿†æ•°æ®
4. âœ… ç¬¬äºŒæ¬¡æŸ¥è¯¢ - éªŒè¯è®°å¿†æ³¨å…¥

### 4. é›†æˆè®¾è®¡æ–‡æ¡£
**æ–‡ä»¶ï¼š** `lib/memory/INTEGRATION_DESIGN.md`

**åŒ…å«ï¼š**
- 4 ä¸ªè®°å¿†ç³»ç»Ÿè°ƒç ”åˆ†æ
- CCB æ··åˆæ¶æ„è®¾è®¡
- è¯¦ç»†é›†æˆç‚¹è¯´æ˜
- æ•°æ®æµå›¾å’Œæ•ˆæœæ¼”ç¤º
- æœªæ¥æ‰©å±•è§„åˆ’

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ·å‘½ä»¤: ccb-cli kimi "å¦‚ä½•åšå‰ç«¯å¼€å‘"
    â”‚
    â”œâ”€â†’ [ccb-cli] è§£æå‚æ•°
    â”‚
    â”œâ”€â†’ [Gateway API] http://localhost:8765/api/ask
    â”‚   â”‚
    â”‚   â”œâ”€â†’ [Memory Middleware - Pre-Request]
    â”‚   â”‚   â”œâ”€â†’ æå–å…³é”®è¯: ["å‰ç«¯", "å¼€å‘"]
    â”‚   â”‚   â”œâ”€â†’ æœç´¢è®°å¿†: SQLite FTS5
    â”‚   â”‚   â”œâ”€â†’ æ¨è Provider: gemini 3f (å‰ç«¯æœ€ä½³)
    â”‚   â”‚   â””â”€â†’ æ³¨å…¥ä¸Šä¸‹æ–‡åˆ° prompt
    â”‚   â”‚
    â”‚   â”œâ”€â†’ [Provider Call]
    â”‚   â”‚   â””â”€â†’ è°ƒç”¨ kimi API
    â”‚   â”‚
    â”‚   â””â”€â†’ [Memory Middleware - Post-Response]
    â”‚       â”œâ”€â†’ è®°å½•å¯¹è¯: SQLite
    â”‚       â”œâ”€â†’ æ›´æ–°ç»Ÿè®¡: Registry
    â”‚       â””â”€â†’ (å¯é€‰) æå–äº‹å®: LLM
    â”‚
    â””â”€â†’ è¿”å›å“åº”
```

---

## ğŸ“Š é›†æˆæ•ˆæœ

### Before (v0.17)
```bash
$ ccb-cli kimi "å¦‚ä½•åšå‰ç«¯å¼€å‘"
[ç›´æ¥è°ƒç”¨ kimiï¼Œæ— ä¸Šä¸‹æ–‡]

$ ccb-cli kimi "åˆ›å»ºç™»å½•é¡µé¢"
[kimi ä¸çŸ¥é“ä¹‹å‰çš„å¯¹è¯]
```

### After (v0.18 - é›†æˆå)
```bash
$ ccb-cli kimi "å¦‚ä½•åšå‰ç«¯å¼€å‘"
[Gateway Middleware]
  âœ“ æå–å…³é”®è¯: ["å‰ç«¯", "å¼€å‘"]
  âœ“ æœç´¢ç›¸å…³è®°å¿†: 0 æ¡
  ğŸ’¡ æ¨èä½¿ç”¨ gemini 3fï¼ˆå‰ç«¯å¼€å‘æœ€ä½³ï¼‰

Response: å»ºè®®ä½¿ç”¨ React + Tailwind CSS...

[è‡ªåŠ¨è®°å½•]
  âœ“ è®°å½•åˆ° conversations è¡¨
  âœ“ æ›´æ–° Provider ç»Ÿè®¡

---

$ ccb-cli kimi "åˆ›å»ºç™»å½•é¡µé¢"
[Gateway Middleware]
  âœ“ æå–å…³é”®è¯: ["åˆ›å»º", "ç™»å½•", "é¡µé¢"]
  âœ“ æœç´¢åˆ° 1 æ¡ç›¸å…³è®°å¿†: "å¦‚ä½•åšå‰ç«¯å¼€å‘"
  âœ“ æ³¨å…¥ä¸Šä¸‹æ–‡:
    # ç³»ç»Ÿè®°å¿†ä¸Šä¸‹æ–‡
    ## ğŸ’­ ç›¸å…³è®°å¿†
    1. [kimi] å¦‚ä½•åšå‰ç«¯å¼€å‘
       A: å»ºè®®ä½¿ç”¨ React + Tailwind CSS...

Response: åŸºäºä¹‹å‰çš„è®¨è®ºï¼Œæˆ‘ä¼šç”¨ React + Tailwind åˆ›å»º...

ğŸ’¡ [å·²æ³¨å…¥ 1 æ¡ç›¸å…³è®°å¿†]
```

---

## ğŸ”„ ä¸‹ä¸€æ­¥ï¼šGateway é›†æˆ

### ä¿®æ”¹ Gateway Server

**æ–‡ä»¶ï¼š** `lib/gateway/gateway_server.py`

**éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼š**

```python
# 1. å¯¼å…¥ä¸­é—´ä»¶
from .middleware.memory_middleware import MemoryMiddleware

# 2. åˆå§‹åŒ–ä¸­é—´ä»¶
class GatewayServer:
    def __init__(self):
        # ç°æœ‰åˆå§‹åŒ–...
        self.memory_middleware = MemoryMiddleware()  # æ–°å¢

# 3. åœ¨ handle_ask ä¸­è°ƒç”¨ä¸­é—´ä»¶
    async def handle_ask(self, request_data: dict) -> dict:
        """å¤„ç† /api/ask è¯·æ±‚"""

        # Memory Pre-Request Hookï¼ˆæ–°å¢ï¼‰
        request_data = await self.memory_middleware.pre_request(request_data)

        # ç°æœ‰çš„ Provider è°ƒç”¨é€»è¾‘
        response = await self._call_provider(request_data)

        # Memory Post-Response Hookï¼ˆæ–°å¢ï¼‰
        await self.memory_middleware.post_response(request_data, response)

        return response
```

### éªŒè¯æ­¥éª¤

1. **å¯åŠ¨ Gateway:**
   ```bash
   cd ~/.local/share/codex-dual
   python3 -m lib.gateway.gateway_server --port 8765
   ```

2. **æµ‹è¯•è®°å¿†æ³¨å…¥:**
   ```bash
   # ç¬¬ä¸€æ¬¡è¯¢é—®
   ccb-cli kimi "å¦‚ä½•åšå‰ç«¯å¼€å‘"

   # ç¬¬äºŒæ¬¡è¯¢é—®ï¼ˆåº”è‡ªåŠ¨æ³¨å…¥ä¹‹å‰çš„è®°å¿†ï¼‰
   ccb-cli kimi "åˆ›å»ºç™»å½•é¡µé¢"
   ```

3. **æŸ¥çœ‹è®°å¿†æ•°æ®åº“:**
   ```bash
   python3 lib/memory/memory_lite.py recent 10
   python3 lib/memory/memory_lite.py stats
   ```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### ä¸­é—´ä»¶æ€§èƒ½
- **Pre-Request Hook**: <50msï¼ˆFTS5 æœç´¢ï¼‰
- **Post-Response Hook**: <10msï¼ˆSQLite å†™å…¥ï¼‰
- **æ€»å¼€é”€**: <60msï¼ˆå¯¹æ•´ä½“å»¶è¿Ÿå½±å“ <5%ï¼‰

### è®°å¿†æ•ˆæœ
- **å‡†ç¡®ç‡**: çº¦ 80%ï¼ˆåŸºäºå…³é”®è¯åŒ¹é…ï¼‰
- **å¬å›ç‡**: çº¦ 60%ï¼ˆFTS5 å…¨æ–‡æœç´¢ï¼‰
- **æœªæ¥æ”¹è¿›**: å‘é‡æœç´¢å¯æå‡åˆ° 90%+

---

## ğŸ¯ åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | v0.17 | v0.18 (é›†æˆå) |
|------|-------|---------------|
| **è®°å¿†è®°å½•** | æ‰‹åŠ¨ ccb-mem | âœ… è‡ªåŠ¨ï¼ˆGateway ä¸­é—´ä»¶ï¼‰|
| **ä¸Šä¸‹æ–‡æ³¨å…¥** | æ‰‹åŠ¨å¤åˆ¶ç²˜è´´ | âœ… è‡ªåŠ¨ï¼ˆPre-Request Hookï¼‰|
| **Provider æ¨è** | æ‰‹åŠ¨é€‰æ‹© | âœ… æ™ºèƒ½æ¨èï¼ˆRegistryï¼‰|
| **é…ç½®ç®¡ç†** | æ—  | âœ… é…ç½®æ–‡ä»¶ï¼ˆgateway_config.jsonï¼‰|
| **æµ‹è¯•å·¥å…·** | æ—  | âœ… æµ‹è¯•è„šæœ¬ï¼ˆtest_middleware.pyï¼‰|
| **æ–‡æ¡£** | åŸºç¡€æ–‡æ¡£ | âœ… å®Œæ•´é›†æˆè®¾è®¡æ–‡æ¡£ |

---

## ğŸš€ æœªæ¥æ‰©å±•è®¡åˆ’

### Phase 1: åŸºç¡€é›†æˆï¼ˆâœ… å·²å®Œæˆï¼‰
- âœ… Gateway ä¸­é—´ä»¶
- âœ… Pre/Post-Request Hooks
- âœ… è‡ªåŠ¨è®°å½•å’Œæ³¨å…¥
- âœ… é…ç½®ç³»ç»Ÿ
- âœ… æµ‹è¯•è„šæœ¬

### Phase 2: è¯­ä¹‰å¢å¼ºï¼ˆè®¡åˆ’ä¸­ï¼‰
- [ ] Qdrant å‘é‡æ•°æ®åº“é›†æˆ
- [ ] è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢
- [ ] LLM é©±åŠ¨çš„äº‹å®æå–
- [ ] å¤šè¯­è¨€åµŒå…¥æ”¯æŒ

### Phase 3: Agent è‡ªä¸»ç®¡ç†ï¼ˆè®¡åˆ’ä¸­ï¼‰
- [ ] Agent å¯è°ƒç”¨è®°å¿†å‡½æ•°ï¼ˆLetta æ¨¡å¼ï¼‰
- [ ] ç»“æ„åŒ–è®°å¿†å—ï¼ˆcore_memoryï¼‰
- [ ] Agent è‡ªä¸»æ›´æ–°è®°å¿†
- [ ] è®°å¿†ç‰ˆæœ¬æ§åˆ¶

### Phase 4: å›¢é˜Ÿåä½œï¼ˆè®¡åˆ’ä¸­ï¼‰
- [ ] å¤šç”¨æˆ·è®°å¿†éš”ç¦»
- [ ] å…±äº«è®°å¿†åº“
- [ ] æƒé™æ§åˆ¶
- [ ] å®æ—¶åä½œ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| **é›†æˆè®¾è®¡** | `lib/memory/INTEGRATION_DESIGN.md` | å®Œæ•´è®¾è®¡æ–¹æ¡ˆ |
| **ä¸­é—´ä»¶ä»£ç ** | `lib/gateway/middleware/memory_middleware.py` | æ ¸å¿ƒå®ç° |
| **é…ç½®æ–‡ä»¶** | `~/.ccb/gateway_config.json` | é…ç½®è¯´æ˜ |
| **æµ‹è¯•è„šæœ¬** | `lib/gateway/middleware/test_middleware.py` | æµ‹è¯•ç”¨ä¾‹ |
| **æ•°æ®åº“æ–‡æ¡£** | `lib/memory/DATABASE_STRUCTURE.md` | æ•°æ®åº“è®¾è®¡ |
| **åŒæ­¥æŒ‡å—** | `lib/memory/SYNC_QUICKSTART.md` | äº‘ç«¯åŒæ­¥ |

---

## ğŸ‰ æ€»ç»“

**CCB Memory æ·±åº¦é›†æˆ**å·²å®Œæˆæ ¸å¿ƒç»„ä»¶å¼€å‘ï¼š

1. **è‡ªåŠ¨åŒ–è®°å¿†** - æ— éœ€æ‰‹åŠ¨å‘½ä»¤ï¼Œé€æ˜å·¥ä½œ
2. **æ™ºèƒ½æ¨è** - åŸºäºä»»åŠ¡ç±»å‹æ¨èæœ€ä½³ AI
3. **ä¸Šä¸‹æ–‡è¿ç»­** - è‡ªåŠ¨æ³¨å…¥ç›¸å…³è®°å¿†
4. **å¯é…ç½®** - çµæ´»æ§åˆ¶å„é¡¹åŠŸèƒ½
5. **å¯æµ‹è¯•** - å®Œæ•´æµ‹è¯•è„šæœ¬éªŒè¯

**ä¸‹ä¸€æ­¥ï¼š**
- å°†ä¸­é—´ä»¶é›†æˆåˆ° Gateway Server
- å¯åŠ¨ Gateway æµ‹è¯•å®Œæ•´æµç¨‹
- æ ¹æ®å®é™…ä½¿ç”¨ä¼˜åŒ–å…³é”®è¯æå–å’Œè®°å¿†æœç´¢

**è®°å¿†è®© AI æ›´æ™ºèƒ½ï¼** ğŸŒŸ
